# Story 1.5: Collaborator Invitation System

## Status

DONE

## Story

**As a** cabinet admin,  
**I want** to invite collaborators via a dedicated URL,  
**so that** my team can access our shared data.

## Acceptance Criteria

1. "Invite Collaborator" button on settings/team page
2. Invitation creates unique token URL (e.g., `/invite/[token]`)
3. Invitation email field required, stored in Invitation table
4. Invitation expires after 7 days
5. Invitation URL displays registration form (pre-filled email)
6. Invited user creates account and is auto-assigned to the inviting Company
7. Invitation marked as used after successful registration
8. Expired/used invitations show appropriate error message
9. Admin can see list of pending invitations
10. Admin can revoke pending invitations

*Note: Email sending not included — URL generation only (admin shares manually).*

## Tasks / Subtasks

- [x] Task 1 (AC: 1, 2, 3, 9): Settings/team page and invitation creation
  - [x] Add page `src/app/(dashboard)/settings/team/page.tsx` (or settings page with team section) with "Inviter un collaborateur" button. [Source: docs/frontend-architecture.md §2, PRD Story 1.5]
  - [x] Form or modal: email (required). On submit call tRPC `invitation.create` with email. [Source: docs/architecture.md §9]
  - [x] After create: display the invitation URL (e.g. `${origin}/invite/${token}`) so admin can copy and share. [Source: PRD AC 2]
  - [x] Display list of pending invitations (call `invitation.list`); show email, expiry, revoke action. [Source: PRD AC 9]
- [x] Task 2 (AC: 3, 4): Invitation router and model
  - [x] Create `src/server/trpc/routers/invitation.ts`: create, list, revoke, getByToken, accept. [Source: docs/architecture.md §9]
  - [x] create: protectedProcedure, input email (Zod), generate unique token (crypto.randomUUID()), expiresAt = now + 7 days, insert Invitation with companyId from ctx. [Source: docs/architecture.md §7.3, prisma/schema.prisma]
  - [x] list: protectedProcedure, return invitations for ctx.companyId where usedAt is null and expiresAt > now. [Source: PRD AC 9]
  - [x] revoke: protectedProcedure, input invitation id, verify invitation belongs to company, set revokedAt = now. [Source: PRD AC 10]
  - [x] getByToken: publicProcedure, input token, return invitation (email, expiresAt, usedAt, revokedAt) if found. [Source: docs/architecture.md §9]
  - [x] Register router in _app.ts. [Source: docs/architecture/coding-standards.md §3.1]
- [x] Task 3 (AC: 5, 6, 7, 8): Invite page and acceptance flow
  - [x] Add route `src/app/(auth)/invite/[token]/page.tsx`. Load invitation via `invitation.getByToken(token)`. [Source: docs/architecture.md §6]
  - [x] If not found, expired (expiresAt < now), or used (usedAt != null): show error per PRD. [Source: docs/prd.md Standard Error Messages]
  - [x] Else: display registration form with email pre-filled (read-only), fields firstName, lastName, password. [Source: docs/architecture.md §7.3]
  - [x] On submit: invitation.accept creates Supabase user, User with companyId from invitation, sets invitation.usedAt in transaction. [Source: docs/architecture.md §7.3]
  - [x] After success: user logged in, redirect to dashboard. [Source: PRD AC 6, 7]
- [x] Task 4 (AC: 10): Revoke pending invitations
  - [x] In list UI, add "Révoquer" per invitation. Call `invitation.revoke(id)`. Refresh list after revoke. [Source: PRD AC 10]
- [x] Task 5: Validations and error messages
  - [x] invitation.create: validate email format (Zod); check email not already User in same company. [Source: docs/architecture/coding-standards.md §3]
  - [x] Use PRD messages for expired/used invitation. [Source: docs/prd.md Standard Error Messages]
- [x] Task 6 – Testing (AC: 2–8): Unit and integration tests
  - [x] Unit: Zod schema for invitation create (email). [Source: docs/architecture.md §14]
  - [x] Integration: create, getByToken, list, revoke covered. Accept flow requires Supabase (manual/E2E). [Source: docs/architecture/coding-standards.md §6]
- [x] Task 7 (review): Lancer une review de code en fin de développement avant clôture de la story.
- [x] Task 8 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/1.5-test-cases.md`) pour faciliter la review de la story.

## Dev Notes

### Previous Story Insights

- Story 1.3: auth.register creates Company + User via Supabase Admin; Story 1.4: login, middleware, dashboard layout with logout. Settings route exists in frontend-architecture (§2). [Source: docs/stories/1.3, 1.4]
- tRPC context: protectedProcedure has ctx.companyId; publicProcedure for getByToken (no auth). [Source: docs/architecture.md §7.2]

### Data Models

- **Invitation:** id, email, token (unique), companyId, expiresAt, usedAt (nullable), revokedAt (nullable). usedAt = acceptée ; revokedAt = révoquée. [Source: docs/architecture.md §5, prisma/schema.prisma]
- No new models; Invitation already has RLS (Story 1.2). [Source: docs/architecture/rls-policies.sql]

### API Specifications

- **invitation.create:** protectedProcedure, input { email }, output { token, url?, expiresAt }. [Source: docs/architecture.md §9]
- **invitation.list:** protectedProcedure, output list of { id, email, token, expiresAt, createdAt }. [Source: docs/architecture.md §9]
- **invitation.revoke:** protectedProcedure, input { id }. [Source: docs/architecture.md §9]
- **invitation.getByToken:** publicProcedure, input { token }, output { email, expiresAt, usedAt } or null. [Source: docs/architecture.md §9]
- Accept flow: new procedure (e.g. auth.registerWithInvitation or invitation.accept) with token + firstName, lastName, password, email (from invitation); creates Supabase user then User + updates Invitation.usedAt. [Source: docs/architecture.md §7.3]

### Component Specifications

- Settings/team page: use existing layout (dashboard); form or modal for invite; table or list for pending invitations with revoke. [Source: docs/architecture/coding-standards.md §4]
- Invite page: same form pattern as register (React Hook Form, Zod, shadcn); email pre-filled. [Source: Story 1.3]

### File Locations

| Purpose | Path |
|--------|------|
| Settings/team page | src/app/(dashboard)/settings/team/page.tsx |
| Invite page | src/app/(auth)/invite/[token]/page.tsx |
| Invitation router | src/server/trpc/routers/invitation.ts |
| Invitation validations | src/lib/validations/invitation.ts (or reuse auth) |

[Source: docs/architecture.md §6, docs/architecture/source-tree.md]

### Technical Constraints

- **Token:** Unique, unguessable (e.g. crypto.randomUUID()). [Source: docs/architecture.md §7.3]
- **Expiry:** 7 days from creation. [Source: PRD AC 4]
- **Scope:** All procedures (except getByToken) use ctx.companyId. [Source: docs/architecture/coding-standards.md §3]
- **Messages:** « Cette invitation a expiré. Demandez une nouvelle invitation à votre administrateur. » ; « Cette invitation a déjà été utilisée. » [Source: docs/prd.md Standard Error Messages]

### Testing

- Unit: invitation create schema (email). [Source: docs/architecture.md §14]
- Integration: create, list, revoke, getByToken, full accept flow (User created, invitation used). [Source: docs/architecture/coding-standards.md §6]
- Test file location: tests/unit/, tests/integration/ per source-tree. [Source: docs/architecture/source-tree.md]

### Project Structure Notes

- Route `/invite/[token]` in group (auth); `/settings/team` under (dashboard). No conflicts with docs/frontend-architecture.md.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-14 | 0.1 | Story draft created (1.5 Collaborator Invitation System) | Bob (SM) |
| 2026-02-15 | 0.2 | Implementation complete (invitation router, settings/team, invite page, tests) | James (Dev) |
| 2026-02-15 | 0.3 | Post-impl: revokedAt (distinct from usedAt), listAll, statuts, tri, copier lien ; review code effectuée | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor)

### Debug Log References

None.

### Completion Notes List

- Invitation model has no `createdAt`; list displays `expiresAt` for expiry column.
- Revoke sets `revokedAt` (distinct from `usedAt`); `usedAt` = accepté, `revokedAt` = révoqué. Migration `20260215000000_add_invitation_revoked_at`.
- Invite page form extracted to `InviteAcceptForm` to avoid setState-in-effect lint; email pre-filled via `defaultValues` when component mounts with valid invitation.
- Integration tests run only when DATABASE_URL is set; accept flow integration test not added (requires Supabase Admin, covered by manual/E2E per test cases doc).
- Améliorations post-impl : listAll (toutes invitations + statuts), badges statut (Active, Utilisée, Expirée, Révoquée), tri par statut, bouton "Copier le lien" par ligne.
- Seed : token invitation en UUID valide (`00000000-0000-0000-0000-000000000002`) pour compatibilité getByToken (attend UUID).

### File List

**Created:**
- `src/lib/validations/invitation.ts`
- `src/server/trpc/routers/invitation.ts`
- `src/app/(dashboard)/settings/team/page.tsx`
- `src/app/(auth)/invite/[token]/page.tsx`
- `tests/unit/validations/invitation.test.ts`
- `tests/integration/invitation/invitation.test.ts`
- `docs/stories/cases/1.5-test-cases.md`
- `prisma/migrations/20260215000000_add_invitation_revoked_at/migration.sql`

**Modified:**
- `src/server/trpc/routers/_app.ts` (added invitation router)
- `src/app/(dashboard)/dashboard/page.tsx` (link to /settings/team)
- `prisma/schema.prisma` (Invitation.revokedAt)
- `prisma/seed.ts` (token UUID valide)

---

## QA Results

### Code Review (2026-02-15)

**Verdict :** OK — prêt pour clôture.

| Critère | Statut |
|---------|--------|
| Tous les AC implémentés | OK |
| Coding standards (flèches, Zod, protectedProcedure) | OK |
| Multi-tenant (ctx.companyId sur toutes procédures protégées) | OK |
| Messages d’erreur génériques (PRD) | OK |
| Lint / TypeScript | OK |
| Tests unitaires + intégration | OK |
| Cas de test documentés | OK |

**Points vérifiés :**
- `list` filtre par usedAt null, revokedAt null, expiresAt > now.
- `revoke` met à jour revokedAt (distinct de usedAt pour accept).
- Page invite gère invalid, expired, used, revoked avec messages PRD.
- Transaction accept : User + Invitation.usedAt en une seule transaction.
- Seed token UUID compatible avec getByToken (z.string().uuid()).
