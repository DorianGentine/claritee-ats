# Story 2.9: Candidate CV File Upload

## Status

DONE

## Story

**As a** recruiter,  
**I want** to upload a candidate's CV file,  
**so that** I can keep their original document on file.

## Acceptance Criteria

1. CV upload section on candidate detail page
2. Accepts PDF, DOC, DOCX formats
3. File size limit: 5 MB max
4. File uploaded to Supabase Storage (company/candidates/[id]/)
5. File URL stored in candidate record
6. Download link displayed after upload
7. File name displayed (original filename preserved)
8. Option to replace existing CV
9. Option to delete CV
10. Preview not required for MVP (just download link)
11. Rate limiting sur les uploads : max 30 uploads (photo + CV combinÃ©s) par utilisateur par heure ; en cas de dÃ©passement, message Â« Trop de requÃªtes. RÃ©essayez dans quelques minutes. Â» (rÃ©f. `rate-limiting.md` Â§3.3)

**RÃ©f.** Architecture Â§8 bucket `cvs`, path `{companyId}/candidates/{candidateId}/`, max 5 Mo ; rate-limiting.md Â§3.3 (upload par userId) ; wireframes Â§3 Â« CV: doc.pdf ðŸ“¥ Â».

## Tasks / Subtasks

- [x] Task 1 (AC: 4, 5, 7): API â€“ SchÃ©ma et stockage du nom de fichier
  - [x] VÃ©rifier le modÃ¨le Candidate : `cvUrl` (String?) existe. Ajouter `cvFileName` (String?) si absent pour prÃ©server le nom original (AC 7). Migration Prisma si besoin. [Source: prisma/schema.prisma]
  - [x] CrÃ©er schÃ©ma Zod pour upload CV : candidateId (uuid), fileBase64, mimeType (enum PDF, DOC, DOCX), fileName (string, nom original pour affichage). [Source: docs/architecture/coding-standards.md Â§3]
- [x] Task 2 (AC: 2, 3, 4, 5, 11): API â€“ Procedure uploadCv
  - [x] `candidate.uploadCv` : protectedProcedure ; rate limit `upload:${userId}` (mÃªme clÃ© que uploadPhoto, 30/heure combinÃ©s). [Source: rate-limiting.md Â§3.3, src/lib/rate-limit.ts]
  - [x] VÃ©rifier candidat du cabinet ; valider format (PDF, DOC, DOCX) et taille â‰¤ 5 Mo. [Source: docs/architecture.md Â§8, PRD AC 2, AC 3]
  - [x] Upload vers bucket `cvs`, path `{companyId}/candidates/{candidateId}/cv.{ext}` (ext selon mime). [Source: docs/architecture.md Â§8.2]
  - [x] Mettre Ã  jour Candidate : cvUrl (publicUrl Supabase), cvFileName (nom original). Remplacer lâ€™existant si un CV est dÃ©jÃ  prÃ©sent (upsert Storage). [Source: PRD AC 5, AC 8]
- [x] Task 3 (AC: 9): API â€“ Procedure deleteCv
  - [x] `candidate.deleteCv` : protectedProcedure, input `{ candidateId }` ; vÃ©rifier candidat du cabinet ; supprimer le fichier du bucket (si prÃ©sent) ; mettre cvUrl et cvFileName Ã  null. [Source: PRD AC 9]
- [x] Task 4 (AC: 1, 6, 7, 8, 10): UI â€“ Section CV sur la fiche candidat
  - [x] Section Â« CV Â» sur la page dÃ©tail (sidebar gauche ou colonne adaptÃ©e selon wireframes Â§3). [Source: wireframes Â§3]
  - [x] Si cvUrl prÃ©sent : afficher nom de fichier (cvFileName ou Â« CV Â») + lien de tÃ©lÃ©chargement. [Source: PRD AC 6, AC 7]
  - [x] Option Â« Remplacer Â» : ouvrir le mÃªme flux dâ€™upload que lâ€™ajout (mÃªme procedure uploadCv). [Source: PRD AC 8]
  - [x] Option Â« Supprimer Â» : confirmation (ConfirmDialog) puis `candidate.deleteCv`. [Source: PRD AC 9]
  - [x] Si pas de CV : input file ou bouton Â« Ajouter un CV Â» ; accepter PDF, DOC, DOCX ; envoyer base64 (ou stratÃ©gie Ã©quivalente Ã  uploadPhoto) vers uploadCv. [Source: docs/stories/2.3 â€“ pattern upload photo]
- [x] Task 5 â€“ Validation et erreurs
  - [x] Messages PRD : Â« Le fichier dÃ©passe la taille maximale autorisÃ©e (2 Mo pour les photos, 5 Mo pour les CVs). Â» ; Â« Format de fichier non supportÃ©. Formats acceptÃ©s : PDF, DOC, DOCX. Â» ; Â« Trop de requÃªtes. RÃ©essayez dans quelques minutes. Â» [Source: PRD Standard Error Messages, rate-limiting.md]
- [x] Task 6 â€“ Testing (AC: 1â€“11)
  - [x] IntÃ©gration : uploadCv (succÃ¨s, formats, taille, rate limit, remplacement), deleteCv ; isolation multi-tenant. [Source: docs/architecture.md Â§14]
  - [x] Manuel : upload, tÃ©lÃ©chargement, remplacement, suppression, limite 5 Mo, limite 30 uploads/h. [Source: docs/architecture/coding-standards.md Â§6]
- [x] Task 7 (QA): RÃ©diger les cas de test dans un fichier dÃ©diÃ© (ex. `docs/stories/cases/2.9-test-cases.md`) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de dÃ©veloppement avant clÃ´ture de la story.

## Dev Notes

### Approche de stockage des CVs (dÃ©cision d'architecture)

- **Bucket privÃ©** : les CVs sont stockÃ©s dans un bucket Supabase privÃ© (`cvs`), contrairement aux photos (bucket public `photos`).
- **Raison** : les CVs contiennent des donnÃ©es personnelles sensibles ; un bucket public exposerait les fichiers Ã  tout accÃ¨s via URL directe (guessing dâ€™ID, fuites de liens).
- **URLs signÃ©es** : lâ€™accÃ¨s se fait via des URLs signÃ©es gÃ©nÃ©rÃ©es cÃ´tÃ© serveur (durÃ©e 15 min), uniquement aprÃ¨s authentification (`getCvDownloadUrl`) ou validation dâ€™un token de partage (`getCvDownloadUrlByShareToken`).
- **ImplÃ©mentation** : `cvUrl` en base est une URL de rÃ©fÃ©rence (getPublicUrl) ; elle ne permet pas lâ€™accÃ¨s direct. Le composant `CvDownloadLink` appelle `getCvDownloadUrl` ou `getCvDownloadUrlByShareToken` pour obtenir une URL signÃ©e Ã  la volÃ©e.
- **Cache client** : les URLs signÃ©es sont mises en cache cÃ´tÃ© client pendant 14 min pour Ã©viter des appels API rÃ©pÃ©tÃ©s lors dâ€™un mÃªme tÃ©lÃ©chargement.

Voir `docs/architecture.md` Â§8 (Stockage Supabase).

### Previous Story Insights

- Story 2.3 : uploadPhoto avec base64, rate limit `upload:${userId}`, bucket `photos`, path `{companyId}/candidates/{candidateId}/photo.{ext}`. Pattern Ã  rÃ©pliquer pour le CV. [Source: docs/stories/2.3, candidate.uploadPhoto]
- Le rate limit est partagÃ© : photo + CV utilisent la mÃªme clÃ© ; 30 uploads/heure au total. [Source: rate-limiting.md Â§3.3]

### Data Models

- **Candidate** : cvUrl (String?), cvFileName (String? â€” Ã  ajouter si absent pour AC 7). [Source: prisma/schema.prisma]

### API Specifications

- **candidate.uploadCv** : protectedProcedure, input `{ candidateId, fileBase64, mimeType, fileName }` ; rate limit ; vÃ©rifier candidat ; upload bucket `cvs` ; update cvUrl, cvFileName. [Source: docs/architecture.md Â§8, Â§9]
- **candidate.deleteCv** : protectedProcedure, input `{ candidateId }` ; supprimer du Storage si prÃ©sent ; set cvUrl/cvFileName Ã  null. [Source: docs/architecture.md Â§9]
- **candidate.getCvDownloadUrl** : protectedProcedure, input `{ candidateId }` ; retourne URL signÃ©e 15 min pour tÃ©lÃ©chargement. [Source: bucket privÃ©]
- **candidate.getCvDownloadUrlByShareToken** : publicProcedure, input `{ token }` ; valide token et expiration ; rate limit 30/min par IP ; retourne URL signÃ©e 15 min. [Source: bucket privÃ©, page partagÃ©e]

### Storage

- Bucket : `cvs`. [Source: docs/architecture.md Â§8.1]
- Path : `{companyId}/candidates/{candidateId}/cv.{ext}` (pdf, doc, docx). [Source: docs/architecture.md Â§8.2]
- Max 5 Mo. [Source: docs/architecture.md Â§8.1]

### File Locations

| Purpose                         | Path                                                          |
| ------------------------------- | ------------------------------------------------------------- |
| Section CV (sidebar ou content) | src/components/candidates/ (CandidateCvSection ou Ã©quivalent) |
| Router candidate                | src/server/trpc/routers/candidate.ts                          |
| Validations                     | src/lib/validations/candidate.ts                              |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- MÃªme rate limit que uploadPhoto (clÃ© `upload:${userId}`). [Source: rate-limiting.md Â§3.3]
- Validation magic bytes pour PDF possible (optionnel, risque de faux positifs sur DOC/DOCX) ; au minimum validation mimeType cÃ´tÃ© client et extension. [Source: docs/stories/2.3 â€“ signatures pour images]

### Testing

- IntÃ©gration : uploadCv, deleteCv, rate limit, NOT_FOUND pour autre cabinet. [Source: docs/architecture.md Â§14]

### Project Structure Notes

- RÃ©utiliser le pattern base64 de uploadPhoto si cohÃ©rent avec lâ€™implÃ©mentation actuelle. [Source: 2.3]

---

## Change Log

| Date       | Version | Description                                                                                                                                                        | Author      |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------- |
| 2026-02-18 | 0.1     | Story draft created (2.9 Candidate CV File Upload)                                                                                                                 | Bob (SM)    |
| 2026-02-21 | 0.2     | Implementation: uploadCv, deleteCv, CandidateCvSection, tests                                                                                                      | James (Dev) |
| 2026-02-21 | 0.3     | Bucket privÃ© + URLs signÃ©es (15 min) ; CvDownloadLink ; rate limit share ; window.open anti-bloquage ; useRef cache ; helper createCvSignedUrl ; test token expirÃ© | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Claude Opus 4.5)

### Debug Log References

â€“

### Completion Notes List

- Migration `20260221000000_add_cv_file_name` ajoute `cvFileName` au modÃ¨le Candidate. ExÃ©cuter `prisma migrate deploy` en environnement ciblÃ©.
- Bucket Supabase `cvs` requis (privÃ©) ; crÃ©er et configurer les policies. Voir `docs/supabase-cvs-bucket-config-prompt.md`.
- TÃ©lÃ©chargement CV : URLs signÃ©es (15 min) via `getCvDownloadUrl` et `getCvDownloadUrlByShareToken` ; bucket privÃ© obligatoire.
- Tests d'intÃ©gration CV skippÃ©s si DATABASE_URL non dÃ©fini (runIf).

### Post-implÃ©mentation (bucket privÃ© + URLs signÃ©es)

- **CvDownloadLink** : ouvre une fenÃªtre vide immÃ©diatement au clic (Ã©vite blocage popup), puis redirige vers lâ€™URL signÃ©e ; gÃ¨re le cas popup bloquÃ©e avec message utilisateur.
- **useCvDownloadUrl** : cache client 14 min via `useRef` pour la stabilitÃ© des dÃ©pendances.
- **createCvSignedUrl** : helper partagÃ© pour la gÃ©nÃ©ration dâ€™URL signÃ©e (DRY).
- **getCvDownloadUrlByShareToken** : rate limit 30 req/min par IP ; test token expirÃ© ajoutÃ©.

### File List

| Fichier                                                         | Action                                                                                           |
| --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| prisma/schema.prisma                                            | Modified (cvFileName)                                                                            |
| prisma/migrations/20260221000000_add_cv_file_name/migration.sql | Created                                                                                          |
| src/lib/validations/candidate.ts                                | Modified (uploadCvSchema, CV_ACCEPTED_MIMES, CV_MAX_BYTES)                                       |
| src/lib/rate-limit.ts                                           | Modified (CV_DOWNLOAD_SHARE_PER_IP)                                                              |
| src/lib/file-utils.ts                                           | Created                                                                                          |
| src/server/trpc/routers/candidate.ts                            | Modified (uploadCv, deleteCv, getCvDownloadUrl, getCvDownloadUrlByShareToken, createCvSignedUrl) |
| src/hooks/useCvDownloadUrl.ts                                   | Created                                                                                          |
| src/components/shared/CvDownloadLink.tsx                        | Created                                                                                          |
| src/components/candidates/CandidateCvSection.tsx                | Modified (CvDownloadLink)                                                                        |
| src/components/candidates/CandidateDetailSidebar.tsx            | Modified (CandidateCvSection, cvUrl, cvFileName)                                                 |
| src/components/candidates/CandidateDetailView.tsx               | Modified (pass cvUrl, cvFileName)                                                                |
| tests/integration/candidate/candidate.test.ts                   | Modified (uploadCv, deleteCv, getCvDownloadUrl, getCvDownloadUrlByShareToken, token expirÃ©)      |
| tests/unit/validations/candidate.test.ts                        | Modified (uploadCvSchema tests)                                                                  |
| docs/stories/cases/2.9-test-cases.md                            | Created                                                                                          |
| docs/supabase-cvs-bucket-config-prompt.md                       | Created                                                                                          |

---

## QA Results

_(Results from QA Agent review of the completed story implementation.)_
