# Story 3.11: Quick Note Widget (type chat)

## Status

DONE

## Story

**As a** recruiter,  
**I want** to quickly create and edit notes from anywhere in the app via a floating widget,  
**so that** I can capture information without blocking navigation.

## Acceptance Criteria

1. Bouton flottant visible sur toutes les pages authentifiées
2. Bouton positionné en bas à droite, style terracotta (Design System)
3. Clic ouvre un panneau type chat widget (non bloquant, permet de naviguer)
4. Le widget reste ouvert et conserve son état lors de la navigation
5. Zone de saisie : éditeur BlockNote (blocs texte, listes, titres — cohérent Story 3.9)
6. Menu/liste déroulante pour accéder aux notes existantes, triées par dernière modification
7. La liste s'affiche au-dessus de la zone de saisie ; clic sur une note l'ouvre dans le widget
8. Notes libres (non associées candidat/offre) ; champ titre optionnel (si vide : 30 premiers caractères du contenu)
9. Auto-save : debounce 2 secondes après la dernière modification
10. Raccourci clavier : Cmd/Ctrl + J ouvre le widget
11. Lien vers la page "Mes notes" accessible depuis le widget (route préparée pour Story 3.12)

**Réf.** Design chat widget : panneau flottant non bloquant ; Design System § FAB pour le bouton.

## Tasks / Subtasks

- [x] Task 1: API – Notes libres et champ titre
  - [x] Migration Prisma : ajouter `title String?` au modèle Note. [Source: prisma/schema.prisma]
  - [x] Étendre `createNoteSchema` et `updateNoteSchema` : `title?: string` (optionnel, trim), `content` obligatoire. Pour les notes libres : `candidateId` et `offerId` optionnels ; aucun requis. [Source: src/lib/validations/note.ts]
  - [x] Étendre `note.create` : accepter notes sans candidateId ni offerId (notes libres). [Source: docs/architecture.md §4]
  - [x] Créer `note.listFree` (ou étendre `note.list`) : retourne les notes du cabinet sans candidateId ni offerId, triées par `updatedAt desc`. Inclure title (ou dérivé : title ?? 30 premiers caractères du contenu en texte brut). [Source: prisma/schema.prisma]
- [x] Task 2: API – Update pour auto-save
  - [x] `note.update` accepte déjà content ; s'assurer que `updatedAt` est mis à jour. Pas de changement majeur. [Source: src/server/trpc/routers/note.ts]
- [x] Task 3: Composant NoteChatWidget
  - [x] Créer `src/components/layout/NoteChatWidget.tsx` : panneau flottant type chat (position fixe bas-droite, ne bloque pas la navigation, overlay sur le contenu). [Source: design chat widget]
  - [x] État ouvert/fermé ; bouton flottant (56x56px, terracotta) pour ouvrir. [Source: docs/design-system.md § FAB]
  - [x] Panneau : header (titre "Notes", bouton fermer X), zone liste (déroulante/menu), zone saisie BlockNote en bas. [Source: design chat widget]
- [x] Task 4: Liste déroulante des notes
  - [x] Menu/dropdown (ex. bouton "Mes notes" ou icône liste) : au clic, affiche la liste des notes libres (note.listFree) triées par updatedAt desc, au-dessus de la zone de saisie. [Source: AC 6, 7]
  - [x] Clic sur une note : charge son contenu dans l'éditeur BlockNote, mode édition. [Source: AC 7]
  - [x] Option "Nouvelle note" pour vider l'éditeur et créer. [Source: flux création]
- [x] Task 5: Zone saisie BlockNote et auto-save
  - [x] Réutiliser `NoteBlockNoteEditor`. [Source: src/components/shared/NoteBlockNoteEditor.tsx]
  - [x] Nouvelle note : créer via note.create à la première saisie significative (ou au blur). Édition : note.update. [Source: AC 8]
  - [x] Auto-save : debounce 2 secondes après la dernière modification (onContentChange). [Source: AC 9]
- [x] Task 6: Champ titre
  - [x] Champ titre optionnel (input texte) dans le header du widget ou au-dessus de l'éditeur. Si vide, l'affichage utilise les 30 premiers caractères du contenu (helper `getNoteDisplayTitle(title, content)`). [Source: AC 8]
- [x] Task 7: Persistance de l'état du widget
  - [x] Le widget reste ouvert lors de la navigation (state dans un Provider ou layout). Pas de fermeture au change de route. [Source: AC 4]
- [x] Task 8: Raccourci Cmd/Ctrl + J
  - [x] Écouter keydown global ; Cmd+J (Mac) ou Ctrl+J (Windows) ouvre/ferme le widget ; prévenir le comportement par défaut si nécessaire. [Source: AC 10]
- [x] Task 9: Lien vers page "Mes notes"
  - [x] Bouton/lien "Mes notes" dans le header du widget, pointe vers `/notes`. La page sera implémentée en Story 3.12. [Source: AC 11]
  - [x] Lien "Mes notes" également dans le menu utilisateur (DropdownMenu avatar, SiteNavbar), entre Équipe et Déconnexion.
- [x] Task 10: Intégration
  - [x] Intégrer `NoteChatWidget` dans le layout dashboard (DashboardShell ou équivalent). Visible uniquement sur pages authentifiées. [Source: docs/wireframes.md § Layout global]
  - [x] Route `/notes` protégée (proxy.ts) et reconnue comme dashboard (SiteNavbar isDashboard).
- [x] Task 11 – Testing (AC: 1–11)
  - [x] Tests d'intégration : note.create sans candidateId/offerId, note.listFree, note.update (auto-save), champ title. [Source: docs/architecture.md §14]
  - [x] Test manuel : widget, navigation sans fermeture, Cmd+J, liste, édition, auto-save.
- [x] Task 12 (QA): Rédiger les cas de test dans docs/stories/cases/3.11-test-cases.md.
- [x] Task 13 (review): Lancer une review de code en fin de développement avant clôture.

## Dev Notes

### Previous Story Insights

- Story 3.9 : notes sur candidats avec BlockNote, `NoteBlockNoteEditor`, router `note` (create avec candidateId). [Source: docs/stories/3.9]
- Le router note actuel exige candidateId pour create. Il faut accepter les notes libres (candidateId et offerId null). [Source: src/lib/validations/note.ts, src/server/trpc/routers/note.ts]

### Data Models

- **Note** : id, **title (String?, nouveau)**, content, authorId, candidateId (nullable), offerId (nullable), companyId. [Source: prisma/schema.prisma]
- Notes libres : candidateId = null, offerId = null. [Source: PRD, périmètre 3.11]

### API Specifications

- **note.create** (extended) : `{ title?: string, content: string, candidateId?: string, offerId?: string }` — aucun ID requis pour notes libres.
- **note.listFree** : retourne notes où candidateId IS NULL AND offerId IS NULL, companyId = ctx.companyId, orderBy updatedAt desc.
- **note.update** : accepte `title` en plus de `content`.

### Component Specifications

- Widget : panneau flottant (position: fixed, bottom-right), largeur type ~350px, hauteur ~400px ou plus, z-index élevé. Pas de modal (pas de overlay bloquant). [Source: design chat widget]
- Bouton flottant : 56x56px, terracotta, icône StickyNote ou PenLine. [Source: docs/design-system.md § FAB]

### File Locations

| Purpose     | Path                                               |
| ----------- | -------------------------------------------------- |
| Widget      | src/components/layout/NoteChatWidget.tsx           |
| Layout      | src/components/layout/DashboardShell.tsx           |
| Validations | src/lib/validations/note.ts                        |
| Router note | src/server/trpc/routers/note.ts                    |
| Migration   | prisma/migrations/xxx_add_note_title/migration.sql |

### Technical Constraints

- Cmd/Ctrl+J : certains navigateurs l'utilisent pour la barre de téléchargements ; tester et documenter. Alternative : Cmd+Shift+N si conflit.
- Titre dérivé : extraire 30 premiers caractères de texte brut depuis le JSON BlockNote (parcourir les blocks, concaténer le texte).

### Project Structure Notes

- Story 3.12 créera la page `/notes` (Mes notes). Le widget prépare le lien.

---

## Change Log

| Date       | Version | Description                                                                                                                                                    | Author   |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| 2026-02-21 | 0.1     | Story draft created (3.11 Quick Note FAB)                                                                                                                      | Bob (SM) |
| 2026-02-21 | 0.2     | Refonte : widget chat non bloquant, notes libres, titre, Cmd+J, auto-save                                                                                      | Bob (SM) |
| 2026-02-22 | 0.3     | Lien "Mes notes" déplacé dans le DropdownMenu utilisateur (avatar) ; route /notes dans proxy + isDashboard ; titre dérivé du content (30 car.) à create/update | Dev      |

---

## Dev Agent Record

### Agent Model Used

Auto

### Debug Log References

_(None)_

### Completion Notes List

- Migration `20260222000000_add_note_title` : exécuter `pnpm db:migrate` pour appliquer (requiert DATABASE_URL)
- Page `/notes` : placeholder créé pour Story 3.12
- Tests intégration note (listFree, create free, update title) : s'exécutent avec DATABASE_URL
- Lien "Mes notes" : dans le header du widget + dans le menu utilisateur (DropdownMenu avatar, SiteNavbar), pas dans la barre de nav principale
- Route `/notes` : protégée dans proxy.ts, incluse dans isDashboard (SiteNavbar)
- Titre note : dérivé automatiquement des 30 premiers caractères du contenu à chaque create/update (getNoteTitleFromContent) ; plus de champ titre éditable dans le widget

### File List

| Fichier                                                       | Action   |
| ------------------------------------------------------------- | -------- |
| prisma/schema.prisma                                          | modified |
| prisma/migrations/20260222000000_add_note_title/migration.sql | created  |
| src/lib/validations/note.ts                                   | modified |
| src/lib/note-utils.ts                                         | created  |
| src/server/trpc/routers/note.ts                               | modified |
| src/components/shared/NoteBlockNoteEditor.tsx                 | modified |
| src/components/layout/NoteChatWidget.tsx                      | created  |
| src/components/layout/DashboardShell.tsx                      | modified |
| src/components/layout/SiteNavbar.tsx                          | modified |
| src/app/(dashboard)/notes/page.tsx                            | created  |
| src/proxy.ts                                                  | modified |
| tests/unit/lib/note-utils.test.ts                             | created  |
| tests/unit/validations/note.test.ts                           | created  |
| tests/integration/note/note.test.ts                           | modified |
| docs/stories/cases/3.11-test-cases.md                         | created  |

---

## QA Results

_(To be filled by QA Agent)_
