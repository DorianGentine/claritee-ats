# Story 1.7: Base Layout & Navigation Shell

## Status

DONE

## Story

**As a** user,  
**I want** a consistent navigation and layout across all authenticated pages,  
**so that** I can easily navigate the application.

## Acceptance Criteria

1. Persistent sidebar or top navigation on all authenticated pages
2. Navigation items: Dashboard, Candidats, Offres, Clients, Paramètres
3. Active page highlighted in navigation
4. Company name displayed in navigation area
5. User avatar/initials + name in navigation
6. Logout accessible from user menu
7. Layout applies consistent spacing, typography, colors from brand palette
8. Mobile-responsive navigation (hamburger menu or collapsible sidebar)
9. Loading states for page transitions
10. 404 page styled consistently with app design
11. Les composants du layout (sidebar, header, navigation) sont testés pour l'accessibilité selon `coding-standards.md` §7 (jest-axe, Pa11y sur écrans critiques) ; violations WCAG AA corrigées.

## Tasks / Subtasks

- [x] Task 1 (AC: 1–7): Préserver et étendre le layout/navbar existant
  - [x] **Préserver le layout/navbar existant** (`SiteNavbar`, `DashboardShell`) : ne pas les remplacer ni recréer une nouvelle barre. Étendre les composants actuels pour atteindre les AC (sidebar ou top nav persistante, liens, menu user, company name, avatar). [Source: docs/qa/sprint-change-proposal-2026-02-15-navbar-preservation.md]
  - [x] S'appuyer sur ce qui a été fait en 1.4/1.5/1.6 (navbar, company name, nav links, logout). Cette story affine : ajout du lien **Paramètres**, état actif, avatar/initials, responsive, 404, a11y. [Source: docs/stories/1.6]
  - [x] Navigation items complets : Dashboard, Candidats, Offres, Clients, **Paramètres** (activer le lien vers `/settings` ou section paramètres). [Source: PRD AC 2]
  - [x] Active page : mettre en évidence l’item de nav correspondant au pathname (style ou aria-current). [Source: PRD AC 3]
  - [x] Company name et user avatar/initials + name dans la zone navigation (déjà partiellement en 1.6 ; compléter si besoin). [Source: PRD AC 4, 5]
  - [x] Logout reste accessible depuis le menu user (comportement existant à conserver). [Source: PRD AC 6]
  - [x] Espacement, typo, couleurs conformes au design-system (tokens CSS). [Source: PRD AC 7, docs/design-system.md]
- [x] Task 2 (AC: 8): Navigation responsive
  - [x] Sur mobile/tablette : menu hamburger ou sidebar repliable pour afficher/masquer les liens. [Source: PRD AC 8, docs/frontend-architecture.md §4.3]
  - [x] Desktop-first ; comportement dégradé acceptable sur petit écran tant que la nav reste utilisable. [Source: docs/prd.md Target Device]
- [x] Task 3 (AC: 9): Loading states
  - [x] États de chargement lors des transitions de page (skeleton, spinner ou équivalent) pour éviter les écrans vides. [Source: PRD AC 9]
- [x] Task 4 (AC: 10): Page 404
  - [x] Créer ou mettre à jour la page 404 (e.g. `src/app/not-found.tsx`) avec le style de l’app (design-system, lien retour dashboard ou accueil). [Source: PRD AC 10]
- [x] Task 5 (AC: 11): Accessibilité layout
  - [x] Tests jest-axe sur les composants du layout (sidebar/header/nav) : `expect(await axe(container)).toHaveNoViolations()`. [Source: docs/architecture/coding-standards.md §7]
  - [x] Pa11y sur les écrans critiques (dashboard, une page settings) : `pa11y --standard WCAG2AA <url>` ; corriger les violations WCAG AA identifiées. [Source: docs/architecture/coding-standards.md §7]
  - [x] Priorité écrans : dashboard, layout avec nav, 404. [Source: coding-standards.md §7]
- [x] Task 6 – Testing (AC: 1–11): Vérification
  - [x] Manuel : navigation entre toutes les pages authentifiées, lien actif correct, menu user, responsive, 404 affichée pour route inconnue. [Source: docs/architecture.md §14]
  - [x] Tests automatisés : jest-axe sur le shell/navbar ; optionnellement Pa11y en CI ou script npm. [Source: docs/architecture/coding-standards.md §7]
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/1.7-test-cases.md` ou `docs/qa/cases/1.7-layout-test-cases.md`) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- **Stories 1.4–1.6** : La navbar (`SiteNavbar`) et le shell ont été mis en place progressivement (logo, auth, Déconnexion, company name, liens Dashboard/Candidats/Offres/Clients, menu user). La 1.7 **étend** ce layout (Paramètres, active state, avatar/initials, responsive, 404, a11y) **sans repartir de zéro**. Ne pas remplacer ni dupliquer la navbar. [Source: docs/qa/sprint-change-proposal-2026-02-15-navbar-preservation.md, docs/stories/1.6]
- Router `company.getMyCompany` et layout dashboard existent (1.6). [Source: docs/stories/1.6]

### Data Models

Aucun nouveau modèle. Données affichées dans le layout : company name (company.getMyCompany), user (session). [Source: docs/architecture.md §7]

### API Specifications

Réutilisation de `company.getMyCompany` pour le nom du cabinet. Pas de nouveau endpoint pour cette story. [Source: docs/architecture.md §9]

### Component Specifications

- **Layout** : Sidebar ou top nav (selon choix implémentation) ; Header avec recherche Cmd+K (optionnel MVP), avatar + menu user. FAB note rapide (optionnel pour cette story). [Source: docs/frontend-architecture.md §4.3]
- **Design system** : tokens `--background`, `--card`, `--primary`, `--secondary`, `--foreground`, `--muted-foreground` ; typo et espacement cohérents. [Source: docs/design-system.md]
- **a11y** : focus visible, labels, navigation clavier ; pas de violation jest-axe / Pa11y WCAG2AA sur les composants layout. [Source: docs/architecture/coding-standards.md §7]

### File Locations

| Purpose          | Path                                                                     |
| ---------------- | ------------------------------------------------------------------------ |
| Navbar / shell   | src/components/layout/SiteNavbar.tsx, DashboardShell.tsx                 |
| Layout dashboard | src/app/(dashboard)/layout.tsx                                           |
| Page 404         | src/app/not-found.tsx                                                    |
| Tests a11y       | tests/unit/ ou tests/e2e/ (jest-axe) ; script Pa11y (package.json ou CI) |

[Source: docs/architecture.md §6, docs/architecture/source-tree.md]

### Technical Constraints

- **Préserver l’existant** : étendre SiteNavbar/DashboardShell, ne pas les réécrire. [Source: sprint-change-proposal-2026-02-15]
- **WCAG AA** : cible accessibilité ; jest-axe + Pa11y sur layout et écrans clés. [Source: PRD, coding-standards.md §7]

### Testing

- **jest-axe** : sur les composants layout (navbar, sidebar si présent). [Source: docs/architecture/coding-standards.md §7]
- **Pa11y** : dashboard, settings, 404 (script npm ou CI). [Source: docs/architecture/coding-standards.md §7]
- **Manuel** : parcours navigation, responsive, 404. [Source: docs/architecture.md §14]

### Project Structure Notes

Structure conforme à docs/architecture.md §6 et frontend-architecture.md §4. Aucun conflit.

---

## Change Log

| Date       | Version | Description                                                                                                                              | Author      |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-15 | 0.1     | Story draft created (1.7 Base Layout & Navigation Shell) ; règle préserver/étendre navbar intégrée                                       | Bob (SM)    |
| 2026-02-15 | 0.2     | Implémentation : Paramètres, active state, avatar, menu user, responsive hamburger, loading, 404, jest-axe, Pa11y script, cas de test QA | James (Dev) |
| 2026-02-15 | 0.3     | Code review : lint + tests OK ; AC 1–11 couverts ; story clôturée                                                                        | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

James (dev agent) / Cursor.

### Debug Log References

Aucun.

### Completion Notes List

- Layout/navbar étendu sans remplacer SiteNavbar ni DashboardShell (sprint-change-proposal respecté).
- Composants UI ajoutés manuellement (dropdown-menu, avatar) avec packages Radix individuels (@radix-ui/react-dropdown-menu, @radix-ui/react-avatar) pour respecter la règle projet « pas de radix-ui umbrella ».
- Test jest-axe désactive la règle color-contrast en jsdom pour éviter l’erreur getContext/canvas.
- Script Pa11y : `pnpm run a11y` (nécessite `pnpm dev` au préalable).
- Code review (clôture) : lint OK, suite de tests OK (dont a11y) ; breakpoint burger à 800px ; menu user aligné à droite ; test a11y utilise `expect(results.violations).toEqual([])` (vitest-axe matcher type-only).

### File List

| Fichier                                               | Action                       |
| ----------------------------------------------------- | ---------------------------- |
| src/components/layout/SiteNavbar.tsx                  | Modifié                      |
| src/components/ui/dropdown-menu.tsx                   | Créé                         |
| src/components/ui/avatar.tsx                          | Créé                         |
| src/app/(dashboard)/loading.tsx                       | Créé                         |
| src/app/not-found.tsx                                 | Créé                         |
| package.json                                          | Modifié (deps + script a11y) |
| tests/unit/components/layout/SiteNavbar.a11y.test.tsx | Créé                         |
| tests/setup-a11y.ts                                   | Créé                         |
| docs/stories/cases/1.7-test-cases.md                  | Créé                         |

---

## QA Results

_(Results from QA Agent review of the completed story implementation.)_
