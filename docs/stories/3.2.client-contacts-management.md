# Story 3.2: Client Contacts Management

## Status

DONE

## Story

**As a** recruiter,  
**I want** to add contacts to my client companies,  
**so that** I can track who I interact with at each client.

## Acceptance Criteria

1. Contacts section on client detail page
2. "Ajouter un contact" button
3. Contact form: firstName*, lastName*, email, phone, position/title, linkedinUrl
4. Email and LinkedIn format validation
5. Contacts displayed as list/cards on client page
6. Edit button on each contact
7. Delete contact with confirmation
8. Contact associated with client company (foreign key)
9. Empty state: "Aucun contact ajoutÃ©"
10. Quick action: click email/phone to copy to clipboard

**RÃ©f.** Wireframes Â§7 Fiche Client (section Contacts, modal Ajouter/Modifier contact, champs, icÃ´ne copier ðŸ“‹) ; Design System (boutons outline).

## Tasks / Subtasks

- [x] Task 1 (AC: 8): API â€“ ProcÃ©dures contacts
  - [x] Ã‰tendre `client.getById` pour inclure la liste des contacts (`include: { contacts: true }`). Retourner les champs contact : id, firstName, lastName, email, phone, position, linkedinUrl, createdAt. [Source: docs/architecture/source-tree.md, prisma/schema.prisma ClientContact]
  - [x] Ajouter dans le router `client` : `createContact`, `updateContact`, `deleteContact`. Toutes en protectedProcedure. [Source: docs/architecture/coding-standards.md Â§3.1]
  - [x] `createContact` : input `{ clientCompanyId, ...contactFields }`. VÃ©rifier que la ClientCompany existe et appartient Ã  `ctx.companyId` avant de crÃ©er le ClientContact. [Source: docs/architecture.md Â§4 â€” accÃ¨s via entitÃ© parente]
  - [x] `updateContact` : input `{ id, ...partialContactFields }`. VÃ©rifier que le contact appartient Ã  une ClientCompany du cabinet (requÃªte via clientCompany.companyId = ctx.companyId). [Source: idem]
  - [x] `deleteContact` : input `{ id }`. MÃªme vÃ©rification dâ€™appartenance au cabinet avant suppression. [Source: idem]
- [x] Task 2 (AC: 3, 4): Validations
  - [x] CrÃ©er (ou Ã©tendre) les schÃ©mas dans `src/lib/validations/client.ts` : `createClientContactSchema` (firstName, lastName requis ; email, phone, position, linkedinUrl optionnels). [Source: docs/architecture/coding-standards.md Â§3]
  - [x] Email : validation format si fourni (z.email() ou Ã©quivalent Zod v4). [Source: docs/prd.md Standard Error Messages]
  - [x] LinkedIn : validation format linkedin.com/in/... si fourni. [Source: PRD AC 4]
  - [x] SchÃ©ma update : partial de create + id pour updateContact. [Source: coding-standards Â§3.1]
- [x] Task 3 (AC: 1, 2, 5, 6, 7, 9): Section Contacts sur la fiche client
  - [x] Dans `src/app/(dashboard)/clients/[id]/page.tsx`, remplacer le placeholder Contacts par la section rÃ©elle. [Source: docs/stories/3.1 â€” section dÃ©jÃ  prÃ©vue]
  - [x] Afficher la liste des contacts (donnÃ©es venant de `getById` avec include contacts). Cartes ou liste : nom complet, poste, email, tÃ©lÃ©phone, LinkedIn. [Source: wireframes Â§7]
  - [x] Bouton Â« Ajouter un contact Â» (style outline/secondaire). Ouvre une modal avec formulaire (PrÃ©nom*, Nom*, Email, TÃ©lÃ©phone, Poste, LinkedIn). [Source: wireframes Â§7, Design System]
  - [x] Sur chaque contact : bouton Modifier (ouvre modal prÃ©-remplie), bouton Supprimer (confirmation avant suppression). [Source: wireframes Â§7]
  - [x] Empty state : Â« Aucun contact ajoutÃ© Â». [Source: AC 9]
- [x] Task 4 (AC: 10): Copier email / tÃ©lÃ©phone
  - [x] IcÃ´ne copier (ðŸ“‹ ou Copy) Ã  cÃ´tÃ© de lâ€™email et du tÃ©lÃ©phone de chaque contact. Clic â†’ copie dans le presse-papiers + toast Â« CopiÃ© ! Â» (ou Ã©quivalent). [Source: wireframes Â§7]
- [x] Task 5: IntÃ©gration mutations
  - [x] CrÃ©ation contact : mutation `client.createContact` ; invalider `client.getById` pour le client courant. [Source: docs/frontend-architecture.md Â§3.1]
  - [x] Modification : `client.updateContact` ; invalidation idem.
  - [x] Suppression : `client.deleteContact` ; invalidation idem.
- [x] Task 6 â€“ Testing (AC: 1â€“10)
  - [x] Tests dâ€™intÃ©gration : client.getById avec contacts ; client.createContact (champs requis, validation email/LinkedIn, isolation cabinet) ; client.updateContact et client.deleteContact (appartenance cabinet, NOT_FOUND). [Source: docs/architecture/coding-standards.md Â§6]
  - [x] Tests unitaires : schÃ©mas Zod contact (createClientContactSchema, champs optionnels, formats email/LinkedIn). [Source: idem]
- [x] Task 7 (QA): RÃ©diger les cas de test dans un fichier dÃ©diÃ© (ex. docs/stories/cases/3.2-test-cases.md) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de dÃ©veloppement avant clÃ´ture de la story.

## Dev Notes

### Previous Story Insights

- Story 3.1 DONE : router `client` avec list, getById, create. Page fiche client `/clients/[id]` existe ; section Â« Contacts Â» est un placeholder (Â« La gestion des contacts clients sera ajoutÃ©e dans la Story 3.2 Â»). [Source: docs/stories/3.1, src/app/(dashboard)/clients/[id]/page.tsx]
- getById ne retourne pas encore les contacts ; il faudra ajouter `include: { contacts: true }` et exposer les contacts dans le type de retour. [Source: src/server/trpc/routers/client.ts]

### Data Models

- **ClientCompany** : id, name, siren, companyId. Relation `contacts` (ClientContact[]). [Source: prisma/schema.prisma]
- **ClientContact** : id, clientCompanyId, firstName, lastName, email (String?), phone (String?), position (String?), linkedinUrl (String?), createdAt. Pas de companyId ; lâ€™accÃ¨s se fait uniquement via la ClientCompany (filtrÃ©e par companyId). [Source: prisma/schema.prisma]
- Pour create/update/delete contact : toujours vÃ©rifier que la ClientCompany parente appartient Ã  `ctx.companyId`. [Source: docs/architecture.md Â§4, coding-standards Â§5.1]

### API Specifications

- **client.getById** (Ã©tendu) : inclure `contacts: true` ; retourner les contacts avec id, firstName, lastName, email, phone, position, linkedinUrl, createdAt. [Source: docs/architecture/source-tree.md]
- **client.createContact** : input { clientCompanyId (uuid), firstName, lastName, email?, phone?, position?, linkedinUrl? }. VÃ©rifier ClientCompany existe et companyId = ctx.companyId ; puis crÃ©er ClientContact. [Source: coding-standards Â§3]
- **client.updateContact** : input { id (uuid), firstName?, lastName?, email?, phone?, position?, linkedinUrl? }. Trouver le contact via ClientContact incluant clientCompany ; vÃ©rifier clientCompany.companyId = ctx.companyId ; puis update. [Source: idem]
- **client.deleteContact** : input { id }. MÃªme vÃ©rification dâ€™appartenance ; puis delete. [Source: idem]
- Pas de rate limiting spÃ©cifique pour ces endpoints (lecture/Ã©criture mÃ©tier standard). [Source: docs/architecture/rate-limiting.md]

### Component Specifications

- Section Contacts : mÃªme style que la section actuelle (rounded-lg border bg-card p-4). Titre Â« Contacts Â», bouton Â« Ajouter un contact Â» (outline). [Source: wireframes Â§7, Design System]
- Modal Ajouter/Modifier : champs PrÃ©nom*, Nom*, Email, TÃ©lÃ©phone, Poste, LinkedIn. Boutons Annuler et Enregistrer. [Source: wireframes Â§7]
- Carte contact : nom complet, poste, email avec icÃ´ne copier, tÃ©lÃ©phone avec icÃ´ne copier, lien LinkedIn si prÃ©sent, boutons Modifier / Supprimer. [Source: wireframes Â§7]
- Suppression : Dialog de confirmation (ex. Â« Supprimer ce contact ? Â») avant appel Ã  deleteContact. [Source: PRD, shadcn Dialog]

### File Locations

| Purpose | Path |
|--------|------|
| Router client (Ã©tendre) | src/server/trpc/routers/client.ts |
| Validations client/contact | src/lib/validations/client.ts |
| Page fiche client | src/app/(dashboard)/clients/[id]/page.tsx |
| Composant(s) modal/liste contacts | src/components/clients/ (ex. ClientContactCard.tsx, ClientContactFormModal.tsx â€” ou inline selon complexitÃ©) |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- ClientContact nâ€™a pas de companyId : ne jamais requÃªter directement sans vÃ©rifier le parent. [Source: docs/architecture/coding-standards.md Â§5.1]
- Zod v4 : utiliser z.email(), z.url() (ou pattern LinkedIn) pour les formats. [Source: coding-standards Â§3]
- Messages dâ€™erreur : Â« [Nom du champ] est requis. Â», Â« Veuillez entrer une adresse email valide. Â» (PRD). [Source: docs/prd.md Standard Error Messages]

### Testing

- IntÃ©gration : isolation multi-tenant (crÃ©ation/mise Ã  jour/suppression contact uniquement si la ClientCompany appartient au cabinet). [Source: docs/architecture.md Â§4]
- Unit : validation des schÃ©mas contact (email invalide, LinkedIn invalide, champs requis). [Source: coding-standards Â§6]

### Project Structure Notes

- Aucun conflit. Extension du router existant et de la page dÃ©tail client ; possibilitÃ© de crÃ©er un sous-dossier `src/components/clients/` pour les composants contacts si la page devient lourde. [Source: source-tree.md Â§2]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-24 | 0.1 | Story draft created (3.2 Client Contacts Management) | Bob (SM) |
| 2026-02-24 | 0.2 | ImplÃ©mentation : router client (getById+contacts, createContact, updateContact, deleteContact), validations, section Contacts fiche client, ClientContactCard, ClientContactFormModal, copie email/tÃ©l, tests intÃ©gration/unit, cas de test QA | Dev Agent |

---

## Dev Agent Record

*(This section is populated by the development agent during implementation.)*

### Agent Model Used

Claude Opus 4.5 (via Cursor)

### Debug Log References

*(Aucune)*

### Completion Notes List

- API : getById Ã©tendu avec `include: { contacts: { select: { id, firstName, lastName, email, phone, position, linkedinUrl, createdAt } } }`. ProcÃ©dures createContact, updateContact, deleteContact avec vÃ©rification d'appartenance au cabinet via ClientCompany parente.
- Validations : createClientContactSchema avec optionalEmail/optionalLinkedInUrl (pattern linkedin.com/in/...), updateClientContactSchema = partial + id.
- UI : ClientContactFormModal (React Hook Form + zodResolver), ClientContactCard (affichage + boutons Modifier/Supprimer + icÃ´ne Copy pour email/phone avec feedback "CopiÃ© !"). ConfirmDialog pour suppression.
- Tests : 13 tests unit validations client ; intÃ©gration client (getById contacts, createContact, updateContact, deleteContact + isolation cabinet, formats).
- Copie presse-papiers : navigator.clipboard.writeText + feedback inline "CopiÃ© !" (2s) â€” pas de librairie toast ajoutÃ©e.

### File List

| Path | Action |
|------|--------|
| src/server/trpc/routers/client.ts | modified |
| src/lib/validations/client.ts | modified |
| src/app/(dashboard)/clients/[id]/page.tsx | modified |
| src/components/clients/ClientContactFormModal.tsx | created |
| src/components/clients/ClientContactCard.tsx | created |
| tests/integration/client/client.test.ts | modified |
| tests/unit/validations/client.test.ts | created |
| docs/stories/cases/3.2-test-cases.md | created |

---

## QA Results

*(Results from QA Agent QA review of the completed story implementation.)*
