# Story 2.3: Candidate Profile Photo Upload

## Status

DONE

## Story

**As a** recruiter,  
**I want** to upload a photo for a candidate,  
**so that** their profile is visually identifiable.

## Acceptance Criteria

1. Photo upload available on candidate creation and edit forms
2. Accepts image formats: JPG, PNG, WebP
3. File size limit: 2 MB max with clear error message
4. Image uploaded to Supabase Storage in company-specific folder
5. Image URL stored in candidate record
6. Preview shown after upload, before form submission
7. Option to remove/replace existing photo
8. Default placeholder (initials) shown when no photo
9. Photos served via Supabase CDN URL
10. Circular crop/display of photo in UI
11. Rate limiting on uploads: max 30 uploads (photo + CV combined) per user per hour; if exceeded, message « Trop de requêtes. Réessayez dans quelques minutes. »

## Tasks / Subtasks

- [x] Task 1 (AC: 2, 3, 4, 5): Backend — upload photo et mise à jour candidat
  - [x] Créer la procédure `candidate.uploadPhoto` (ou équivalent) dans le router candidate : protectedProcedure, input candidateId + fichier (ex. base64 ou URL temporaire selon choix d’implémentation). [Source: docs/architecture.md §9, docs/architecture/rate-limiting.md §3.3]
  - [x] En tête de procédure : rate limit `upload:${ctx.user.id}` avec RATE_LIMITS.UPLOAD_PER_USER (30/heure). Si dépassé : TRPCError TOO_MANY_REQUESTS, message « Trop de requêtes. Réessayez dans quelques minutes. » [Source: src/lib/rate-limit.ts, docs/architecture/rate-limiting.md §3.3]
  - [x] Valider type (JPG, PNG, WebP) et taille (max 2 Mo). En cas d’erreur : messages PRD « Le fichier dépasse la taille maximale autorisée (2 Mo pour les photos, 5 Mo pour les CVs). » / « Format de fichier non supporté. Formats acceptés : JPG, PNG, WebP. » [Source: docs/prd.md Standard Error Messages]
  - [x] Upload vers Supabase Storage bucket `photos`, path `{companyId}/candidates/{candidateId}/photo.{ext}`. [Source: docs/architecture.md §8.1, §8.2]
  - [x] Vérifier que le candidat appartient au cabinet (id + companyId = ctx.companyId) avant upload. Puis mettre à jour `Candidate.photoUrl` avec l’URL Supabase (publique ou signée). [Source: docs/architecture.md §8.4, docs/architecture/coding-standards.md §5.1]
- [x] Task 2 (AC: 1, 6, 7, 8, 10): UI — upload sur formulaire création (et édition si existant)
  - [x] Ajouter un champ « Photo » sur le formulaire de création candidat (`/candidates/new`) : input file acceptant JPG, PNG, WebP, max 2 Mo. [Source: PRD AC 1, 2, 3]
  - [x] Afficher une prévisualisation après sélection (avant soumission du formulaire). [Source: PRD AC 6]
  - [x] Option pour supprimer/remplacer la photo sélectionnée. [Source: PRD AC 7]
  - [x] Si pas de photo : afficher le placeholder initiales (comportement existant). [Source: PRD AC 8]
  - [x] Affichage circulaire de la photo dans l’UI (avatar/cercle). [Source: PRD AC 10]
  - [x] Si le formulaire d’édition candidat existe déjà, y ajouter les mêmes capacités (upload, preview, remove). Sinon, couvrir au minimum le formulaire de création. [Source: PRD AC 1]
- [x] Task 3 (AC: 9): URLs et affichage
  - [x] Stocker l’URL retournée par Supabase (publique ou signée) dans `Candidate.photoUrl`. Les photos sont servies via cette URL (Supabase CDN). [Source: docs/architecture.md §8.4, PRD AC 9]
- [x] Task 4 – Testing (AC: 3, 4, 11): Vérification
  - [x] Unit ou intégration : rejet si fichier > 2 Mo ou type invalide ; message d’erreur conforme. [Source: docs/architecture.md §14]
  - [x] Intégration : après upload, `Candidate.photoUrl` mis à jour ; rate limit appliqué (mock ou dépassement). [Source: docs/architecture/coding-standards.md §6]
- [x] Task 5 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/2.3-test-cases.md` ou `docs/qa/cases/2.3-photo-upload-test-cases.md`) pour faciliter la review de la story.
- [x] Task 6 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.2 : Formulaire de création candidat sur `/candidates/new` ; pas de champ photo pour l’instant. Le formulaire d’édition (Edit Candidate) est en story 2.10 ; pour 2.3, prioriser le formulaire de création et ajouter l’upload sur l’édition si le formulaire existe déjà. [Source: docs/stories/2.2, PRD 2.10]
- Router candidate : list, create existent. Ajouter uploadPhoto (ou procédure dédiée upload). [Source: codebase]

### Data Models

- **Candidate.photoUrl** : string nullable ; contient l’URL Supabase après upload. [Source: prisma/schema.prisma]
- Pas de nouveau modèle ; bucket Supabase `photos` déjà décrit en architecture §8. [Source: docs/architecture.md §8]

### API Specifications

- **candidate.uploadPhoto** (ou nom équivalent) : protectedProcedure. Input : candidateId (uuid), fichier (base64 ou multipart selon implémentation). Contraintes : type JPG/PNG/WebP, taille ≤ 2 Mo. Rate limit avant traitement. Output : candidat mis à jour avec photoUrl. [Source: docs/architecture.md §9, rate-limiting.md §3.3]
- Alternative : route API POST pour l’upload multipart + mutation tRPC pour mettre à jour photoUrl ; les deux doivent appliquer le rate limit et la vérification companyId. [Source: docs/architecture/rate-limiting.md §3.3]

### Component Specifications

- Input file avec accept=".jpg,.jpeg,.png,.webp" ; affichage preview (img) et bouton supprimer/remplacer. [Source: PRD AC 2, 6, 7]
- Avatar circulaire : shadcn Avatar ou composant avec border-radius 50% ; photo ou initiales. [Source: PRD AC 10, docs/design-system.md]

### File Locations

| Purpose | Path |
|--------|------|
| Router candidate (uploadPhoto) | src/server/trpc/routers/candidate.ts |
| Formulaire création (champ photo) | src/app/(dashboard)/candidates/new/page.tsx (ou composant partagé) |
| Rate limit | src/lib/rate-limit.ts (existant) |
| Client Supabase Storage | src/lib/supabase/client.ts ou server selon upload côté client ou serveur |

[Source: docs/architecture.md §6, docs/architecture/source-tree.md]

### Technical Constraints

- **Taille max** : 2 Mo pour les photos. [Source: docs/architecture.md §8.1, PRD]
- **Formats** : JPG, PNG, WebP uniquement. [Source: PRD AC 2]
- **Chemin Storage** : `{companyId}/candidates/{candidateId}/photo.{ext}`. [Source: docs/architecture.md §8.2]
- **Rate limit** : 30 uploads (photo + CV) par utilisateur par heure ; clé `upload:${userId}`. [Source: docs/architecture/rate-limiting.md §3.3, src/lib/rate-limit.ts]

### Testing

- Validation type/taille et messages PRD. [Source: docs/architecture.md §14]
- Upload réel ou mock Supabase ; vérification mise à jour photoUrl et respect du rate limit. [Source: docs/architecture/coding-standards.md §6]

### Project Structure Notes

- Bucket `photos` à créer dans Supabase si pas déjà fait ; policies selon §8.3. Pas de conflit avec la structure existante.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-15 | 0.1 | Story draft created (2.3 Candidate Profile Photo Upload) | Bob (SM) |
| 2026-02-15 | 0.2 | Implementation: uploadPhoto, UI form, tests, QA cases | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor)

### Debug Log References

—

### Completion Notes List

- Procédure `candidate.uploadPhoto` : input base64 + mimeType. Upload via `createAdminClient` (Supabase Storage).
- Bucket `photos` doit exister dans Supabase ; créer et configurer les policies si nécessaire.
- Formulaire d’édition (Story 2.10) : non implémenté dans cette story ; upload couvert sur création uniquement.

### File List

| Fichier | Action |
|---------|--------|
| src/server/trpc/routers/candidate.ts | Modified — ajout uploadPhoto |
| src/lib/validations/candidate.ts | Modified — uploadPhotoSchema, PHOTO_* |
| src/app/(dashboard)/candidates/new/page.tsx | Modified — champ photo, preview, Avatar |
| tests/unit/validations/candidate.test.ts | Modified — uploadPhotoSchema tests |
| tests/integration/candidate/candidate.test.ts | Modified — uploadPhoto tests (mock Supabase) |
| docs/stories/cases/2.3-test-cases.md | Created |

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
