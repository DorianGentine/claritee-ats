# Story 2.5: Candidate Summary & Languages

## Status

DONE

## Story

**As a** recruiter,  
**I want** to add a summary and languages to a candidate profile,  
**so that** I can capture their overview and language skills.

## Acceptance Criteria

1. "Résumé" field: multi-line textarea (500 chars max recommended)
2. Languages section with add/remove capability
3. Each language entry: language name + proficiency level
4. Proficiency levels: Notions, Intermédiaire, Courant, Bilingue, Natif
5. Common languages pre-suggested: Français, Anglais, Espagnol, Allemand, Italien
6. Custom language entry allowed
7. Languages displayed as badges/pills in CV layout
8. Edit inline or via edit form
9. Changes saved with explicit save action
10. Validation: at least language name required per entry

**Réf.** Wireframes §3 colonne gauche (langues en badges), résumé 500 caractères ; schéma Prisma Language.

## Tasks / Subtasks

- [x] Task 1 (AC: 1, 9): Résumé (summary) – API et validation
  - [x] Étendre le schéma de validation candidat : `summary` optionnel, `z.string().max(500)` (recommandé 500 caractères). [Source: docs/architecture/coding-standards.md §3, docs/prd.md Story 2.5]
  - [x] Ajouter ou étendre `candidate.update` pour accepter `summary` ; filtrer par `ctx.companyId`. Si la procédure n'existe pas, la créer (template router §3.1). [Source: docs/architecture.md §9, docs/architecture/coding-standards.md §3.1]
  - [x] S'assurer que `getById` retourne déjà `summary` (champ existant sur Candidate). [Source: prisma/schema.prisma]
- [x] Task 2 (AC: 2, 3, 4, 5, 6, 10): Langues – modèle et API
  - [x] Vérifier le modèle Prisma `Language` : `id`, `candidateId`, `name`, `level` (enum `LanguageLevel` : NOTION, INTERMEDIATE, FLUENT, BILINGUAL, NATIVE). Pas de modification schéma si déjà conforme. [Source: prisma/schema.prisma]
  - [x] Créer schémas Zod pour langue : `languageName` (string min 1), `level` (enum LanguageLevel). [Source: docs/architecture/coding-standards.md §3]
  - [x] Ajouter procedures tRPC dans le router `candidate` : `addLanguage` (input: candidateId, name, level), `removeLanguage` (input: candidateId, languageId). Vérifier que le candidat appartient au cabinet avant toute opération. [Source: docs/architecture.md §9, docs/architecture.md §4 – accès Language via Candidate]
  - [x] Validation : au moins le nom de la langue requis par entrée ; niveau requis. Messages d'erreur génériques côté client. [Source: docs/architecture/coding-standards.md §5.1, PRD Standard Error Messages]
- [x] Task 3 (AC: 1, 8, 9): UI – Résumé sur la fiche candidat
  - [x] Sur la page détail candidat (colonne gauche du layout CV) : afficher le champ « Résumé » en lecture seule si présent ; proposer une zone éditable (textarea 500 caractères max) en mode édition ou formulaire dédié. [Source: docs/stories/2.4, wireframes §3]
  - [x] Sauvegarde explicite : bouton « Enregistrer » qui appelle `candidate.update` avec `summary` ; invalidation de la query `getById` après succès. [Source: docs/frontend-architecture.md §3.1, §5]
  - [x] Indication du nombre de caractères (ex. « 120 / 500 ») recommandée. [Source: PRD AC 1]
- [x] Task 4 (AC: 2, 3, 4, 5, 6, 7, 8, 9): UI – Langues (ajout / suppression / affichage)
  - [x] Section « Langues » en colonne gauche : affichage en badges/pills (nom + niveau). [Source: PRD AC 7, docs/design-system.md]
  - [x] Niveaux affichés en français : Notions, Intermédiaire, Courant, Bilingue, Natif (mapping depuis enum NOTION, INTERMEDIATE, FLUENT, BILINGUAL, NATIVE). [Source: PRD AC 4]
  - [x] Ajout : combobox ou select pour la langue (suggestions : Français, Anglais, Espagnol, Allemand, Italien) + saisie libre autorisée ; select pour le niveau. Bouton « Ajouter » appelle `addLanguage`. [Source: PRD AC 5, AC 6]
  - [x] Suppression : bouton X ou « Retirer » sur chaque badge, avec confirmation si besoin ; appeler `removeLanguage`. [Source: PRD AC 2]
  - [x] Édition : soit inline (modifier nom/niveau puis sauvegarder), soit via formulaire d'édition ; sauvegarde explicite. [Source: PRD AC 8, AC 9]
- [x] Task 5 (AC: 10): Validation et messages
  - [x] Côté client : React Hook Form + Zod pour le formulaire résumé et le formulaire langue (nom requis, niveau requis). [Source: docs/frontend-architecture.md §6, docs/architecture/coding-standards.md §4]
  - [x] Côté tRPC : réutiliser les mêmes schémas Zod ; message générique en cas d'erreur (ex. « [Nom du champ] est requis »). [Source: docs/architecture/coding-standards.md §5.1]
- [x] Task 6 – Testing (AC: 1–10)
  - [x] Intégration : `candidate.update` avec summary ; `addLanguage` / `removeLanguage` avec candidat du cabinet ; refus si candidat d'un autre cabinet (NOT_FOUND). [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
  - [x] Manuel : saisie résumé, ajout/suppression langues, suggestions et langue personnalisée, sauvegarde explicite, affichage en badges. [Source: docs/architecture/coding-standards.md §6]
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/2.5-test-cases.md` ou `docs/qa/cases/2.5-candidate-summary-languages-test-cases.md`) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.4 : Page détail candidat avec layout CV (header + 2 colonnes) ; `getById` retourne déjà `summary`, `languages`, `experiences`, `formations`, `tags`. Composants dans `src/components/candidates/` (CandidateDetailView, etc.). [Source: docs/stories/2.4.candidate-detail-page-cv-layout.md]
- Router candidate : list, getById, create, delete, uploadPhoto existants ; pas de `update` ni de procedures dédiées aux langues. À ajouter : `update` (summary + champs de base si besoin), `addLanguage`, `removeLanguage`. [Source: codebase, docs/architecture.md §9]

### Data Models

- **Candidate** : `summary` (String? @db.Text) déjà présent. [Source: prisma/schema.prisma]
- **Language** : `id`, `candidateId`, `name`, `level` (enum LanguageLevel). Accès uniquement via Candidate (pas de companyId sur Language) ; isolation par vérification que le candidat appartient au cabinet. [Source: prisma/schema.prisma, docs/architecture.md §4]
- **LanguageLevel** (enum Prisma) : NOTION, INTERMEDIATE, FLUENT, BILINGUAL, NATIVE. Affichage UI : Notions, Intermédiaire, Courant, Bilingue, Natif. [Source: prisma/schema.prisma, docs/prd.md Story 2.5 AC 4]

### API Specifications

- **candidate.update** : protectedProcedure, input avec champs partiels (au minimum `summary` pour cette story) ; vérifier `id` + `companyId` puis update. [Source: docs/architecture.md §9, docs/architecture/coding-standards.md §3.1]
- **candidate.addLanguage** : protectedProcedure, input `{ candidateId, name, level }` ; vérifier que le candidat appartient au cabinet ; créer une entrée `Language`. [Source: docs/architecture.md §9]
- **candidate.removeLanguage** : protectedProcedure, input `{ candidateId, languageId }` ; vérifier que le candidat appartient au cabinet et que la langue appartient au candidat ; supprimer l'entrée. [Source: docs/architecture.md §9]

### Component Specifications

- Colonne gauche du layout CV : résumé (textarea en édition) et section langues (badges/pills). [Source: wireframes §3, docs/stories/2.4]
- Badges/pills : style cohérent design-system (couleurs, typo). [Source: docs/design-system.md]
- Formulaires : React Hook Form + Zod ; sauvegarde explicite (bouton Enregistrer). [Source: docs/frontend-architecture.md §6]

### File Locations

| Purpose | Path |
|--------|------|
| Page détail candidat | src/app/(dashboard)/candidates/[id]/page.tsx |
| Composants détail (résumé, langues) | src/components/candidates/ (ex. CandidateDetailSidebar, ou sous-composants réutilisables) |
| Router candidate | src/server/trpc/routers/candidate.ts |
| Validations candidat / langue | src/lib/validations/candidate.ts (étendre ou ajouter language schemas) |

[Source: docs/architecture/source-tree.md, docs/architecture.md §6]

### Technical Constraints

- Toutes les procedures candidat/langue doivent filtrer par `ctx.companyId` via le candidat. [Source: docs/architecture/coding-standards.md §5.1]
- Pas de RLS direct sur la table Language ; accès uniquement via procedures qui vérifient le candidat du cabinet. [Source: docs/architecture.md §4]

### Testing

- Tests d'intégration : update summary ; addLanguage / removeLanguage avec candidat du cabinet ; appel avec candidat d'un autre cabinet → NOT_FOUND. [Source: docs/architecture.md §14]
- Fichier de cas de test : à rédiger dans docs/stories/cases/ ou docs/qa/ (Task 7). [Source: story-draft-tasks rule]

### Project Structure Notes

- Aucun conflit avec la structure existante. Réutilisation de la page et des composants de la story 2.4.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 0.1 | Story draft created (2.5 Candidate Summary & Languages) | Bob (SM) |
| 2026-02-18 | 1.0 | Implementation complete: API (update, addLanguage, removeLanguage), UI (summary editable, languages badges), validation Zod, tests unitaires + intégration, cas de test QA | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

claude-4.6-opus (via Cursor)

### Debug Log References

Aucun debug majeur. Le package umbrella `radix-ui` a été installé automatiquement par shadcn CLI et remplacé par les packages individuels (`@radix-ui/react-select`, `@radix-ui/react-slot`) conformément à la règle de performance du projet.

### Completion Notes List

- **candidate.update** : Nouvelle procedure tRPC permettant la mise à jour partielle du candidat (summary pour cette story, extensible pour d'autres champs).
- **candidate.addLanguage / removeLanguage** : Procedures avec vérification multi-tenant (candidat doit appartenir au cabinet) et vérification d'appartenance de la langue au candidat pour removeLanguage.
- **CandidateSummarySection** : Composant avec mode lecture/édition, compteur de caractères, sauvegarde explicite, gestion d'erreur.
- **CandidateLanguagesSection** : Composant avec affichage en badges (shadcn Badge), ajout via formulaire (input + datalist suggestions + select niveau), suppression via bouton X sur chaque badge.
- **CandidateDetailSidebar** : Refactoré pour accepter `candidateId` et déléguer aux sous-composants interactifs.
- **Schémas Zod partagés** : `updateCandidateSchema`, `addLanguageSchema`, `removeLanguageSchema`, `languageLevelSchema`, `LANGUAGE_LEVELS` — réutilisés côté client (RHF) et serveur (tRPC).
- **Dépendance ajoutée** : `@radix-ui/react-select` (nécessaire pour le composant Select de shadcn/ui). Package umbrella `radix-ui` supprimé.
- **Tests** : 15 nouveaux tests unitaires (validation schemas) + 9 nouveaux tests d'intégration (update summary, addLanguage, removeLanguage, isolation multi-tenant).
- **Accessibilité** : aria-label sur les boutons icône, labels associés aux champs, focus visible.

### File List

| Action | Path |
|--------|------|
| Modified | src/lib/validations/candidate.ts |
| Modified | src/server/trpc/routers/candidate.ts |
| Modified | src/components/candidates/CandidateDetailSidebar.tsx |
| Modified | src/components/candidates/CandidateDetailView.tsx |
| Created | src/components/candidates/CandidateSummarySection.tsx |
| Created | src/components/candidates/CandidateLanguagesSection.tsx |
| Created | src/components/ui/textarea.tsx (shadcn) |
| Created | src/components/ui/badge.tsx (shadcn) |
| Created | src/components/ui/select.tsx (shadcn) |
| Modified | tests/unit/validations/candidate.test.ts |
| Modified | tests/integration/candidate/candidate.test.ts |
| Created | docs/stories/cases/2.5-test-cases.md |

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
