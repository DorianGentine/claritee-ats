# Story 2.7: Candidate Formations (CRUD)

## Status

DONE

## Story

**As a** recruiter,  
**I want** to add, edit, and remove education/formations on a candidate profile,  
**so that** I can document their academic background.

## Acceptance Criteria

1. Formations section on candidate detail page
2. "Ajouter une formation" button
3. Formation form fields: degree/title*, field/domain, school*, startDate, endDate
4. Date picker for dates (year, optionally month)
5. Formations displayed in reverse chronological order
6. Edit button on each formation opens edit form
7. Delete button with confirmation
8. School name with optional location
9. Empty state: "Aucune formation ajoutée"
10. Displayed in right column of CV layout, below experiences

**Réf.** Wireframes §3 colonne droite (expériences puis formations, ordre chrono inversé).

## Tasks / Subtasks

- [x] Task 1 (AC: 5): API – Procedures et ordre d’affichage
  - [x] Créer schémas Zod pour formation : `degree` (string min 1), `field` (string optionnel), `school` (string min 1), `startDate` (date optionnelle), `endDate` (date optionnelle). Dates au format année (optionnellement mois) côté UI, stockées en DateTime (ex. premier jour du mois ou 1er janvier). [Source: docs/architecture/coding-standards.md §3, prisma/schema.prisma]
  - [x] Ajouter procedures tRPC dans le router `candidate` : `addFormation`, `updateFormation`, `deleteFormation`. Inputs : candidateId + payload ; vérifier que le candidat appartient au cabinet ; pour delete, vérifier que la formation appartient au candidat. [Source: docs/architecture.md §9, docs/architecture.md §4 – accès Formation via Candidate]
  - [x] S’assurer que `getById` retourne les formations en ordre chronologique inverse (orderBy startDate desc, ou order). [Source: PRD AC 5, prisma/schema.prisma – champ order]
- [x] Task 2 (AC: 1, 2, 3, 4, 8): UI – Formulaire d’ajout de formation
  - [x] Sur la page détail candidat, section Formations (colonne droite, sous Expériences) : bouton « Ajouter une formation » ouvrant un formulaire (modal ou dialog). [Source: docs/stories/2.6, CandidateDetailContent]
  - [x] Champs : diplôme/intitulé* (degree), domaine (field, optionnel), école/établissement* (school) ; option « lieu » ou sous-champ optionnel pour l’école (lieu) si besoin — sinon school seul suffit pour le MVP (AC 8 : « school name with optional location » = un champ school peut contenir « École X, Paris »). [Source: PRD AC 3, AC 8]
  - [x] Dates : startDate, endDate (optionnelles) ; sélecteur année (optionnellement mois). [Source: PRD AC 4]
  - [x] Validation côté client (React Hook Form + Zod) et envoi via `candidate.addFormation` ; invalidation de `getById` après succès. [Source: docs/frontend-architecture.md §6]
- [x] Task 3 (AC: 6, 7): UI – Édition et suppression
  - [x] Sur chaque formation affichée : bouton « Modifier » ouvrant le formulaire pré-rempli ; sauvegarde via `candidate.updateFormation`. [Source: PRD AC 6]
  - [x] Bouton « Supprimer » avec confirmation (ConfirmDialog) ; à la confirmation, appeler `candidate.deleteFormation` puis invalider les données. [Source: PRD AC 7, pattern 2.6]
- [x] Task 4 (AC: 9, 10): Empty state et position
  - [x] Conserver l’état vide « Aucune formation » lorsque la liste est vide. [Source: PRD AC 9]
  - [x] Section Formations affichée dans la colonne droite du layout CV, sous la section Expériences. [Source: PRD AC 10, CandidateDetailContent]
- [x] Task 5 – Validation et erreurs
  - [x] Côté tRPC : réutiliser les schémas Zod ; message générique en cas d’erreur (ex. « [Nom du champ] est requis »). [Source: docs/architecture/coding-standards.md §5.1]
- [x] Task 6 – Testing (AC: 1–9)
  - [x] Intégration : addFormation, updateFormation, deleteFormation avec candidat du cabinet ; refus si candidat ou formation d’un autre cabinet (NOT_FOUND). [Source: docs/architecture.md §14]
  - [x] Manuel : ajout, édition, suppression, date picker, empty state, ordre chronologique inverse. [Source: docs/architecture/coding-standards.md §6]
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/2.7-test-cases.md` ou `docs/qa/cases/2.7-candidate-formations-test-cases.md`) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.6 : CRUD expériences avec `ExperienceFormDialog`, procedures addExperience / updateExperience / deleteExperience, section Expériences dans `CandidateDetailContent` (boutons Ajouter / Modifier / Supprimer, ConfirmDialog). getById retourne expériences avec orderBy startDate desc. [Source: docs/stories/2.6, src/components/candidates/CandidateDetailContent.tsx, ExperienceFormDialog]
- Réutiliser le même pattern : FormationFormDialog (ou équivalent), addFormation / updateFormation / deleteFormation, section Formations déjà présente en lecture seule dans CandidateDetailContent. [Source: codebase]

### Data Models

- **Formation** (Prisma) : `id`, `candidateId`, `degree`, `field` (String?), `school`, `startDate` (DateTime?), `endDate` (DateTime?), `order` (Int default 0). Accès uniquement via Candidate ; isolation par vérification que le candidat appartient au cabinet. [Source: prisma/schema.prisma, docs/architecture.md §4]
- Affichage : ordre chronologique inverse (startDate desc) ; empty state « Aucune formation ajoutée ». [Source: PRD AC 5, AC 9]
- School avec optional location : un seul champ `school` suffit (ex. « HEC Paris » ou « HEC Paris, Jouy-en-Josas »). [Source: PRD AC 8]

### API Specifications

- **candidate.addFormation** : protectedProcedure, input `{ candidateId, degree, field?, school, startDate?, endDate? }` ; vérifier candidat du cabinet ; créer Formation. [Source: docs/architecture.md §9]
- **candidate.updateFormation** : protectedProcedure, input `{ candidateId, formationId, degree?, field?, school?, startDate?, endDate? }` ; vérifier candidat et formation liée ; update. [Source: docs/architecture.md §9]
- **candidate.deleteFormation** : protectedProcedure, input `{ candidateId, formationId }` ; vérifier candidat et formation ; supprimer. [Source: docs/architecture.md §9]
- **getById** : retourner les formations triées par startDate desc (ou order) pour cohérence avec l’affichage CV. [Source: PRD AC 5]

### Component Specifications

- Section Formations dans la colonne droite, sous Expériences (déjà présente dans CandidateDetailContent). [Source: wireframes §3, docs/stories/2.4]
- Formulaire : degree*, field (optionnel), school* ; dates optionnelles avec picker année (optionnellement mois). [Source: PRD AC 3, AC 4]
- Dialog shadcn pour formulaire ; ConfirmDialog pour suppression (même pattern que 2.6). [Source: docs/architecture/coding-standards.md §4]

### File Locations

| Purpose                                   | Path                                                                  |
| ----------------------------------------- | --------------------------------------------------------------------- |
| Contenu détail (expériences + formations) | src/components/candidates/CandidateDetailContent.tsx                  |
| Formulaire formation (nouveau)            | src/components/candidates/FormationFormDialog.tsx (ou nom équivalent) |
| Router candidate                          | src/server/trpc/routers/candidate.ts                                  |
| Validations                               | src/lib/validations/candidate.ts (étendre) ou validations dédiées     |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- Procedures formation : vérifier que le candidat appartient au cabinet (ctx.companyId). [Source: docs/architecture/coding-standards.md §5.1]
- Tables sans companyId (Formation) : accès uniquement via Candidate. [Source: docs/architecture.md §4]
- Dates : DateTime en base ; UI année (optionnellement mois) → ex. 1er janvier ou 1er du mois. [Source: PRD AC 4]

### Testing

- Intégration : addFormation, updateFormation, deleteFormation (succès, NOT_FOUND). [Source: docs/architecture.md §14]
- Fichier de cas de test : docs/stories/cases/ ou docs/qa/ (Task 7). [Source: story-draft-tasks rule]

### Project Structure Notes

- Aucun conflit. Réutilisation de CandidateDetailContent et du pattern Experience (dialog + confirm). [Source: 2.6]

---

## Change Log

| Date       | Version | Description                                                                                                                                     | Author      |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-18 | 0.1     | Story draft created (2.7 Candidate Formations CRUD)                                                                                             | Bob (SM)    |
| 2026-02-18 | 0.2     | Implementation: API (Zod, add/update/deleteFormation, getById order), UI (FormationFormDialog, edit/delete, empty state), tests, test cases doc | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

_(To be filled by the development agent.)_

### Debug Log References

_(None.)_

### Completion Notes List

- API : schémas Zod `addFormationSchema`, `updateFormationSchema`, `deleteFormationSchema` dans `src/lib/validations/candidate.ts` ; procedures `addFormation`, `updateFormation`, `deleteFormation` dans le router candidate ; `getById` inclut formations avec `orderBy: { startDate: "desc" }`.
- UI : `FormationFormDialog` (formulaire degree, field, school, dates optionnelles mois/année) ; section Formations dans `CandidateDetailContent` avec bouton Ajouter, Modifier, Supprimer (ConfirmDialog) ; empty state « Aucune formation ajoutée ».
- Tests d'intégration : `tests/integration/candidate/candidate.test.ts` (addFormation, updateFormation, deleteFormation, getById ordre formations).
- Cas de test : `docs/stories/cases/2.7-test-cases.md`.

### File List

| Fichier                                              | Statut                                                         |
| ---------------------------------------------------- | -------------------------------------------------------------- |
| src/lib/validations/candidate.ts                     | Modifié (schémas formation)                                    |
| src/server/trpc/routers/candidate.ts                 | Modifié (add/update/deleteFormation, getById order formations) |
| src/components/candidates/FormationFormDialog.tsx    | Nouveau                                                        |
| src/components/candidates/CandidateDetailContent.tsx | Modifié (section Formations, boutons, dialogs)                 |
| tests/integration/candidate/candidate.test.ts        | Modifié (tests formation)                                      |
| docs/stories/cases/2.7-test-cases.md                 | Nouveau                                                        |

---

## QA Results

_(Results from QA Agent review of the completed story implementation.)_
