# Story 2.2: Create Candidate - Basic Information

## Status

DONE

## Story

**As a** recruiter,  
**I want** to create a new candidate with basic information,  
**so that** I can start building their profile.

## Acceptance Criteria

1. "Nouveau candidat" opens creation form (modal or dedicated page)
2. Form fields: firstName*, lastName*, email, phone, linkedinUrl, title, city
3. Required fields marked with asterisk, validated on submit
4. Email format validation if provided
5. LinkedIn URL format validation if provided (linkedin.com/in/...)
6. Phone format flexible (accepts various French formats)
7. Successful creation redirects to candidate detail page
8. Candidate associated with user's company automatically
9. Form shows loading state during submission
10. Cancel button returns to candidate list without saving

## Tasks / Subtasks

- [x] Task 1 (AC: 2, 3, 4, 5, 6): Schéma de validation et procédure create
  - [x] Créer ou compléter `src/lib/validations/candidate.ts` : schéma Zod pour la création (firstName, lastName requis ; email, phone, linkedinUrl, title, city optionnels). [Source: docs/architecture/coding-standards.md §3]
  - [x] Email : `z.string().email()` si fourni ; message conforme PRD si besoin. [Source: PRD AC 4]
  - [x] LinkedIn : format `linkedin.com/in/...` si fourni (regex ou `z.string().url()` + refine). [Source: PRD AC 5]
  - [x] Téléphone : format flexible (français : 06..., +33, espaces/tirets acceptés). [Source: PRD AC 6]
  - [x] Ajouter `create` dans `src/server/trpc/routers/candidate.ts` : protectedProcedure, input = schéma create, mutation qui crée le candidat avec `companyId: ctx.companyId`, retourne le candidat créé (au moins id pour redirection). [Source: docs/architecture.md §9, docs/architecture/coding-standards.md §3.1]
- [x] Task 2 (AC: 1, 7, 9, 10): Formulaire de création
  - [x] Ouvrir le formulaire depuis « Nouveau candidat » : page dédiée `/candidates/new` ou modal depuis la liste. [Source: PRD AC 1]
  - [x] Champs : firstName*, lastName*, email, phone, linkedinUrl, title, city. Champs requis marqués (astérisque). [Source: PRD AC 2, 3]
  - [x] React Hook Form + résolver Zod (réutiliser le schéma de validation). [Source: docs/frontend-architecture.md §6]
  - [x] À la soumission : `trpc.candidate.create.useMutation()` ; en cas de succès, rediriger vers `/candidates/[id]` (detail page). [Source: PRD AC 7, 8]
  - [x] État de chargement pendant la soumission (bouton désactivé ou spinner). [Source: PRD AC 9]
  - [x] Bouton Annuler : retour à `/candidates` sans sauvegarder. [Source: PRD AC 10]
- [x] Task 3 (AC: 8): Association au cabinet
  - [x] S’assurer que la mutation create utilise uniquement `ctx.companyId` (pas d’input companyId) ; le candidat est toujours créé pour le cabinet de l’utilisateur connecté. [Source: PRD AC 8, docs/architecture/coding-standards.md §5.1]
- [x] Task 4 – Testing (AC: 2–8): Vérification
  - [x] Unit : schéma Zod rejette email invalide, linkedin invalide ; accepte téléphone flexible. [Source: docs/architecture.md §14]
  - [x] Intégration : créer un candidat via `candidate.create` avec ctx mocké ; vérifier présence en base avec le bon companyId. [Source: docs/architecture/coding-standards.md §6]
- [x] Task 5 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/2.2-test-cases.md` ou `docs/qa/cases/2.2-create-candidate-test-cases.md`) pour faciliter la review de la story.
- [x] Task 6 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.1 : Router `candidate` avec `list` ; page `/candidates` et bouton « Nouveau candidat » ; page détail `/candidates/[id]` (existante ou placeholder). Le bouton doit ouvrir ce formulaire de création. [Source: docs/stories/2.1, codebase]
- Validations candidate : `candidateListInputSchema` existe déjà ; ajouter un schéma `createCandidateSchema` (ou équivalent) pour la création. [Source: src/lib/validations/candidate.ts]

### Data Models

- **Candidate** : id, firstName, lastName, email, phone, linkedinUrl, title, city, summary, photoUrl, cvUrl, companyId, createdAt, updatedAt. Pour la création (2.2) : pas de photo ni CV ; summary optionnel. [Source: prisma/schema.prisma]

### API Specifications

- **candidate.create** : protectedProcedure. Input : { firstName, lastName, email?, phone?, linkedinUrl?, title?, city? }. Validation Zod côté serveur. Création avec companyId = ctx.companyId. Retour : candidat créé (au moins id). [Source: docs/architecture.md §9]

### Component Specifications

- Formulaire : champs shadcn (Input, Label) ; boutons Annuler (secondary/outline) et Enregistrer (primary terracotta). [Source: docs/design-system.md §2]
- Messages d’erreur : afficher les erreurs de validation (champ par champ ou résumé) sans exposer de détail technique. [Source: docs/architecture/coding-standards.md §5.1]

### File Locations

| Purpose                   | Path                                                           |
| ------------------------- | -------------------------------------------------------------- |
| Page création (si dédiée) | src/app/(dashboard)/candidates/new/page.tsx                    |
| Ou modal                  | Composant dans src/components/candidates/ ou inline dans liste |
| Router candidate          | src/server/trpc/routers/candidate.ts                           |
| Validations               | src/lib/validations/candidate.ts                               |

[Source: docs/architecture.md §6, docs/architecture/source-tree.md]

### Technical Constraints

- **companyId** : toujours dérivé de ctx dans create ; jamais fourni par le client. [Source: docs/architecture/coding-standards.md §5.1]
- **Storage** : pas d’upload photo dans cette story (Story 2.3). [Source: PRD 2.3]

### Testing

- Unit : schémas Zod (email, linkedin, phone). [Source: docs/architecture.md §14]
- Intégration : create avec contexte mocké ; vérifier companyId et champs en base. [Source: docs/architecture/coding-standards.md §6]

### Project Structure Notes

- Pas de conflit avec la structure existante. Référence architecture §8 pour le path Storage (utilisé en 2.3 pour la photo). [Source: docs/prd.md Story 2.2 réf.]

---

## Change Log

| Date       | Version | Description                                                    | Author      |
| ---------- | ------- | -------------------------------------------------------------- | ----------- |
| 2026-02-15 | 0.1     | Story draft created (2.2 Create Candidate - Basic Information) | Bob (SM)    |
| 2026-02-15 | 0.2     | Implementation complete; status Ready for Review               | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

_(Record the specific AI agent model and version used for development.)_

### Debug Log References

_(None.)_

### Completion Notes List

- Schéma `createCandidateSchema` dans `src/lib/validations/candidate.ts` avec validation email (si fourni), LinkedIn (linkedin.com/in/...), téléphone flexible (≥10 chiffres).
- Procédure `candidate.create` dans `src/server/trpc/routers/candidate.ts` : protectedProcedure, companyId uniquement depuis `ctx.companyId`.
- Page dédiée `/candidates/new` avec formulaire React Hook Form + zodResolver(createCandidateSchema), redirection vers `/candidates/[id]` après succès, bouton Annuler → `/candidates`, état de chargement sur le bouton Enregistrer.
- Tests unitaires : `tests/unit/validations/candidate.test.ts`. Tests d’intégration : `tests/integration/candidate/candidate.test.ts` (create avec companyId, UNAUTHORIZED).
- Cas de test QA : `docs/stories/cases/2.2-test-cases.md`. Lint et typecheck OK. Exécution des tests (vitest) à lancer en local (accès .env requis).

### File List

| Fichier                                                  | Action                                     |
| -------------------------------------------------------- | ------------------------------------------ |
| `src/lib/validations/candidate.ts`                       | Modified                                   |
| `src/server/trpc/routers/candidate.ts`                   | Modified                                   |
| `src/app/(dashboard)/candidates/new/page.tsx`            | Created                                    |
| `tests/unit/validations/candidate.test.ts`               | Created                                    |
| `tests/integration/candidate/candidate.test.ts`          | Modified                                   |
| `docs/stories/cases/2.2-test-cases.md`                   | Created                                    |
| `docs/stories/2.2.create-candidate-basic-information.md` | Modified (Dev Agent Record, Status, Tasks) |

---

## QA Results

_(Results from QA Agent review of the completed story implementation.)_
