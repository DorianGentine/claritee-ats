# Story 2.6: Candidate Experiences (CRUD)

## Status

Ready for Review

## Story

**As a** recruiter,  
**I want** to add, edit, and remove professional experiences on a candidate profile,  
**so that** I can document their career history.

## Acceptance Criteria

1. Experiences section on candidate detail page
2. "Ajouter une expérience" button
3. Experience form fields: title*, company*, startDate*, endDate (optional = current), description
4. Date picker for start/end dates (month + year)
5. "Poste actuel" checkbox auto-clears endDate
6. Plain text for description (textarea)
7. Experiences displayed in reverse chronological order
8. Edit button on each experience opens edit form
9. Delete button with confirmation
10. Empty state: "Aucune expérience ajoutée"

## Tasks / Subtasks

- [x] Task 1 (AC: 7): API – Procedures et ordre d’affichage
  - [x] Créer schémas Zod pour expérience : `title` (string min 1), `company` (string min 1), `startDate` (date), `endDate` (date optionnelle), `description` (string optionnelle). Dates au format mois/année côté UI, stockées en DateTime (ex. premier jour du mois). [Source: docs/architecture/coding-standards.md §3]
  - [x] Ajouter procedures tRPC dans le router `candidate` : `addExperience`, `updateExperience`, `deleteExperience`. Inputs : candidateId + payload ; vérifier que le candidat appartient au cabinet avant toute opération ; pour delete, vérifier que l’expérience appartient au candidat. [Source: docs/architecture.md §9, docs/architecture.md §4 – accès Experience via Candidate]
  - [x] Lors de la création, attribuer un `order` cohérent (ex. 0 pour la plus récente) ou trier côté API. S’assurer que `getById` retourne les expériences en ordre chronologique inverse (orderBy startDate desc ; endDate null = poste actuel, affiché en premier ou selon convention). [Source: PRD AC 7, prisma/schema.prisma – champ order]
- [x] Task 2 (AC: 1, 2, 3, 4, 5, 6): UI – Formulaire d’ajout d’expérience
  - [x] Sur la page détail candidat, section Expériences (colonne droite) : bouton « Ajouter une expérience » ouvrant un formulaire (modal ou panneau). [Source: docs/stories/2.4, CandidateDetailContent]
  - [x] Champs : titre*, entreprise*, date de début* (mois + année), date de fin (optionnelle), case « Poste actuel » qui vide et désactive la date de fin ; description (textarea, texte brut). [Source: PRD AC 3, AC 5, AC 6]
  - [x] Sélecteur de date mois/année (date picker ou deux selects mois + année). [Source: PRD AC 4]
  - [x] Validation côté client (React Hook Form + Zod) et envoi via `candidate.addExperience` ; invalidation de `getById` après succès. [Source: docs/frontend-architecture.md §6]
- [x] Task 3 (AC: 8, 9): UI – Édition et suppression
  - [x] Sur chaque expérience affichée : bouton « Modifier » ouvrant le formulaire pré-rempli ; sauvegarde via `candidate.updateExperience`. [Source: PRD AC 8]
  - [x] Bouton « Supprimer » avec confirmation (modal ou ConfirmDialog) ; à la confirmation, appeler `candidate.deleteExperience` puis invalider les données. [Source: PRD AC 9, docs/stories/2.4 – pattern ConfirmDialog]
- [x] Task 4 (AC: 10): Empty state et liste
  - [x] Conserver l’état vide « Aucune expérience ajoutée » lorsque la liste est vide. [Source: PRD AC 10, CandidateDetailContent]
  - [x] Afficher la liste des expériences en ordre chronologique inverse (déjà garanti par l’API ou tri côté client si besoin). [Source: PRD AC 7]
- [x] Task 5 – Validation et erreurs
  - [x] Côté tRPC : réutiliser les schémas Zod ; message générique en cas d’erreur (ex. « [Nom du champ] est requis »). [Source: docs/architecture/coding-standards.md §5.1]
- [x] Task 6 – Testing (AC: 1–9)
  - [x] Intégration : addExperience, updateExperience, deleteExperience avec candidat du cabinet ; refus si candidat ou expérience d’un autre cabinet (NOT_FOUND). [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
  - [x] Manuel : ajout, édition, suppression, poste actuel, date picker, empty state. [Source: docs/architecture/coding-standards.md §6]
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/2.6-test-cases.md` ou `docs/qa/cases/2.6-candidate-experiences-test-cases.md`) pour faciliter la review de la story.
- [ ] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.4–2.5 : Page détail candidat avec layout CV ; `getById` retourne déjà `experiences` (orderBy order asc). Composant `CandidateDetailContent` affiche expériences et formations en lecture seule avec empty state « Aucune expérience ». [Source: docs/stories/2.4, 2.5, src/components/candidates/CandidateDetailContent.tsx]
- Router candidate : list, getById, create, update, delete, uploadPhoto, addLanguage, removeLanguage. Aucune procedure dédiée aux expériences ; à ajouter : addExperience, updateExperience, deleteExperience. [Source: codebase, docs/architecture.md §9]

### Data Models

- **Experience** (Prisma) : `id`, `candidateId`, `title`, `company`, `startDate` (DateTime), `endDate` (DateTime?), `description` (String? @db.Text), `order` (Int default 0). Accès uniquement via Candidate (pas de companyId) ; isolation par vérification que le candidat appartient au cabinet. [Source: prisma/schema.prisma, docs/architecture.md §4]
- Affichage : ordre chronologique inverse = par startDate décroissant ; endDate null = « poste actuel » (affiché comme « Aujourd’hui »). [Source: PRD AC 7, CandidateDetailContent]

### API Specifications

- **candidate.addExperience** : protectedProcedure, input `{ candidateId, title, company, startDate, endDate?, description? }` ; vérifier que le candidat appartient au cabinet ; créer Experience avec order calculé ou laissé à 0 (tri par startDate côté lecture). [Source: docs/architecture.md §9]
- **candidate.updateExperience** : protectedProcedure, input `{ candidateId, experienceId, title?, company?, startDate?, endDate?, description? }` ; vérifier candidat du cabinet et que l’expérience appartient à ce candidat ; update. [Source: docs/architecture.md §9]
- **candidate.deleteExperience** : protectedProcedure, input `{ candidateId, experienceId }` ; vérifier candidat du cabinet et expérience liée au candidat ; supprimer. [Source: docs/architecture.md §9]
- **getById** : s’assurer que les expériences sont retournées triées par startDate desc (ou conserver order et documenter la convention). [Source: PRD AC 7]

### Component Specifications

- Section Expériences dans la colonne droite du layout CV (déjà présente dans CandidateDetailContent). [Source: wireframes §3, docs/stories/2.4]
- Formulaire : champs requis indiqués, date picker mois/année, checkbox « Poste actuel », textarea description. [Source: PRD AC 3, AC 4, AC 5, AC 6]
- Modal ou Dialog shadcn pour formulaire ajout/édition ; ConfirmDialog pour suppression. [Source: docs/architecture/coding-standards.md §4, pattern 2.4]

### File Locations

| Purpose | Path |
|--------|------|
| Page détail candidat | src/app/(dashboard)/candidates/[id]/page.tsx |
| Contenu détail (expériences / formations) | src/components/candidates/CandidateDetailContent.tsx |
| Router candidate | src/server/trpc/routers/candidate.ts |
| Validations | src/lib/validations/candidate.ts (étendre avec schémas experience) ou src/lib/validations/experience.ts |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- Toutes les procedures experience doivent vérifier que le candidat appartient au cabinet (ctx.companyId). [Source: docs/architecture/coding-standards.md §5.1]
- Tables sans companyId (Experience) : accès uniquement via procedures qui passent par Candidate. [Source: docs/architecture.md §4]
- Dates : stocker en DateTime ; UI mois/année peut envoyer le premier jour du mois pour startDate/endDate. [Source: PRD AC 4]

### Testing

- Intégration : addExperience, updateExperience, deleteExperience (succès, NOT_FOUND pour autre cabinet / expérience inexistante). [Source: docs/architecture.md §14]
- Fichier de cas de test : à rédiger dans docs/stories/cases/ ou docs/qa/ (Task 7). [Source: story-draft-tasks rule]

### Project Structure Notes

- Aucun conflit avec la structure existante. Réutilisation de CandidateDetailContent et du layout 2.4/2.5.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 0.1 | Story draft created (2.6 Candidate Experiences CRUD) | Bob (SM) |
| 2026-02-18 | 0.2 | Implementation: API (Zod, add/update/deleteExperience, getById order), UI (form dialog, edit/delete, empty state), tests, test cases doc | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

*(To be filled by the development agent.)*

### Debug Log References

*(None.)*

### Completion Notes List

- API : schémas Zod dans `src/lib/validations/candidate.ts` ; procedures `addExperience`, `updateExperience`, `deleteExperience` dans `candidate` router ; `getById` inclut les expériences avec `orderBy: { startDate: "desc" }`.
- UI : `ExperienceFormDialog` (formulaire avec mois/année, poste actuel, description) ; section Expériences dans `CandidateDetailContent` avec bouton Ajouter, Modifier, Supprimer (ConfirmDialog) ; empty state « Aucune expérience ajoutée ».
- Composant shadcn `Dialog` ajouté (`src/components/ui/dialog.tsx`) pour le modal formulaire.
- Tests d’intégration : `tests/integration/candidate/candidate.test.ts` (addExperience, updateExperience, deleteExperience, getById ordre).
- Cas de test : `docs/stories/cases/2.6-test-cases.md`.

### File List

| Fichier | Statut |
|---------|--------|
| src/lib/validations/candidate.ts | Modifié (schémas experience) |
| src/server/trpc/routers/candidate.ts | Modifié (add/update/deleteExperience, getById order) |
| src/components/ui/dialog.tsx | Nouveau |
| src/components/candidates/ExperienceFormDialog.tsx | Nouveau |
| src/components/candidates/CandidateDetailContent.tsx | Modifié (section Expériences, boutons, dialogs) |
| src/components/candidates/CandidateDetailView.tsx | Modifié (pass candidateId à Content) |
| tests/integration/candidate/candidate.test.ts | Modifié (tests experience) |
| docs/stories/cases/2.6-test-cases.md | Nouveau |
| package.json | Modifié (dependency @radix-ui/react-dialog) |

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
