# Story 3.5: Job Offer Tags

## Status

Draft

## Story

**As a** recruiter,  
**I want** to add tags to job offers,  
**so that** I can categorize and filter them.

## Acceptance Criteria

1. Tags section on offer detail page  
2. Same tag system as candidates (shared tag library per company)  
3. Add tag via autocomplete input  
4. Create new tag on-the-fly if not exists  
5. Remove tag by clicking X  
6. Tags displayed as colored badges  
7. Maximum 20 tags per offer  
8. Tags will be filterable in Epic 4  
9. Reuses Tag model from Story 2.8  
10. Tags displayed on offer list cards (max 3 visible, +N more)  

**Réf.** Design System §2 « Palette de tags » (couleurs auto-assignées, cycle hash % 8) ; wireframes §4 (tags sur carte offre) ; wireframes §5 Fiche Offre (section tags).

## Tasks / Subtasks

- [ ] Task 1 (AC: 2, 4, 7, 9): API – Procédures offer–tag
  - [ ] Vérifier le modèle Prisma : `Tag` (id, name, color, companyId), `OfferTag` (offerId, tagId) ; relation `JobOffer.tags` via OfferTag. Réutiliser le même modèle Tag et la même logique findOrCreate que Story 2.8. [Source: prisma/schema.prisma, docs/stories/2.8]
  - [ ] Dans le router `offer` : ajouter `offer.addTag` (protectedProcedure), input `{ offerId, tagName }`. Vérifier que l’offre appartient au cabinet (`companyId = ctx.companyId`). Si le tag n’existe pas pour le cabinet, le créer (name, color via hash % 8, companyId). Créer OfferTag. Si l’offre a déjà 20 tags, renvoyer erreur avec message « Maximum 20 tags par élément. Supprimez un tag existant pour en ajouter un nouveau. ». [Source: PRD Standard Error Messages, docs/architecture.md §4]
  - [ ] Ajouter `offer.removeTag` (protectedProcedure), input `{ offerId, tagId }`. Vérifier que l’offre appartient au cabinet et que le tag est bien associé à l’offre ; supprimer l’entrée OfferTag. [Source: docs/architecture.md §9]
  - [ ] S’assurer que `offer.getById` (ou équivalent) inclut les tags de l’offre (`include: { tags: { include: { tag: true } } }` ou `tags: { include: { tag: true } }`) pour alimenter la section tags sur la page détail. Créer `offer.getById` si absent. [Source: Story 3.4, 3.6]
  - [ ] Étendre `offer.list` pour inclure les tags sur chaque offre (relation tags avec tag id, name, color) afin d’afficher jusqu’à 3 tags sur les cartes liste (AC 10). [Source: docs/stories/3.3]

- [ ] Task 2 (AC: 1, 2, 3, 4, 5, 6, 7): UI – Section Tags sur la fiche offre
  - [ ] Créer un composant `OfferTagsSection` (ex. `src/components/offers/OfferTagsSection.tsx`) réutilisable pour la page détail offre. Props : `offerId`, données initiales des tags (liste des tags associés avec id, name, color). [Source: docs/frontend-architecture.md §4.2]
  - [ ] Section avec titre « Tags », input « Ajouter un tag » avec autocomplete alimenté par `tag.list` (même API que Story 2.8). Saisie libre autorisée pour créer un nouveau tag (AC 3, 4). [Source: docs/stories/2.8, CandidateTagsSection pattern]
  - [ ] Affichage des tags en badges colorés (backgroundColor, borderColor, color depuis tag.color — même style que candidats). Bouton X sur chaque badge pour retirer le tag ; appeler `offer.removeTag`. [Source: Design System §2, wireframes §5]
  - [ ] Côté client : désactiver ou masquer l’ajout si l’offre a déjà 20 tags ; afficher un message si limite atteinte (AC 7). [Source: PRD AC 7]
  - [ ] Intégrer ce composant sur la page détail offre (`/offers/[id]`). Si la page détail n’existe pas encore (Story 3.6), créer un squelette minimal pour cette story (titre de l’offre + section Tags) ou documenter que l’intégration se fera en 3.6 et fournir le composant prêt à l’emploi. [Source: docs/stories/3.6]

- [ ] Task 3 (AC: 10): Tags sur les cartes liste offres
  - [ ] Dans `JobOfferCard` (`src/components/offers/JobOfferCard.tsx`), afficher les tags de l’offre : au plus 3 badges visibles, puis « +N » si plus de 3 (ex. « +2 »). Réutiliser le même style de badge que sur la fiche (couleur depuis tag.color). [Source: wireframes §4, Design System palette tags]
  - [ ] S’assurer que les données passées à JobOfferCard incluent les tags (déjà prévu dans Task 1 via `offer.list`). [Source: src/app/(dashboard)/offers/page.tsx]

- [ ] Task 4 (AC: 8): Fondation filtres Epic 4
  - [ ] AC 8 (filtrage par tags en Epic 4) : s’assurer que le modèle OfferTag et les procédures offer.addTag/removeTag permettent d’implémenter ensuite le filtre par tagIds dans `offer.list` (Story 4.3). Aucun filtre à implémenter dans cette story. [Source: PRD Epic 4, Story 4.3]

- [ ] Task 5 – Validation et erreurs
  - [ ] Message « Maximum 20 tags par élément. Supprimez un tag existant pour en ajouter un nouveau. » en cas de dépassement (côté API et affichage côté client). [Source: docs/prd.md Standard Error Messages]

- [ ] Task 6 – Testing (AC: 1–10)
  - [ ] Tests d’intégration : `offer.addTag` (nouveau tag, tag existant, limite 20, offre d’un autre cabinet refusée), `offer.removeTag` (appartenance cabinet, tag non associé) ; `offer.getById` / `offer.list` retournent bien les tags. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
  - [ ] Tests unitaires : schémas Zod pour addTag/removeTag si dédiés. [Source: coding-standards §6]
  - [ ] (Optionnel) Test de composant pour `OfferTagsSection` ou rendu des tags dans `JobOfferCard` (affichage max 3 + « +N »). [Source: tests/unit/components/offers/JobOfferCard.test.tsx]

- [ ] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/3.5-test-cases.md`) pour faciliter la review de la story.

- [ ] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Dependencies & Previous Stories

- **Story 2.8 DONE** : système de tags pour les candidats (Tag, CandidateTag, tag.list, candidate.addTag, candidate.removeTag, findOrCreate tag, max 20, palette couleurs). Réutiliser le même router `tag` (tag.list) et la même logique d’assignation de couleur (hash % 8). [Source: docs/stories/2.8, src/server/trpc/routers/tag.ts]
- **Story 3.3 DONE** : page `/offers`, `JobOfferCard`, `offer.list`. Les cartes n’affichent pas encore les tags ; il faudra étendre le select de `offer.list` et le composant JobOfferCard. [Source: docs/stories/3.3]
- **Story 3.4 DONE** : router offer (list, getById, create, update, delete). S’assurer que `offer.getById` existe et qu’il peut inclure les tags pour la fiche offre. [Source: docs/stories/3.4]
- **Story 3.6** (Fiche Offre) : la page détail `/offers/[id]` contiendra la section Tags via le composant `OfferTagsSection` livré dans cette story. Si 3.6 n’est pas encore implémentée, livrer le composant et une page squelette ou documenter l’intégration. [Source: docs/prd.md Story 3.6]

### Data Models

- **Tag** : id, name, color, companyId ; @@unique([name, companyId]). Partagé entre candidats et offres. [Source: prisma/schema.prisma]
- **OfferTag** : offerId, tagId ; table de liaison N-N entre JobOffer et Tag. [Source: prisma/schema.prisma]
- **JobOffer** : relation `tags OfferTag[]`. [Source: prisma/schema.prisma]
- Palette tags : 8 couleurs (Design System), assignation `colorIndex = hash(tagName) % 8`. [Source: docs/design-system.md §2]

### API Specifications

- **offer.addTag** : input `{ offerId: string, tagName: string }`. Vérifier offer.companyId = ctx.companyId. FindOrCreate Tag (companyId, color via hash). Créer OfferTag. Vérifier count des tags de l’offre ≤ 20. Retourner l’offre mise à jour avec ses tags (ou le tag ajouté). [Source: docs/architecture.md §9]
- **offer.removeTag** : input `{ offerId: string, tagId: string }`. Vérifier appartenance offre au cabinet et existence de la liaison OfferTag ; supprimer OfferTag. [Source: idem]
- **offer.getById** : si pas encore présent, créer ; inclure `tags: { include: { tag: true } }` pour afficher les tags sur la fiche. [Source: Story 3.4, 3.6]
- **offer.list** : étendre le select pour inclure `tags: { include: { tag: { select: { id, name, color } } } }` (ou équivalent) afin d’afficher jusqu’à 3 tags sur chaque carte. [Source: docs/stories/3.3]

### UI & Components

- **OfferTagsSection** : même pattern que CandidateTagsSection (Story 2.8) — input autocomplete, badges avec X, max 20. [Source: src/components/candidates/CandidateTagsSection ou CandidateDetailSidebar]
- **JobOfferCard** : afficher jusqu’à 3 tags en badges, puis « +N » (ex. « +2 ») si plus de 3. Style cohérent avec le Design System (couleurs tags). [Source: wireframes §4]
- Page détail offre : soit créée en squelette dans cette story (titre + OfferTagsSection), soit intégration reportée à 3.6 avec composant livré prêt. [Source: docs/stories/3.6]

### Testing

- Intégration : isolation multi-tenant (addTag/removeTag uniquement pour les offres du cabinet), limite 20, findOrCreate tag. [Source: docs/architecture.md §4]
- Unit : validations des inputs (offerId, tagId, tagName). [Source: docs/architecture/coding-standards.md §6]
- Composant : OfferTagsSection ou JobOfferCard avec tags (optionnel). [Source: tests/unit/components/offers/JobOfferCard.test.tsx]

### File Locations

| Purpose | Path |
|---------|------|
| Router offer (étendre) | src/server/trpc/routers/offer.ts |
| Router tag (réutiliser) | src/server/trpc/routers/tag.ts |
| Section Tags offre | src/components/offers/OfferTagsSection.tsx |
| Carte offre (étendre) | src/components/offers/JobOfferCard.tsx |
| Page détail offre (squelette ou 3.6) | src/app/(dashboard)/offers/[id]/page.tsx |

[Source: docs/architecture/source-tree.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story draft created (3.5 Job Offer Tags) | Bob (SM) |

---

## Dev Agent Record

*(This section is populated by the development agent during implementation.)*

### Agent Model Used

<!-- Example: "GPT-5.1 via Cursor" -->

### Debug Log References

*(Aucune)*

### Completion Notes List

- (À compléter par l’agent de développement lors de l’implémentation de la story.)

### File List

| Path | Action |
|------|--------|
| src/server/trpc/routers/offer.ts | modified |
| src/components/offers/OfferTagsSection.tsx | created |
| src/components/offers/JobOfferCard.tsx | modified |
| src/app/(dashboard)/offers/[id]/page.tsx | created or modified |
| tests/integration/offer/offer.test.ts | modified |
| docs/stories/cases/3.5-test-cases.md | created |

---

## QA Results

*(Results from QA Agent QA review of the completed story implementation.)*
