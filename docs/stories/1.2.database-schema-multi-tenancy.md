# Story 1.2: Database Schema & Multi-tenancy Foundation

## Status

DONE

## Story

**As a** developer,  
**I want** the core database schema with multi-tenancy support,  
**so that** each cabinet's data is properly isolated.

## Acceptance Criteria

1. Prisma schema defines `Company` model (id, name, siren, createdAt, updatedAt)
2. Prisma schema defines `User` model (id, email, firstName, lastName, companyId, createdAt, updatedAt)
3. Prisma schema defines `Invitation` model (id, email, companyId, token, expiresAt, usedAt)
4. SIREN field has unique constraint on Company
5. Foreign key relationship User → Company established
6. Supabase Row Level Security (RLS) policies configured for Company isolation
7. Database migrations created and applied successfully
8. Seed script available for development data

## Tasks / Subtasks

- [x] Task 1 (AC: 1, 4, 5): Ensure Prisma schema defines Company, User, Invitation
  - [x] Company: id (uuid), name, siren (unique), createdAt, updatedAt. [Source: docs/architecture.md §5, prisma/schema.prisma]
  - [x] User: id (Supabase Auth uid, no auto-default), email (unique), firstName, lastName, companyId, createdAt, updatedAt. No password column (auth via Supabase Auth). [Source: docs/architecture.md §7, docs/architecture/coding-standards.md §3]
  - [x] Invitation: id (uuid), email, companyId, token (unique), expiresAt, usedAt (nullable). [Source: docs/architecture.md §5, prisma/schema.prisma]
  - [x] User → Company FK with onDelete: Cascade; Invitation → Company FK. [Source: docs/architecture.md §4.1, prisma/schema.prisma]
- [x] Task 2 (AC: 6): Add RLS migration for Company, User, Invitation
  - [x] Create migration that enables RLS on Company, User, Invitation and adds policies from docs/architecture/rls-policies.sql (company_select_own, company_update_own; user_select_same_company, user_update_self; invitation_select, invitation_insert, invitation_update, invitation_delete). [Source: docs/architecture.md §4.3, docs/architecture/rls-policies.sql]
  - [x] Store migration in prisma/migrations/ (e.g. timestamped folder); reference doc: docs/architecture.md §4.3 (executed version in migrations). [Source: docs/architecture/source-tree.md]
- [x] Task 3 (AC: 7): Create and apply migrations
  - [x] Run `prisma migrate dev` (or deploy for CI) so migrations apply successfully. [Source: docs/architecture/tech-stack.md]
  - [x] Ensure Prisma Client regenerates after schema/migration changes. [Source: docs/architecture.md §6]
- [x] Task 4 (AC: 8): Implement seed script
  - [x] Implement prisma/seed.ts: create at least one Company, one User (id can be a placeholder UUID for dev; in production id = auth.uid()), and optionally one Invitation. [Source: docs/architecture.md §6, docs/architecture.md §14]
  - [x] Document or use `prisma db seed` in package.json so `npx prisma db seed` runs the script. [Source: docs/architecture/source-tree.md]
- [x] Task 5 – tRPC context (foundation for Stories 1.3+): Resolve companyId from User
  - [x] In src/server/trpc/context.ts: given Supabase auth user, load User row by id and set companyId on context. [Source: docs/architecture.md §7.2, docs/stories/1.1 completion notes]
  - [x] Expose protectedProcedure that throws UNAUTHORIZED if !ctx.companyId. [Source: docs/architecture.md §7.2, docs/architecture/coding-standards.md §3]
- [x] Task 6 – Testing (AC: 6, 7, 8): Verify schema and isolation
  - [x] Unit or integration test: after seed, Company/User/Invitation exist and User.companyId matches Company.id. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
  - [x] test that RLS is enabled (e.g. query as different role or assert migration content). [Source: docs/architecture/coding-standards.md §6]

## Dev Notes

### Previous Story Insights

- Story 1.1: Prisma 7 uses prisma.config.ts for datasource URL; dotenv loads .env.local. [Source: docs/stories/1.1.project-setup-infrastructure.md Dev Agent Record]
- tRPC context is still a skeleton; auth and companyId resolution are deferred to this story (1.2). [Source: docs/stories/1.1.project-setup-infrastructure.md Completion Notes]
- Prisma schema may already exist in full (16 entities); this story focuses on Company, User, Invitation and RLS for those three. [Source: existing codebase]

### Data Models

- **Company:** id (uuid), name, siren (unique, 9 digits), createdAt, updatedAt. Tenant root; no companyId. [Source: docs/architecture.md §5, prisma/schema.prisma]
- **User:** id = Supabase Auth uid (no password column in DB; auth via Supabase Auth only). email (unique), firstName, lastName, companyId (FK → Company), createdAt, updatedAt. [Source: docs/architecture.md §5, §7, docs/architecture/coding-standards.md §3]
- **Invitation:** id (uuid), email, companyId (FK → Company), token (unique), expiresAt, usedAt (nullable). Used for collaborator invite flow (Story 1.5). [Source: docs/architecture.md §5, §7.3, prisma/schema.prisma]

### API Specifications

- No new API endpoints in this story. tRPC context is extended so that later stories can use protectedProcedure and ctx.companyId. [Source: docs/architecture.md §7.2]

### File Locations

| Purpose                       | Path                                                                               |
| ----------------------------- | ---------------------------------------------------------------------------------- |
| Prisma schema                 | prisma/schema.prisma                                                               |
| Migrations                    | prisma/migrations/                                                                 |
| RLS migration                 | prisma/migrations/<timestamp>\_add_rls_policies/migration.sql (or equivalent name) |
| Seed script                   | prisma/seed.ts                                                                     |
| tRPC context                  | src/server/trpc/context.ts                                                         |
| tRPC procedures               | src/server/trpc/trpc.ts                                                            |
| RLS reference (documentation) | docs/architecture/rls-policies.sql                                                 |

[Source: docs/architecture.md §6, §4.3, docs/architecture/source-tree.md]

### Technical Constraints

- **RLS:** Policies for Company, User, Invitation must match docs/architecture/rls-policies.sql. Company: SELECT/UPDATE for users of that company. User: SELECT same company, UPDATE self. Invitation: SELECT/INSERT/UPDATE/DELETE by company. [Source: docs/architecture.md §4.3, docs/architecture/rls-policies.sql]
- **INSERT Company/User:** Done by the app during registration (Story 1.3) or invite acceptance; use service role or secure path (RLS may block direct INSERT by normal role). [Source: docs/architecture/rls-policies.sql comments]
- **Migrations:** Applied via `prisma migrate`; no manual SQL in Supabase dashboard required. [Source: docs/architecture.md §4.3]
- **User.id:** Must match Supabase Auth uid; seed can use placeholder UUID for local dev only. [Source: docs/architecture.md §7]

### Testing

- **Unit/integration:** Vitest. Test seed output (Company, User, Invitation present; User.companyId correct). Optional: assert RLS migration exists and enables RLS on the three tables. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
- **Test location:** tests/unit/ or tests/integration/ (e.g. prisma/seed or context). [Source: docs/architecture/source-tree.md]
- **Fixtures:** Seed or tests/fixtures/ for Company, User; do not rely on ad-hoc manual DB state. [Source: docs/architecture.md §14]

### Project Structure Notes

Aligns with docs/architecture.md §6 and docs/architecture/source-tree.md. RLS reference is docs/architecture/rls-policies.sql; executed version lives in prisma/migrations/. No structural conflicts.

---

## Change Log

| Date       | Version | Description                                                                                          | Author      |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-14 | 0.1     | Story draft created (1.2 Database Schema & Multi-tenancy Foundation)                                 | Bob (SM)    |
| 2026-02-14 | 0.2     | Story implemented: Prisma schema, init+RLS migrations, seed, tRPC context, protectedProcedure, tests | James (Dev) |
| 2026-02-14 | 0.3     | Post-impl: DIRECT_DATABASE_URL, initShadowDb (auth stub), cast RLS ::uuid, troubleshooting doc       | James (Dev) |

---

## Dev Agent Record

_(To be filled by the development agent during implementation.)_

### Agent Model Used

James (Dev agent). Model: as per Cursor session.

### Debug Log References

None.

### Completion Notes List

- Prisma schema: Company, User, Invitation already defined; init migration (20260214000000_init) created for full schema; RLS migration (20300101000000_add_rls_policies) pre-existing.
- Prisma 7.4.0 requires @prisma/adapter-pg for PostgreSQL; db.ts and seed.ts use PrismaPg adapter with DATABASE_URL.
- tRPC context: Supabase auth via createClient(); User row loaded by id to resolve companyId; protectedProcedure throws UNAUTHORIZED if !ctx.companyId.
- Seed: prisma.config.ts migrations.seed; db:seed script in package.json; `npx prisma db seed` runs tsx prisma/seed.ts.
- Migrations: run `npx prisma migrate deploy` (CI) or `npx prisma migrate dev` (local). Seed runs after migrations applied.

### Post-implementation: Troubleshooting & Configuration

Résumé des échanges post-implémentation pour faciliter les futurs déploiements :

1. **Ordre migrate → seed**  
   Erreur « table Company does not exist » lors du seed : exécuter d’abord `npx prisma migrate deploy` (ou `migrate dev`), puis `npx prisma db seed`.

2. **DIRECT_DATABASE_URL pour migrate dev**  
   Le pooler Supabase (port 6543) ne convient pas pour `migrate dev` (shadow DB, DDL).
   - Ajouter `DIRECT_DATABASE_URL` dans `.env.local` avec la connexion directe (port 5432, hôte `db.xxx.supabase.co`).
   - `prisma.config.ts` utilise `DIRECT_DATABASE_URL` pour `url` si défini, sinon `DATABASE_URL`.
   - Prisma 7 n’a plus `directUrl` : on utilise `url` avec la bonne variable d’environnement.

3. **P1001 Can't reach database**  
   Causes fréquentes : VPN actif, projet Supabase en pause (free tier), ou réseau sans IPv6 (connexion directe Supabase peut passer par IPv6).

4. **P3006 schema "auth" does not exist (shadow DB)**  
   La shadow DB n’a pas le schéma Supabase.
   - Dans `prisma.config.ts` : `migrations.initShadowDb` crée un stub `auth` + `auth.uid()`.
   - Nécessite `experimental.externalTables: true`.

5. **P3006 operator text = uuid**  
   `User.id` et `authorId` sont TEXT (Prisma String), `auth.uid()` retourne UUID.
   - Correction : caster les colonnes (`"id"::uuid = auth.uid()`, `"authorId"::uuid = auth.uid()`), pas `auth.uid()`.

6. **Sécurité RLS**  
   `auth.uid()` n’est pas une entrée utilisateur : valeur lue dans le JWT par Supabase. Pas de faille liée au cast ; le client ne peut pas forger ou modifier `auth.uid()`.

**Fichiers modifiés lors de ces corrections :** prisma.config.ts (DIRECT_DATABASE_URL, initShadowDb, experimental.externalTables), prisma/migrations/20300101000000_add_rls_policies/migration.sql (cast `::uuid` sur id et authorId).

### File List

**Created:** prisma/migrations/20260214000000_init/migration.sql, prisma/seed.ts, src/server/db.ts, tests/unit/prisma/rls-migration.test.ts, tests/integration/prisma/seed.test.ts.

**Modified:** src/server/trpc/context.ts, src/server/trpc/trpc.ts, prisma.config.ts, package.json, prisma/migrations/20300101000000_add_rls_policies/migration.sql, docs/stories/1.2.database-schema-multi-tenancy.md.

---

## QA Results

_(Results from QA Agent review of the completed story implementation.)_
