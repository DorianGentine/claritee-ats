# Story 1.2: Database Schema & Multi-tenancy Foundation

## Status

READY

## Story

**As a** developer,  
**I want** the core database schema with multi-tenancy support,  
**so that** each cabinet's data is properly isolated.

## Acceptance Criteria

1. Prisma schema defines `Company` model (id, name, siren, createdAt, updatedAt)
2. Prisma schema defines `User` model (id, email, firstName, lastName, companyId, createdAt, updatedAt)
3. Prisma schema defines `Invitation` model (id, email, companyId, token, expiresAt, usedAt)
4. SIREN field has unique constraint on Company
5. Foreign key relationship User → Company established
6. Supabase Row Level Security (RLS) policies configured for Company isolation
7. Database migrations created and applied successfully
8. Seed script available for development data

## Tasks / Subtasks

- [ ] Task 1 (AC: 1, 4, 5): Ensure Prisma schema defines Company, User, Invitation
  - [ ] Company: id (uuid), name, siren (unique), createdAt, updatedAt. [Source: docs/architecture.md §5, prisma/schema.prisma]
  - [ ] User: id (Supabase Auth uid, no auto-default), email (unique), firstName, lastName, companyId, createdAt, updatedAt. No password column (auth via Supabase Auth). [Source: docs/architecture.md §7, docs/architecture/coding-standards.md §3]
  - [ ] Invitation: id (uuid), email, companyId, token (unique), expiresAt, usedAt (nullable). [Source: docs/architecture.md §5, prisma/schema.prisma]
  - [ ] User → Company FK with onDelete: Cascade; Invitation → Company FK. [Source: docs/architecture.md §4.1, prisma/schema.prisma]
- [ ] Task 2 (AC: 6): Add RLS migration for Company, User, Invitation
  - [ ] Create migration that enables RLS on Company, User, Invitation and adds policies from docs/architecture/rls-policies.sql (company_select_own, company_update_own; user_select_same_company, user_update_self; invitation_select, invitation_insert, invitation_update, invitation_delete). [Source: docs/architecture.md §4.3, docs/architecture/rls-policies.sql]
  - [ ] Store migration in prisma/migrations/ (e.g. timestamped folder); reference doc: docs/architecture.md §4.3 (executed version in migrations). [Source: docs/architecture/source-tree.md]
- [ ] Task 3 (AC: 7): Create and apply migrations
  - [ ] Run `prisma migrate dev` (or deploy for CI) so migrations apply successfully. [Source: docs/architecture/tech-stack.md]
  - [ ] Ensure Prisma Client regenerates after schema/migration changes. [Source: docs/architecture.md §6]
- [ ] Task 4 (AC: 8): Implement seed script
  - [ ] Implement prisma/seed.ts: create at least one Company, one User (id can be a placeholder UUID for dev; in production id = auth.uid()), and optionally one Invitation. [Source: docs/architecture.md §6, docs/architecture.md §14]
  - [ ] Document or use `prisma db seed` in package.json so `npx prisma db seed` runs the script. [Source: docs/architecture/source-tree.md]
- [ ] Task 5 – tRPC context (foundation for Stories 1.3+): Resolve companyId from User
  - [ ] In src/server/trpc/context.ts: given Supabase auth user, load User row by id and set companyId on context. [Source: docs/architecture.md §7.2, docs/stories/1.1 completion notes]
  - [ ] Expose protectedProcedure that throws UNAUTHORIZED if !ctx.companyId. [Source: docs/architecture.md §7.2, docs/architecture/coding-standards.md §3]
- [ ] Task 6 – Testing (AC: 6, 7, 8): Verify schema and isolation
  - [ ] Unit or integration test: after seed, Company/User/Invitation exist and User.companyId matches Company.id. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
  - [ ] test that RLS is enabled (e.g. query as different role or assert migration content). [Source: docs/architecture/coding-standards.md §6]

## Dev Notes

### Previous Story Insights

- Story 1.1: Prisma 7 uses prisma.config.ts for datasource URL; dotenv loads .env.local. [Source: docs/stories/1.1.project-setup-infrastructure.md Dev Agent Record]
- tRPC context is still a skeleton; auth and companyId resolution are deferred to this story (1.2). [Source: docs/stories/1.1.project-setup-infrastructure.md Completion Notes]
- Prisma schema may already exist in full (16 entities); this story focuses on Company, User, Invitation and RLS for those three. [Source: existing codebase]

### Data Models

- **Company:** id (uuid), name, siren (unique, 9 digits), createdAt, updatedAt. Tenant root; no companyId. [Source: docs/architecture.md §5, prisma/schema.prisma]
- **User:** id = Supabase Auth uid (no password column in DB; auth via Supabase Auth only). email (unique), firstName, lastName, companyId (FK → Company), createdAt, updatedAt. [Source: docs/architecture.md §5, §7, docs/architecture/coding-standards.md §3]
- **Invitation:** id (uuid), email, companyId (FK → Company), token (unique), expiresAt, usedAt (nullable). Used for collaborator invite flow (Story 1.5). [Source: docs/architecture.md §5, §7.3, prisma/schema.prisma]

### API Specifications

- No new API endpoints in this story. tRPC context is extended so that later stories can use protectedProcedure and ctx.companyId. [Source: docs/architecture.md §7.2]

### File Locations

| Purpose | Path |
|--------|------|
| Prisma schema | prisma/schema.prisma |
| Migrations | prisma/migrations/ |
| RLS migration | prisma/migrations/<timestamp>_add_rls_policies/migration.sql (or equivalent name) |
| Seed script | prisma/seed.ts |
| tRPC context | src/server/trpc/context.ts |
| tRPC procedures | src/server/trpc/trpc.ts |
| RLS reference (documentation) | docs/architecture/rls-policies.sql |

[Source: docs/architecture.md §6, §4.3, docs/architecture/source-tree.md]

### Technical Constraints

- **RLS:** Policies for Company, User, Invitation must match docs/architecture/rls-policies.sql. Company: SELECT/UPDATE for users of that company. User: SELECT same company, UPDATE self. Invitation: SELECT/INSERT/UPDATE/DELETE by company. [Source: docs/architecture.md §4.3, docs/architecture/rls-policies.sql]
- **INSERT Company/User:** Done by the app during registration (Story 1.3) or invite acceptance; use service role or secure path (RLS may block direct INSERT by normal role). [Source: docs/architecture/rls-policies.sql comments]
- **Migrations:** Applied via `prisma migrate`; no manual SQL in Supabase dashboard required. [Source: docs/architecture.md §4.3]
- **User.id:** Must match Supabase Auth uid; seed can use placeholder UUID for local dev only. [Source: docs/architecture.md §7]

### Testing

- **Unit/integration:** Vitest. Test seed output (Company, User, Invitation present; User.companyId correct). Optional: assert RLS migration exists and enables RLS on the three tables. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
- **Test location:** tests/unit/ or tests/integration/ (e.g. prisma/seed or context). [Source: docs/architecture/source-tree.md]
- **Fixtures:** Seed or tests/fixtures/ for Company, User; do not rely on ad-hoc manual DB state. [Source: docs/architecture.md §14]

### Project Structure Notes

Aligns with docs/architecture.md §6 and docs/architecture/source-tree.md. RLS reference is docs/architecture/rls-policies.sql; executed version lives in prisma/migrations/. No structural conflicts.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-14 | 0.1 | Story draft created (1.2 Database Schema & Multi-tenancy Foundation) | Bob (SM) |

---

## Dev Agent Record

*(To be filled by the development agent during implementation.)*

### Agent Model Used

*(Record the specific AI agent model and version used for development.)*

### Debug Log References

*(Reference any debug logs or traces generated during development.)*

### Completion Notes List

*(Notes about the completion of tasks and any issues encountered.)*

### File List

*(List all files created, modified, or affected during story implementation.)*

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
