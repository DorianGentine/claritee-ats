# Story 3.12: Page Mes notes

## Status

DONE

## Story

**As a** recruiter,  
**I want** a dedicated "Mes notes" page to view, organize, edit and classify my free-standing notes,  
**so that** I can manage my quick notes before moving them to candidates or offers.

## Acceptance Criteria

1. Page "Mes notes" accessible depuis le dropdown de la navbar et depuis le widget de notes (lien "Mes notes")
2. Liste des notes libres (sans candidat/offre) triées par dernière modification
3. Affichage : titre (ou 30 premiers caractères si absent), extrait du contenu, date de modification
4. Clic sur une note ouvre l'édition (inline ou panneau détail)
5. Édition : titre, contenu BlockNote ; sauvegarde explicite ou auto-save
6. Suppression avec confirmation
7. Possibilité de "déplacer" une note vers un candidat ou une offre (association candidateId/offerId) — permet de rebasculer les prises de notes
8. Empty state : "Aucune note"
9. Lien rapide pour ouvrir le widget depuis la page

## Tasks / Subtasks

- [x] Task 1: Route et page
  - [x] Créer `src/app/(dashboard)/notes/page.tsx`. [Source: docs/architecture/source-tree.md]
  - [x] Page protégée (layout dashboard). [Source: docs/frontend-architecture.md §2]
- [x] Task 2: API – listFree et déplacement
  - [x] `note.listFree` (déjà prévu en 3.11) : notes sans candidateId ni offerId. [Source: Story 3.11]
  - [x] `note.moveToCandidate` : input `{ id, candidateId }` ; met à jour candidateId ; vérifier auteur et companyId. [Source: prisma/schema.prisma]
  - [x] `note.moveToOffer` : input `{ id, offerId }` ; met à jour offerId. [Source: idem]
  - [x] Notes déplacées ne s'affichent plus dans "Mes notes" (listFree les exclut). [Source: logique métier]
- [x] Task 3: Liste des notes
  - [x] Afficher les notes via `note.listFree` ; carte ou ligne par note : titre (ou 30 premiers chars), extrait, date. [Source: wireframes à adapter]
  - [x] Clic ouvre panneau détail ou mode édition inline. [Source: AC 4]
- [x] Task 4: Édition
  - [x] Panneau ou modal avec champ titre + BlockNote ; bouton Enregistrer ou auto-save. [Source: AC 5]
  - [x] Suppression : ConfirmDialog. [Source: AC 6]
- [x] Task 5: Déplacer vers candidat/offre
  - [x] Bouton "Déplacer vers..." ou "Associer à" ; dropdown Candidat (candidate.list) et/ou Offre (offer.list si dispo). [Source: AC 7]
  - [x] Mutations moveToCandidate, moveToOffer ; invalidation listFree. [Source: Task 2]
- [x] Task 6: Navigation
  - [x] Ajouter "Mes notes" dans la navbar (SiteNavbar). [Source: AC 1]
  - [x] Le widget (Story 3.11) a déjà un lien vers /notes. [Source: Story 3.11]
  - [x] Bouton pour ouvrir le widget depuis la page. [Source: AC 9]
- [x] Task 7 – Testing
  - [x] Tests d'intégration : listFree, moveToCandidate, moveToOffer, update, delete. [Source: docs/architecture.md §14]
  - [x] Test manuel : liste, édition, déplacement, suppression.
- [x] Task 8 (QA): Rédiger les cas de test dans docs/stories/cases/3.12-test-cases.md.
- [x] Task 9 (review): Lancer une review de code en fin de développement avant clôture.

## Dev Notes

### Dependencies

- Story 3.11 doit être implémentée (widget, notes libres, champ titre, note.listFree).

### Data Models

- **Note** : id, title, content, authorId, candidateId (nullable), offerId (nullable), companyId. [Source: prisma/schema.prisma]

### API Specifications

- **note.listFree** : notes où candidateId IS NULL AND offerId IS NULL. [Source: Story 3.11]
- **note.moveToCandidate** : update candidateId ; note.moveToOffer : update offerId.

### File Locations

| Purpose | Path |
|---------|------|
| Page | src/app/(dashboard)/notes/page.tsx |
| Router note | src/server/trpc/routers/note.ts |
| Navbar | src/components/layout/SiteNavbar.tsx |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 0.1 | Story draft created (3.12 Mes notes) | Bob (SM) |
| 2026-02-23 | 0.2 | Implementation: page, API moveTo*, list, edit, delete, nav, tests | James (Dev) |

---

## Dev Agent Record

### File List (new or modified)

| File | Change |
|------|--------|
| src/app/(dashboard)/notes/page.tsx | Modified (full implementation) |
| src/server/trpc/routers/note.ts | Modified (moveToCandidate, moveToOffer) |
| src/components/layout/SiteNavbar.tsx | Modified (nav link "Mes notes") |
| src/components/layout/DashboardShell.tsx | Modified (NoteWidgetProvider) |
| src/components/layout/NoteChatWidget.tsx | Modified (use NoteWidget context for open state) |
| src/lib/note-widget-context.tsx | New |
| src/lib/note-utils.ts | Modified (getNoteExcerpt) |
| src/lib/trpc/client.ts | Modified (export RouterOutputs) |
| tests/integration/note/note.test.ts | Modified (moveToCandidate, moveToOffer tests) |
| docs/stories/cases/3.12-test-cases.md | New |

### Completion Notes

- Page "Mes notes" sous (dashboard), protégée par le layout.
- Liste via `note.listFree`, cartes avec titre (30 chars), extrait (getNoteExcerpt), date (formatDateLong).
- Clic sur une note ouvre un Dialog avec titre, BlockNote, Enregistrer, Supprimer (ConfirmDialog), et select "Déplacer vers" (candidate.list). Auto-save par debounce 2 s.
- moveToOffer implémenté en API ; pas de dropdown Offre dans l’UI (pas de offer.list dans le router actuel). Déplacer vers candidat uniquement en UI.
- Lien "Mes notes" ajouté dans la navbar (desktop + mobile). Bouton "Nouvelle note rapide" sur la page ouvre le widget via NoteWidgetProvider.
- Tests d’intégration : moveToCandidate (succès, NOT_FOUND autre company, FORBIDDEN non-auteur), moveToOffer (succès, NOT_FOUND autre company).
- Cas de test QA rédigés dans docs/stories/cases/3.12-test-cases.md.

---

## QA Results

*(To be filled by QA Agent)*
