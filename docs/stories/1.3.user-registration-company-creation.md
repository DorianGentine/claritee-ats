# Story 1.3: User Registration & Company Creation

## Status

IN QA

## Story

**As a** new user,  
**I want** to register with my information and create my company,  
**so that** I can start using the platform.

## Acceptance Criteria

1. Registration page with form: firstName, lastName, email, password, companyName, siren
2. Email format validation (client + server)
3. Password minimum requirements enforced (8+ chars)
4. SIREN format validation (9 digits)
5. SIREN uniqueness check with clear error message if already taken
6. Successful registration creates User + Company in single transaction
7. User automatically logged in after registration
8. Redirect to Dashboard after successful registration
9. Form shows loading state during submission
10. Error messages displayed clearly for all validation failures
11. Rate limiting on registration: max 10 requests per IP per minute; if exceeded, display « Trop de requêtes. Réessayez dans quelques minutes. »

## Tasks / Subtasks

- [x] Task 1 (AC: 1, 9): Create registration page and form shell
  - [x] Add route `src/app/(auth)/register/page.tsx` with form fields: firstName, lastName, email, password, companyName, siren. [Source: docs/architecture.md §6, docs/frontend-architecture.md §2]
  - [x] Use React Hook Form + Zod for client-side validation. [Source: docs/architecture/coding-standards.md §4, docs/frontend-architecture.md §3.2]
  - [x] Implement loading state during submission (disable submit, spinner or loading label). [Source: PRD Story 1.3 AC 9]
- [x] Task 2 (AC: 2, 3, 4): Define validation schemas (client + server)
  - [x] Create `src/lib/validations/auth.ts` (or `company.ts` for SIREN): email (format), password (min 8 chars), SIREN (exactly 9 digits string). [Source: docs/architecture/coding-standards.md §3, docs/architecture.md §9]
  - [x] Reuse same Zod schemas in form and in tRPC procedure. [Source: docs/architecture/coding-standards.md §3]
  - [x] Email format: use Zod `z.string().email()` or equivalent; message « Veuillez entrer une adresse email valide. » [Source: docs/prd.md Standard Error Messages]
  - [x] SIREN format: 9 digits only; message « Le SIREN doit contenir exactement 9 chiffres. » [Source: docs/prd.md Standard Error Messages]
- [x] Task 3 (AC: 5, 6, 7): Implement registration flow (Supabase Auth + Company + User)
  - [x] Flow: (1) Client calls Supabase `signUp({ email, password })` (and optional user_metadata for firstName, lastName, companyName, siren). (2) On success, client calls tRPC `auth.completeRegistration` (or equivalent) with companyName, siren, firstName, lastName; server reads session (auth.uid()), creates Company then User in a single Prisma transaction (User.id = auth.uid()). [Source: docs/architecture.md §7.1, §7.2]
  - [x] Alternatively: single server procedure that validates, checks SIREN unique, then uses Supabase Admin (service role) to create auth user, then creates Company + User in one transaction. Prefer the flow that matches existing codebase (context has session). [Source: docs/architecture.md §7.1]
  - [x] SIREN uniqueness: before creating Company, check `db.company.findUnique({ where: { siren } })`; if exists, return clear error. [Source: docs/prd.md Standard Error Messages]
  - [x] Error messages: « Ce numéro SIREN est déjà enregistré. Contactez votre administrateur si vous pensez qu'il s'agit d'une erreur. » ; « Un compte existe déjà avec cet email. » (Supabase returns for duplicate email). [Source: docs/prd.md Standard Error Messages]
  - [x] Client: after successful registration, user is logged in (Supabase session); redirect to `/dashboard`. [Source: AC 7, 8]
- [x] Task 4 (AC: 11): Apply rate limiting to registration
  - [x] In the tRPC procedure that handles registration (e.g. `auth.completeRegistration` or `auth.register`), get client IP from headers: `opts.ctx.headers.get("x-forwarded-for") ?? opts.ctx.headers.get("x-real-ip") ?? "unknown"`. [Source: docs/architecture/rate-limiting.md §3.1 Option B]
  - [x] Call `checkRateLimit("auth:" + ip, RATE_LIMITS.AUTH_PER_IP.limit, RATE_LIMITS.AUTH_PER_IP.windowMs)` before creating Company/User. [Source: src/lib/rate-limit.ts, docs/architecture/rate-limiting.md §3.1]
  - [x] If `!result.success`, throw `TRPCError({ code: "TOO_MANY_REQUESTS", message: "Trop de requêtes. Réessayez dans quelques minutes." })`. [Source: docs/architecture/rate-limiting.md §1, §3.1]
- [x] Task 5 (AC: 10): Display errors clearly
  - [x] Show validation errors (email, password, SIREN format) next to fields or at top of form. [Source: PRD AC 10]
  - [x] Show server errors (SIREN déjà utilisé, email déjà utilisé, rate limit) as generic user-facing message; do not expose stack or internal details. [Source: docs/architecture/coding-standards.md §5.1, docs/architecture.md §10.1]
- [x] Task 6 – Testing (AC: 2–6, 11): Unit and integration tests
  - [x] Unit: Zod schemas reject invalid email, password < 8 chars, SIREN not 9 digits. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]
  - [x] Integration: call registration flow (or completeRegistration) with valid data and assert Company + User created; call with duplicate SIREN and assert error message. [Source: docs/architecture.md §14]
  - [x] Optionally: test rate limit (e.g. mock or exceed 10 requests and expect TOO_MANY_REQUESTS). [Source: docs/architecture/rate-limiting.md]

## Dev Notes

### Previous Story Insights

- Story 1.2: tRPC context resolves `companyId` from User table via session; `protectedProcedure` throws UNAUTHORIZED if no session. For registration we need a **public** procedure (no auth yet) that creates Company + User after the auth user exists (client signUp then server creates Company+User with session user id). [Source: docs/stories/1.2.database-schema-multi-tenancy.md Completion Notes]
- Prisma: Company, User, Invitation models and RLS in place; use `db` from context or server db.ts. [Source: docs/stories/1.2]
- RLS: INSERT on Company/User may require service role or bypass for the first user (no user row yet). Document in architecture: registration flow often uses a single transaction with Supabase auth already created; the app might use a connection with service role for this step, or Supabase triggers. If using tRPC with normal connection, RLS policies for Company (no INSERT in doc) and User (INSERT “géré par l'app”) may need to allow INSERT from a role used during registration—verify against `docs/architecture/rls-policies.sql`. [Source: docs/architecture.md §4.3, docs/architecture/rls-policies.sql]

### Data Models

- **Company:** id (uuid), name, siren (unique), createdAt, updatedAt. Created once per registration. [Source: docs/architecture.md §5, prisma/schema.prisma]
- **User:** id = Supabase Auth uid (from session after signUp), email, firstName, lastName, companyId (FK to newly created Company), createdAt, updatedAt. Created in same transaction as Company. [Source: docs/architecture.md §5, §7.1]

### API Specifications

- **Auth router:** register or completeRegistration procedure. Input: companyName, siren, firstName, lastName (email/password handled by Supabase signUp on client). [Source: docs/architecture.md §9]
- **Rate limit:** 10 requests per IP per minute; key `auth:${ip}`; message « Trop de requêtes. Réessayez dans quelques minutes. » [Source: docs/architecture/rate-limiting.md §1, §3.1, src/lib/rate-limit.ts]
- **Errors:** Use TRPCError with code and message; client displays message. SIREN déjà utilisé, Email déjà utilisé, Format SIREN invalide, Format email invalide per PRD. [Source: docs/prd.md Standard Error Messages]

### Component Specifications

- Registration form: shadcn/ui components (Input, Button, Label, etc.) in `src/components/` or inline in page. [Source: docs/architecture/source-tree.md §2]
- Use design-system tokens for colors/spacing (Tailwind). [Source: docs/architecture/coding-standards.md §4]
- Loading: disable submit button and show loading indicator during signUp + completeRegistration. [Source: PRD AC 9]

### File Locations

| Purpose | Path |
|--------|------|
| Register page | src/app/(auth)/register/page.tsx |
| Auth validations (Zod) | src/lib/validations/auth.ts (or company.ts for SIREN) |
| Auth router (tRPC) | src/server/trpc/routers/auth.ts |
| Rate limit helper | src/lib/rate-limit.ts (existing) |
| Supabase client (signUp) | src/lib/supabase/client.ts (existing) |

[Source: docs/architecture.md §6, docs/architecture/source-tree.md, docs/frontend-architecture.md §2]

### Technical Constraints

- **Validation:** All inputs validated with Zod on server; client can reuse same schemas. [Source: docs/architecture/coding-standards.md §3]
- **Messages:** Generic user-facing messages only; no stack traces or internal details. [Source: docs/architecture.md §10.1, docs/architecture/coding-standards.md §5.1]
- **Transaction:** Company and User created in a single Prisma `$transaction`. [Source: docs/architecture.md §7.1]
- **Password:** Never stored in app DB; Supabase Auth only. [Source: docs/architecture/coding-standards.md §3]

### Testing

- **Unit:** Vitest; test Zod schemas (email, password min 8, SIREN 9 digits). [Source: docs/architecture.md §14]
- **Integration:** Vitest; call registration procedure with valid data; assert Company + User in DB; duplicate SIREN → error. [Source: docs/architecture/coding-standards.md §6]
- **E2E:** Optional for this story; can be covered in Epic 1 regression. [Source: docs/architecture.md §14]

### Project Structure Notes

- Route `/register` in group `(auth)` as per docs/frontend-architecture.md §2. No structural conflicts.

### État des lieux — Envoi d’emails (SMTP)

- **SMTP non paramétré** : à ce stade, aucun serveur SMTP personnalisé n’a été configuré pour Supabase Auth. L’envoi d’emails (confirmation d’inscription, reset password, etc.) repose sur le SMTP par défaut de Supabase.
- **Limites Supabase sans SMTP perso** :
  - **2 e-mails par heure** au total pour tous les endpoints qui envoient un email (`signup`, `recover`, changement d’email). Cette limite est **non modifiable** sans SMTP personnalisé.
  - Fenêtre **60 secondes** entre deux requêtes signup pour le même utilisateur (configurable dans le dashboard).
  - En cas de dépassement : erreur **429 Too Many Requests**, affichée côté client comme « Trop de requêtes. Réessayez dans quelques minutes. »
- **À prévoir** : configurer un **SMTP personnalisé** pour Supabase Auth (Dashboard → Authentication → SMTP) afin de lever la limite 2/heure et d’utiliser un envoi fiable en production. **Objectif retenu** : passer par **OVH** (nom de domaine déjà hébergé chez eux) en utilisant une boîte mail du type `no-reply@tondomaine.fr` et les paramètres SMTP OVH (ex. `ssl0.ovh.net`, port 465, identifiants de la boîte mail).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-14 | 0.1 | Story draft created (1.3 User Registration & Company Creation) | Bob (SM) |
| 2026-02-14 | 0.2 | Implementation: register page, auth validations, completeRegistration flow, rate limiting, tests | James (Dev) |

---

## Dev Agent Record

*(To be filled by the development agent during implementation.)*

### Agent Model Used

Cursor / Auto (agent).

### Debug Log References

None.

### Completion Notes List

- Registration flow: client signUp (Supabase) then tRPC completeRegistration; context extended with headers for rate limiting.
- Minimal dashboard page added at `/dashboard` for post-registration redirect.
- tRPC React provider and client added (Providers, api, createTRPCClient) for client-side mutations.
- Integration tests require DATABASE_URL; they are skipped when unset.

### File List

- Created: `src/app/(auth)/layout.tsx`, `src/app/(auth)/register/page.tsx`, `src/app/(dashboard)/layout.tsx`, `src/app/(dashboard)/dashboard/page.tsx`, `src/lib/validations/auth.ts`, `src/lib/trpc/client.ts`, `src/lib/trpc/trpc.ts`, `src/components/providers.tsx`, `src/server/trpc/routers/auth.ts`, `tests/unit/validations/auth.test.ts`, `tests/integration/auth/completeRegistration.test.ts`
- Modified: `src/app/layout.tsx`, `src/server/trpc/context.ts`, `src/server/trpc/routers/_app.ts`
- Added (shadcn): `src/components/ui/input.tsx`, `src/components/ui/label.tsx`
- Dependencies added: react-hook-form, @hookform/resolvers

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
