# Story 3.3: Job Offer List Page

## Status

DONE

## Story

**As a** recruiter,  
**I want** to see all my job offers,  
**so that** I can manage my open positions.

## Acceptance Criteria

1. Offers page accessible from main navigation  
2. Displays list of offers as cards  
3. Each offer shows: title, client company name, location, salary range, status badge  
4. Status badges with distinct colors: "À faire" (gray), "En cours" (blue/sage), "Terminé" (green)  
5. "Nouvelle offre" button (terracotta CTA)  
6. Click on offer navigates to offer detail page  
7. Empty state: "Aucune offre créée"  
8. List scoped to user's company (RLS)  
9. Sort by: date created (default), status  
10. Loading state while fetching  

**Réf.** PRD § Epic 3, Story 3.3 (Job Offer List Page) ; Wireframes §4 Liste Offres (cartes offre, CTA « Nouvelle offre », filtres et statuts) ; Design System §2 (palette, statuts offre).

## Tasks / Subtasks

- [x] Task 1 (AC: 1, 8, 9): API – Liste des offres
  - [x] Créer (ou étendre) le router `offer` dans `src/server/trpc/routers/offer.ts` avec une procédure `list` (protectedProcedure) qui retourne la liste paginée des offres du cabinet courant (`where: { companyId: ctx.companyId }`).  
  - [x] Sélectionner au minimum les champs : `id`, `title`, `location`, `salaryMin`, `salaryMax`, `status`, `createdAt`, ainsi que la relation `clientCompany` (nom de l’entreprise cliente, nullable).  
  - [x] Implémenter un tri par défaut sur `createdAt` décroissant (plus récentes en premier).  
  - [x] Ajouter un paramètre de tri optionnel (`sortBy: "createdAt" | "status"`, `sortOrder: "asc" | "desc"`), en mappant les valeurs aux colonnes Prisma, avec une valeur par défaut cohérente avec l’AC 9 (date de création par défaut, statut en second).  
  - [x] Implémenter une pagination simple (ex. `page`, `pageSize`) et retourner aussi le `totalCount` pour préparer la pagination côté UI, même si la première version du design peut simplement charger la première page.  
  - [x] Vérifier que la procédure respecte les standards `coding-standards.md` (schémas Zod pour l’input, erreurs typées, isolation via `ctx.companyId`).  

- [x] Task 2 (AC: 1): Navigation & route page Offres
  - [x] Vérifier dans le layout principal (`src/app/(dashboard)/layout.tsx` ou équivalent) que l’entrée de navigation « Offres » existe et pointe vers `/offers` ; si elle est encore désactivée/placeholder, l’activer pour cette story.  
  - [x] Créer la page `src/app/(dashboard)/offers/page.tsx` si elle n’existe pas, en respectant la structure décrite dans `docs/frontend-architecture.md` (chargement via tRPC + React Query, gestion des états loading/error/success).  
  - [x] S’assurer que la navigation « Offres » fonctionne depuis toutes les pages authentifiées (layout shell commun).  

- [x] Task 3 (AC: 2, 3, 4, 5, 6, 7, 10): UI – Liste des offres en cartes
  - [x] Dans `offers/page.tsx`, appeler la procédure `offer.list` (TanStack Query) et afficher la liste d’offres sous forme de cartes, dans un conteneur type `grid` ou `stack` conforme au Design System (cards `bg-card`, `border`, `rounded-lg`, padding standard).  
  - [x] Sur chaque carte, afficher :  
    - Titre de l’offre (`JobOffer.title`) en texte principal.  
    - Nom de l’entreprise cliente (`clientCompany.name`) si présent, sinon label « Client non défini » ou équivalent.  
    - Localisation (`location`) si renseignée.  
    - Fourchette salariale (`salaryMin`–`salaryMax`) formatée lisiblement (ex. « 45–55 k€ », ou « Salaire non précisé » si vide).  
  - [x] Afficher un badge de statut pour chaque offre avec des couleurs distinctes alignées sur le Design System :  
    - "À faire" → gris neutre.  
    - "En cours" → bleu/sauge.  
    - "Terminé" → vert.  
  - [x] Ajouter le bouton "Nouvelle offre" (CTA terracotta) en haut de la page, aligné avec les autres pages liste (ex. `NewCandidateButton`). Pour cette story, le clic peut déjà rediriger vers la page/formulaire de création si Story 3.4 est prête ; sinon, afficher un TODO clair en Dev Notes et un comportement minimal (ex. navigation vers un placeholder ou désactivé avec tooltip « Arrive dans la Story 3.4 »).  
  - [x] Rendre chaque carte cliquable : clic sur la carte (ou sur un bouton « Voir l’offre ») doit naviguer vers la page détail de l’offre (`/offers/[id]`) qui sera implémentée dans la Story 3.6. Si la page n’existe pas encore, créer un squelette minimal ou documenter la dépendance en Dev Notes.  
  - [x] Gérer l’état de chargement avec un skeleton cohérent avec les autres pages (ex. 3–6 cartes skeleton).  
  - [x] Gérer l’état vide : si aucune offre n’est retournée, afficher un état vide « Aucune offre créée » avec un court texte d’explication et le CTA "Nouvelle offre".  

- [x] Task 4 (AC: 2, 3, 4, 9): Composant(s) dédiés Job Offer
  - [x] Créer un composant réutilisable `JobOfferCard` dans `src/components/offers/JobOfferCard.tsx` (ou similaire) qui encapsule l’affichage d’une offre (titre, client, location, salaire, badge de statut) et la navigation au clic.  
  - [x] Créer un petit utilitaire (ou hook) de mapping statut → style (couleur de badge, label) réutilisable entre la liste et la future fiche offre (Story 3.6), en respectant les tokens du Design System (ne pas dupliquer les classes en dur).  
  - [x] Prévoir les props nécessaires pour supporter à terme les filtres et tris (ex. mise en avant visuelle selon le statut ou la date), même si seuls le tri et la liste simple sont requis dans cette story.  

- [x] Task 5 (AC: 8, 9): Comportement RLS, tri et pagination côté client
  - [x] Vérifier via tests d’intégration que la procédure `offer.list` ne retourne que les offres du cabinet courant, même si la base contient des offres d’un autre cabinet (multi-tenancy).  
  - [x] Implémenter côté UI un tri simple :  
    - Par défaut : "Date de création (plus récentes d’abord)".  
    - Optionnel : contrôle (dropdown ou boutons) pour trier par statut (ordre logique : "En cours" → "À faire" → "Terminé", ou équivalent) si cela reste simple pour le MVP.  
  - [x] Si un contrôle de tri est exposé en UI, s’assurer que les valeurs envoyées au back passent par un mapping sûr (white-list des colonnes/ordres) pour éviter tout risque d’injection dans Prisma.  
  - [x] Optionnel : exposer un minimum d’informations de pagination (ex. « 1–20 sur X offres ») si la procédure retourne un total ; sinon, documenter en Dev Notes que la pagination fine sera améliorée plus tard.  

- [x] Task 6 – Testing (AC: 1–10)
  - [x] Ajouter des tests d’intégration pour le router `offer` :  
    - `offer.list` retourne uniquement les offres du cabinet courant (multi-tenancy respectée).  
    - Tri par défaut sur `createdAt` décroissant.  
    - Tri par statut s’il est implémenté.  
    - Pagination basique (page 1 / page 2) si mise en place.  
  - [x] Ajouter des tests unitaires pour les schémas Zod (input de `offer.list`) et pour les utilitaires de mapping statut → style (labels, couleurs).  
  - [x] (Optionnel) Ajouter un test de composant pour `JobOfferCard` ou la page `/offers` couvrant : état loading, état vide, rendu d’une offre complète, clic de navigation.  

- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/3.3-test-cases.md`) pour faciliter la review de la story.

- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Dependencies & Previous Stories

- Story 3.1 et 3.2 DONE : la navigation Clients et la fiche client existent déjà ; la story 3.3 introduit la première vue liste pour les offres.  
- La création/édition d’offres (Story 3.4) et la fiche offre (Story 3.6) sont des stories séparées ; la présente story se concentre sur la **liste** et la navigation vers le détail, qui peut être un squelette minimal si 3.6 n’est pas encore implémentée.  
- Le modèle Prisma `JobOffer` est défini dans `prisma/schema.prisma` (réf. PRD § Data Model – JobOffer).  

### Data Models

- **JobOffer** : `id`, `title`, `description?`, `location?`, `salaryMin?`, `salaryMax?`, `status` (`TODO`, `IN_PROGRESS`, `DONE`), `clientCompanyId?`, `clientContactId?`, `companyId`, `createdAt`, `updatedAt`.  
- **ClientCompany** : `id`, `name`, `siren?`, `companyId`, relations `offers` et `contacts`.  
- La liste d’offres doit toujours passer par la contrainte `companyId = ctx.companyId` pour respecter la multi-tenancy (pas de lecture cross‑cabinet).  

### API Specifications

- **offer.list** :  
  - Input : paramètres optionnels de pagination/tri (ex. `{ page?: number; pageSize?: number; sortBy?: "createdAt" | "status"; sortOrder?: "asc" | "desc" }`).  
  - Comportement : filtre systématique sur `companyId`, tri par défaut sur `createdAt` desc, possibilité de trier par `status` si demandé.  
  - Output : `{ items: JobOfferWithClientCompany[]; totalCount: number; page: number; pageSize: number }` ou équivalent.  
  - Aucun rate limiting spécifique (lecture métier standard), se conformer aux guides `rate-limiting.md` si une limite générique est appliquée aux listes.  

### UI & Components

- La page `/offers` doit respecter le layout global (sidebar/header) défini dans l’Epic 1 (Story 1.6 et 1.7) et le Design System (cards, typographie, palette beige/terracotta/sauge).  
- Le composant `JobOfferCard` pourra être réutilisé sur le Dashboard (Story 4.7) ou sur la fiche client si on liste les offres associées à un client.  
- Les badges de statut doivent réutiliser les mêmes styles sur toutes les vues (liste offres, fiche offre, éventuellement Dashboard).  

### Testing

- Côté back : privilégier les tests d’intégration sur `offer.list` (isolation multi-tenant, tri, pagination).  
- Côté front : au minimum un test de rendu de la page `/offers` ou du composant `JobOfferCard` pour éviter les régressions sur les champs obligatoires (titre, client, badge statut, CTA "Nouvelle offre").  

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-24 | 0.1 | Story draft created (3.3 Job Offer List Page) | Bob (SM) |
| 2026-02-25 | 0.2 | Implementation complete: offer.list API, page /offers, JobOfferCard, tri, tests, cas de test QA | James (Dev) |

---

## Dev Agent Record

*(This section is populated by the development agent during implementation.)*

### Agent Model Used

<!-- Example: "GPT-5.1 via Cursor" -->

### Debug Log References

*(Aucune)*

### Completion Notes List

- (À compléter par l’agent de développement lors de l’implémentation de la story : choix d’implémentation, décisions prises, points d’attention.)  

### File List

| Path | Action |
|------|--------|
| src/lib/validations/offer.ts | created |
| src/server/trpc/routers/offer.ts | created |
| src/server/trpc/routers/_app.ts | modified |
| src/components/layout/SiteNavbar.tsx | modified |
| src/app/(dashboard)/offers/page.tsx | created |
| src/app/(dashboard)/offers/new/page.tsx | created |
| src/lib/offer-status-style.ts | created |
| src/components/offers/JobOfferCard.tsx | created |
| tests/integration/offer/offer.test.ts | created |
| tests/unit/validations/offer.test.ts | created |
| tests/unit/offer/offer-status-style.test.ts | created |
| tests/unit/components/offers/JobOfferCard.test.tsx | created |
| docs/stories/cases/3.3-test-cases.md | created |

---

## QA Results

*(Results from QA Agent QA review of the completed story implementation.)*

