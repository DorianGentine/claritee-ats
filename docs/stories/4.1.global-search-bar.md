# Story 4.1: Global Search Bar

## Status

DONE

## Story

**As a** recruiter,  
**I want** to search across candidates and offers from anywhere,  
**so that** I can quickly find what I'm looking for.

## Acceptance Criteria

1. Search bar in navigation header, visible on all pages
2. Search icon + input field (expandable or always visible)
3. Search queries candidates by: firstName, lastName, title, summary, city, tags, languages, experiences (title, company, description), formations (degree, field, school)
4. Search queries offers by: title, description
5. Results displayed in dropdown as user types (debounced, 300ms)
6. Results grouped by type: "Candidats", "Offres"
7. Each result shows: name/title, subtitle (title for candidate, client for offer)
8. Click result navigates to detail page
9. "Voir tous les résultats" link for full search page (optional)
10. Keyboard shortcut: Cmd/Ctrl + K opens search
11. Empty state: "Aucun résultat pour '[query]'"
12. Minimum 2 characters to trigger search

**Réf.** Wireframes « Barre de recherche (Cmd+K) » (résultats groupés Candidats / Offres, lien « Voir tous les résultats ») ; Design System (champ recherche, debounce 300ms).

## Tasks / Subtasks

- [x] Task 1 (AC: 3, 4): API – Router search
  - [x] Créer `src/server/trpc/routers/search.ts` avec une procédure `search` (protectedProcedure). [Source: docs/architecture/coding-standards.md §3.1, docs/architecture.md §9]
  - [x] Input : `{ q: string }` ; validation Zod (string, min 2 caractères). [Source: docs/architecture.md §10.1]
  - [x] Requête Prisma sur Candidate scopée par `ctx.companyId` : OR sur champs directs (firstName, lastName, title, summary, city) + relations : tags (Tag.name via CandidateTag), languages (Language.name), experiences (title, company, description), formations (degree, field, school). [Source: prisma/schema.prisma, docs/architecture.md §4]
  - [x] Requête Prisma sur JobOffer (OR sur title, description via contains/ilike) scopée par `ctx.companyId`. Inclure relation clientCompany pour afficher le nom du client en subtitle. [Source: prisma/schema.prisma]
  - [x] Retourner structure : `{ candidates: [...], offers: [...] }` avec id, champs nécessaires pour affichage (firstName, lastName, title, summary pour candidats ; title, clientCompany.name pour offres). Limiter à 5-10 résultats par type pour le dropdown. [Source: wireframes § Barre de recherche]
  - [x] Enregistrer le router dans `src/server/trpc/routers/_app.ts`. [Source: docs/architecture/source-tree.md]
- [x] Task 2 (AC: 1, 2, 5, 6, 7, 8, 11, 12): Composant GlobalSearchBar
  - [x] Créer `src/components/layout/GlobalSearchBar.tsx` (ou `src/components/shared/GlobalSearchBar.tsx`). Input avec icône de recherche, état local pour la requête. [Source: docs/frontend-architecture.md §4.2, docs/wireframes.md § Barre de recherche]
  - [x] Debounce 300ms sur la saisie avant appel `trpc.search.search.useQuery({ q }, { enabled: q.length >= 2 })`. [Source: docs/design-system.md, wireframes]
  - [x] Modal (Dialog + Command) affichant les résultats groupés : section "CANDIDATS", section "OFFRES". Chaque résultat : nom/titre + subtitle, clic ou Entrée → navigation vers `/candidates/[id]` ou `/offers/[id]`. "Voir tous les résultats" en CommandItem (accessible clavier). [Source: wireframes § Barre de recherche]
  - [x] État vide : "Aucun résultat pour '[query]'" quand q.length >= 2 et résultats vides. [Source: PRD AC 11]
  - [x] Loading skeleton ou indicateur pendant le fetch. [Source: docs/frontend-architecture.md §5, convention isLoading]
- [x] Task 3 (AC: 10): Raccourci Cmd/Ctrl + K
  - [x] Écouter l’événement clavier global (useEffect avec keydown) pour Cmd+K (Mac) ou Ctrl+K (Windows). Prévenir le comportement par défaut et ouvrir/focuser la barre de recherche. [Source: docs/frontend-architecture.md §7]
- [x] Task 4 (AC: 1): Intégration dans le layout
  - [x] Intégrer GlobalSearchBar dans `SiteNavbar.tsx`, visible uniquement quand `isDashboard` (utilisateur authentifié sur les pages dashboard). Position : icône alignée à droite (ml-auto), entre la nav principale et le menu utilisateur. [Source: docs/wireframes.md § Layout global]
- [x] Task 5 (AC: 9, optionnel): Page "Voir tous les résultats"
  - [x] Créer `src/app/(dashboard)/search/page.tsx` qui accepte `?q=xxx` en query param. Afficher la liste complète des candidats et offres correspondants (pagination si nécessaire). Lien "Voir tous les résultats" dans la modal pointe vers `/search?q={query}`. [Source: wireframes § Barre de recherche]
- [x] Task 6 – Testing (AC: 1–12)
  - [x] Tests d'intégration : procédure `search.search` avec query valide ; vérifier filtrage par companyId ; recherche sur tags, ville, langues, expériences, formations (candidats correspondants retournés) ; cas query < 2 caractères (pas d'appel ou erreur de validation). [Source: docs/architecture.md §14]
  - [x] Test manuel : debounce, navigation au clic, Cmd+K, empty state, accessibilité clavier.
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. docs/stories/cases/4.1-test-cases.md) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.10 terminée : formulaire d’édition candidat, structure des pages candidates. La route `/candidates/[id]` existe ; la route `/offers/[id]` n’existe pas encore (onglet Offres « Bientôt »). Pour les offres : prévoir la navigation vers `/offers/[id]` ; si la page offre n’est pas implémentée, le lien peut pointer vers une route vide ou être désactivé temporairement. Préférer implémenter le lien vers `/offers/[id]` pour cohérence future. [Source: SiteNavbar, navLinks]
- Le router tRPC actuel (`_app.ts`) contient : auth, candidate, company, invitation, tag. Pas de router offer ni search. [Source: src/server/trpc/routers/_app.ts]

### Data Models

- **Candidate** : id, firstName, lastName, title, summary, city, companyId. Relations : tags (CandidateTag → Tag.name), languages (Language.name), experiences (title, company, description), formations (degree, field, school). [Source: prisma/schema.prisma]
- **JobOffer** : id, title, description, companyId, clientCompanyId (nullable). Relation clientCompany pour nom du client. [Source: prisma/schema.prisma]
- Toutes les données métier sont scopées par companyId ; RLS appliqué. [Source: docs/architecture.md §4]

### API Specifications

- **search.search** (protectedProcedure) : input `{ q: string }`, min 2 caractères. Retourne `{ candidates: Array<{id, firstName, lastName, title}>, offers: Array<{id, title, clientCompany?: { name } }> }`. Recherche case-insensitive sur tous les champs candidats (dont city, tags, languages, experiences, formations). [Source: docs/architecture.md §9]
- Pas de rate limiting spécifique pour la recherche (lecture seule, pas dans rate-limiting.md). [Source: docs/architecture/rate-limiting.md]

### Component Specifications

- Trigger : icône Search seule (bouton ghost), alignée à droite dans le header. Clic ou Cmd/Ctrl+K ouvre la modal. [Source: wireframes § Barre de recherche, style Notion]
- Modal : Dialog centrée (max 600px), ancrée à 20vh du haut. Input avec placeholder "Rechercher candidats, offres..." dans le Command. Structure Command + CommandInput + CommandList. Groupes "CANDIDATS" et "OFFRES" avec en-têtes. Chaque item : ligne cliquable/sélectionnable clavier, nom/titre en gras, subtitle en muted. Lien "Voir tous les résultats" en CommandItem (accessible clavier). [Source: wireframes, docs/design-system.md]
- Accessibilité : label associé (aria-label ou placeholder explicite), navigation clavier (flèches, Entrée, Échap), focus visible. [Source: docs/frontend-architecture.md §9, docs/architecture/coding-standards.md §7]

### File Locations

| Purpose | Path |
|---------|------|
| Router search | src/server/trpc/routers/search.ts |
| Validation search | src/lib/validations/search.ts (optionnel, schéma Zod) |
| Composant barre recherche | src/components/layout/GlobalSearchBar.tsx |
| Page résultats (optionnel) | src/app/(dashboard)/search/page.tsx |
| Enregistrement router | src/server/trpc/routers/_app.ts |
| Intégration navbar | src/components/layout/SiteNavbar.tsx |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- Recherche full-text : pour le MVP, utiliser Prisma `OR` + `contains`/`ilike` (mode insensitive). Pour les relations (tags, languages, experiences, formations), utiliser `some` avec conditions sur la table liée. Exemple : `{ tags: { some: { tag: { name: { contains: q, mode: 'insensitive' } } } } }` et équivalents pour languages, experiences, formations. [Source: docs/architecture.md §10.2]
- Index DB : si performances insuffisantes, envisager un index sur Candidate (companyId, firstName, lastName, title) et JobOffer (companyId, title) ; non bloquant pour le MVP.
- Offres : le module offres (liste, fiche) n’est pas encore implémenté. La recherche peut retourner des offres dès que la table JobOffer contient des données (seed ou saisie future). Si aucun router offer n’existe, la page `/offers/[id]` n’existe pas — dans ce cas, le clic sur une offre peut afficher un message "Page en construction" ou être désactivé. Préférer créer une page offre minimale (redirect vers dashboard) ou documenter que le lien sera actif après Story 3.6. [Source: PRD ordre de priorités]
- shadcn/ui : utiliser Command ou Combobox si disponible ; sinon Popover + Input + liste custom. [Source: docs/design-system.md, docs/frontend-architecture.md §4.1]

### Testing

- Intégration : `search.search` avec companyId mocké ; vérifier isolation multi-tenant (candidats d’un autre cabinet exclus). [Source: docs/architecture.md §14]
- Tests de validation : q.length < 2 → erreur ou pas d’appel (enabled: false côté client suffit ; côté serveur, valider min 2 dans le schéma Zod).

### Project Structure Notes

- Le router search est un nouveau domaine ; création de `search.ts` dans routers/. Pas de conflit avec la structure existante.
- Fichiers de test : `tests/integration/search/search.test.ts`. [Source: docs/architecture.md §14, docs/architecture/coding-standards.md §6]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 0.1 | Story draft created (4.1 Global Search Bar) | Bob (SM) |
| 2026-02-21 | 0.2 | Ajout critères recherche candidats : tags, ville, langues, expériences, formations | Bob (SM) |
| 2026-02-21 | 0.3 | Implémentation complète (router, GlobalSearchBar, Cmd+K, pages, tests) | James (Dev) |
| 2026-02-21 | 0.4 | UX Notion-style : trigger icône seule, modal centrée ancrée en haut (20vh), "Voir tous les résultats" accessible clavier | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes List

- Router search : requêtes candidates et offers en parallèle (Promise.all) pour les perfs
- Index DB ajoutés : Candidate (companyId, firstName, lastName, title), JobOffer (companyId, title)
- Composants shadcn Command + Dialog (cmdk, @radix-ui/react-dialog). Modal centrée en largeur, ancrée à 20vh en hauteur.
- Page /offers/[id] : placeholder "Page bientôt disponible"
- Tests d'intégration skip si DATABASE_URL absent (runIf)
- UX post-implémentation : trigger icône seule (alignée à droite), modal Dialog ancrée à 20vh, pas de bouton fermer (Escape / clic extérieur), navigation clavier complète (flèches, Entrée, y compris "Voir tous les résultats")

### File List

- prisma/schema.prisma (indexes)
- src/lib/validations/search.ts (new)
- src/server/trpc/routers/search.ts (new)
- src/server/trpc/routers/_app.ts (search router)
- src/components/ui/popover.tsx (new)
- src/components/ui/command.tsx (new)
- src/components/layout/GlobalSearchBar.tsx (new)
- src/components/layout/SiteNavbar.tsx (GlobalSearchBar)
- src/app/(dashboard)/offers/[id]/page.tsx (new)
- src/app/(dashboard)/search/page.tsx (new)
- tests/integration/search/search.test.ts (new)
- tests/unit/validations/search.test.ts (new)
- tests/unit/components/layout/SiteNavbar.a11y.test.tsx (mock search)
- docs/stories/cases/4.1-test-cases.md (new)

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
