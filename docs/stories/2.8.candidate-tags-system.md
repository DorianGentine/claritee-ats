# Story 2.8: Candidate Tags System

## Status

DONE

## Story

**As a** recruiter,  
**I want** to add and remove tags on candidates,  
**so that** I can categorize and later filter them.

## Acceptance Criteria

1. Tags section visible on candidate detail page (left column)
2. "Ajouter un tag" input with autocomplete from existing tags
3. Create new tag on-the-fly if not exists
4. Tags scoped to company (each company has its own tag library)
5. Tags displayed as colored badges/chips (colors auto-assigned)
6. Click X on tag to remove from candidate
7. Tag colors auto-assigned from palette
8. Maximum 20 tags per candidate (reasonable limit)
9. Tags searchable and filterable (foundation for Epic 4)
10. Tag model in database: id, name, color, companyId

**Réf.** Design System §2 « Palette de tags » (couleurs auto-assignées, cycle hash % 8) ; wireframes §3 (badges tags, « + Ajouter »).

## Tasks / Subtasks

- [x] Task 1 (AC: 4, 7, 10): API – Tag et liaison candidat
  - [x] Vérifier le modèle Prisma : `Tag` (id, name, color, companyId), `CandidateTag` (candidateId, tagId) ; contrainte unique (name, companyId). [Source: prisma/schema.prisma]
  - [x] Créer router `tag` ou étendre le router existant : procedure `tag.list` (protectedProcedure) retournant les tags du cabinet pour l’autocomplete. [Source: docs/architecture.md §9]
  - [x] Procedure `tag.findOrCreate` (optionnel) ou logique dans `candidate.addTag` : si le tag n’existe pas pour le cabinet, le créer avec une couleur issue de la palette (hash(tagName) % 8). [Source: docs/design-system.md §2]
  - [x] Schémas Zod : tagName (string min 1, trim). [Source: docs/architecture/coding-standards.md §3]
- [x] Task 2 (AC: 2, 3, 4, 8): API – Procedures candidat–tag
  - [x] `candidate.addTag` : protectedProcedure, input `{ candidateId, tagName }` ; vérifier candidat du cabinet ; si tag inexistant, créer Tag (companyId, name, color) ; créer CandidateTag ; si le candidat a déjà 20 tags, renvoyer erreur BAD_REQUEST avec message « Maximum 20 tags par élément. Supprimez un tag existant pour en ajouter un nouveau. ». [Source: PRD Standard Error Messages]
  - [x] `candidate.removeTag` : protectedProcedure, input `{ candidateId, tagId }` ; vérifier candidat du cabinet et que le tag est bien associé au candidat ; supprimer CandidateTag. [Source: docs/architecture.md §9]
- [x] Task 3 (AC: 1, 2, 5, 6): UI – Section Tags avec ajout et suppression
  - [x] Section Tags dans la colonne gauche (sidebar) : toujours visible (pas uniquement si tags > 0). [Source: PRD AC 1, CandidateDetailSidebar]
  - [x] Input « Ajouter un tag » avec autocomplete (datalist ou combobox) alimenté par `tag.list`. Saisie libre autorisée pour créer un nouveau tag. [Source: PRD AC 2, AC 3]
  - [x] Affichage des tags en badges colorés (style existant : backgroundColor, borderColor, color depuis tag.color). [Source: PRD AC 5, AC 7, docs/design-system.md, CandidateDetailSidebar]
  - [x] Bouton X sur chaque badge pour retirer le tag du candidat ; appeler `candidate.removeTag`. [Source: PRD AC 6]
- [x] Task 4 (AC: 8, 9): Limite et fondation recherche
  - [x] Côté client : désactiver ou masquer l’ajout si le candidat a déjà 20 tags ; afficher un message si limite atteinte. [Source: PRD AC 8]
  - [x] Côté API : vérification stricte avant création de CandidateTag. [Source: PRD AC 8]
  - [x] AC 9 (recherche/filtrage) : fondation posée par le modèle Tag et tag.list ; le filtrage par tags sera en Epic 4. Ici, s’assurer que tag.list existe et peut servir de base. [Source: PRD AC 9]
- [x] Task 5 – Validation et erreurs
  - [x] Message « Maximum 20 tags par élément. Supprimez un tag existant pour en ajouter un nouveau. » en cas de dépassement. [Source: PRD Standard Error Messages]
- [x] Task 6 – Testing (AC: 1–8)
  - [x] Intégration : tag.list, addTag (nouveau tag, tag existant, limite 20), removeTag ; isolation multi-tenant. [Source: docs/architecture.md §14]
  - [x] Manuel : autocomplete, création tag à la volée, ajout/suppression, couleurs, limite 20. [Source: docs/architecture/coding-standards.md §6]
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. `docs/stories/cases/2.8-test-cases.md`) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 2.5 : CandidateLanguagesSection avec badges, input + suggestions, ajout/suppression. Pattern similaire pour les tags. [Source: docs/stories/2.5]
- Story 2.4–2.7 : getById retourne déjà les tags (via CandidateTag) ; CandidateDetailSidebar affiche les tags en lecture seule si tags.length > 0. [Source: CandidateDetailSidebar, candidate router]
- Section Tags actuellement affichée uniquement si tags.length > 0 ; pour AC 1, la section doit être toujours visible (avec input d’ajout). [Source: codebase]

### Data Models

- **Tag** : id, name, color, companyId ; @@unique([name, companyId]). [Source: prisma/schema.prisma]
- **CandidateTag** : candidateId, tagId ; table de liaison N-N. [Source: prisma/schema.prisma]
- Palette : 8 couleurs (hex), assignation `colorIndex = hash(tagName) % 8`. [Source: docs/design-system.md §2]

### API Specifications

- **tag.list** : protectedProcedure, retourne les tags du cabinet (ctx.companyId) pour autocomplete. [Source: docs/architecture.md §9]
- **candidate.addTag** : input `{ candidateId, tagName }` ; findOrCreate Tag (companyId, color via hash) ; créer CandidateTag ; vérifier max 20. [Source: docs/architecture.md §9]
- **candidate.removeTag** : input `{ candidateId, tagId }` ; supprimer CandidateTag si liaison existe et candidat du cabinet. [Source: docs/architecture.md §9]

### Component Specifications

- Section Tags dans CandidateDetailSidebar (colonne gauche). [Source: wireframes §3]
- Input avec autocomplete (datalist ou Combobox shadcn) ; badges avec couleur + bouton X. [Source: docs/design-system.md, CandidateLanguagesSection pattern]

### File Locations

| Purpose | Path |
|--------|------|
| Sidebar (tags, résumé, langues) | src/components/candidates/CandidateDetailSidebar.tsx |
| Nouveau composant (optionnel) | src/components/candidates/CandidateTagsSection.tsx (extraire la section tags) |
| Router tag (nouveau si besoin) | src/server/trpc/routers/tag.ts |
| Router candidate | src/server/trpc/routers/candidate.ts |
| Validations | src/lib/validations/tag.ts ou candidate.ts |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- Tag a companyId ; toutes les procedures tag filtrent par ctx.companyId. [Source: docs/architecture/coding-standards.md §5.1]
- Limite 20 tags par candidat : vérification côté API obligatoire. [Source: PRD AC 8]

### Testing

- Intégration : tag.list, addTag (création tag, tag existant, limite 20), removeTag, NOT_FOUND pour autre cabinet. [Source: docs/architecture.md §14]

### Project Structure Notes

- Si aucun router tag n’existe : créer `src/server/trpc/routers/tag.ts` et l’enregistrer dans `_app.ts`. [Source: docs/architecture/coding-standards.md §3.1]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 0.1 | Story draft created (2.8 Candidate Tags System) | Bob (SM) |
| 2026-02-19 | 0.2 | Implementation complete : tag API, addTag/removeTag, CandidateTagsSection, tests | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Cursor / develop-story

### Debug Log References

*(None.)*

### Completion Notes List

- Tag router créé avec procedure `tag.list` (protectedProcedure).
- `candidate.addTag` et `candidate.removeTag` ajoutés au router candidate.
- Logique findOrCreate dans addTag : création du tag avec couleur via `getTagColor(tagName)` (hash % 8).
- `CandidateTagsSection` : section toujours visible, autocomplete datalist, badges colorés, bouton X, limite 20 côté client et API.
- Tests : tag.test.ts (tag.list), candidate.test.ts (addTag, removeTag), tag.test.ts unit (validations).

### File List

| Fichier | Action |
|---------|--------|
| src/lib/validations/tag.ts | Created |
| src/lib/tag-colors.ts | Created |
| src/server/trpc/routers/tag.ts | Created |
| src/server/trpc/routers/_app.ts | Modified |
| src/server/trpc/routers/candidate.ts | Modified |
| src/components/candidates/CandidateTagsSection.tsx | Created |
| src/components/candidates/CandidateDetailSidebar.tsx | Modified |
| tests/integration/tag/tag.test.ts | Created |
| tests/integration/candidate/candidate.test.ts | Modified |
| tests/unit/validations/tag.test.ts | Created |
| docs/stories/cases/2.8-test-cases.md | Created |

---

## QA Results

*(Results from QA Agent review of the completed story implementation.)*
