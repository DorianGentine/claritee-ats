# Story 3.1: Client Company List & Creation

## Status

DONE

## Story

**As a** recruiter,  
**I want** to manage my client companies,  
**so that** I can associate job offers with the right clients.

## Acceptance Criteria

1. Clients page accessible from main navigation
2. Displays list of client companies as cards or table
3. Each client shows: company name, SIREN, number of contacts, number of offers
4. "Nouveau client" button (terracotta CTA)
5. Creation form: companyName\*, siren (optional for clients)
6. SIREN format validation if provided
7. Click on client navigates to client detail page
8. Empty state: "Aucun client ajouté"
9. List scoped to user's company (RLS)
10. Loading state while fetching

**Réf.** Wireframes §6 Liste Clients (carte raison sociale, SIREN, compteurs contacts/offres, « Nouveau client ») ; router `client`.

## Tasks / Subtasks

- [x] Task 1 (AC: 9): API – Router client
  - [x] Créer `src/server/trpc/routers/client.ts` et l'enregistrer dans `_app.ts`. [Source: docs/architecture/coding-standards.md §3.1, docs/architecture.md §9]
  - [x] `list` : protectedProcedure, where companyId = ctx.companyId, orderBy createdAt desc. Retourner id, name, siren, \_count: { contacts: true, jobOffers: true }. [Source: prisma/schema.prisma ClientCompany]
  - [x] `getById` : protectedProcedure, input { id }, vérifier companyId. Include contacts count, jobOffers count. [Source: docs/architecture.md §4]
  - [x] `create` : protectedProcedure, input validé par createClientCompanySchema. [Source: Task 2]
- [x] Task 2 (AC: 5, 6): Validations
  - [x] Créer `src/lib/validations/client.ts` : createClientCompanySchema avec name (string min 1), siren (optional, 9 chiffres). Réutiliser sirenSchema ou pattern depuis auth. [Source: docs/prd.md Standard Error Messages, src/lib/validations/auth.ts]
- [x] Task 3 (AC: 1, 2, 3, 7, 8, 10): Page liste clients
  - [x] Créer `src/app/(dashboard)/clients/page.tsx`. [Source: docs/architecture/source-tree.md]
  - [x] Afficher la liste via client.list ; cartes ou table : nom, SIREN, "X contacts · Y offres", clic → `/clients/[id]`. [Source: wireframes §6]
  - [x] Empty state "Aucun client ajouté". [Source: AC 8]
  - [x] Loading skeleton pendant le fetch. [Source: AC 10]
- [x] Task 4 (AC: 4, 5, 6): Création client
  - [x] Bouton "Nouveau client" (terracotta). [Source: AC 4]
  - [x] Modal ou page dédiée avec formulaire : companyName\* (raison sociale), siren (optionnel). [Source: AC 5]
  - [x] Validation SIREN si renseigné (9 chiffres). [Source: AC 6]
  - [x] Mutation client.create ; invalider client.list ; rediriger vers fiche client ou fermer modal et rafraîchir la liste. [Source: docs/frontend-architecture.md §5]
- [x] Task 5 (AC: 7): Page détail client (minimale)
  - [x] Créer `src/app/(dashboard)/clients/[id]/page.tsx`. Afficher nom, SIREN ; sections Contacts et Offres en placeholder ou vides (Story 3.2 pour les contacts). [Source: wireframes §7]
  - [x] Vérifier que le client appartient au cabinet (getById 404 sinon). [Source: docs/architecture.md §4]
- [x] Task 6: Navigation
  - [x] Activer le lien "Clients" dans la navbar : href="/clients", retirer "Clients (Bientôt)" et disabled. [Source: src/components/layout/SiteNavbar.tsx]
- [x] Task 7 – Testing (AC: 1–10)
  - [x] Tests d'intégration : client.list (scopé companyId), client.create (validation SIREN), client.getById (NOT_FOUND autre cabinet). [Source: docs/architecture.md §14]
  - [x] Test manuel : liste, création, empty state, navigation vers détail.
- [x] Task 8 (QA): Rédiger les cas de test dans un fichier dédié (ex. docs/stories/cases/3.1-test-cases.md) pour faciliter la review de la story.
- [x] Task 9 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Phase 3 terminée (4.1, 4.2, 3.9, 3.11, 3.12). Pas de router `client` dans \_app.ts actuellement ; lien "Clients" en navbar est désactivé ("Clients (Bientôt)"). [Source: src/server/trpc/routers/_app.ts, SiteNavbar.tsx]
- Modèle Prisma ClientCompany : id, name, siren (optional), companyId. Relations : contacts (ClientContact[]), jobOffers (JobOffer[]). [Source: prisma/schema.prisma]

### Data Models

- **ClientCompany** : id, name, siren (String?), companyId, createdAt, updatedAt. [Source: prisma/schema.prisma]
- **ClientContact** : lié à ClientCompany (Story 3.2).
- **JobOffer** : clientCompanyId optionnel (Story 3.3+).

### API Specifications

- **client.list** : protectedProcedure, retourne ClientCompany[] avec \_count { contacts, jobOffers }. [Source: docs/architecture.md §9]
- **client.getById** : protectedProcedure, input { id: uuid }. [Source: idem]
- **client.create** : protectedProcedure, input { name: string, siren?: string }. SIREN optionnel ; si fourni, validation 9 chiffres. [Source: PRD AC 5, 6]

### Component Specifications

- Liste : cartes avec raison sociale, SIREN formaté (123 456 789), "X contacts · Y offres", lien vers détail. [Source: wireframes §6]
- Bouton "Nouveau client" : variant default (terracotta). [Source: docs/design-system.md §2]

### File Locations

| Purpose        | Path                                      |
| -------------- | ----------------------------------------- |
| Router client  | src/server/trpc/routers/client.ts         |
| Validations    | src/lib/validations/client.ts             |
| Page liste     | src/app/(dashboard)/clients/page.tsx      |
| Page détail    | src/app/(dashboard)/clients/[id]/page.tsx |
| Enregistrement | src/server/trpc/routers/\_app.ts          |
| Navbar         | src/components/layout/SiteNavbar.tsx      |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- SIREN : exactement 9 chiffres (réutiliser sirenSchema de auth ou exporter un optionalSirenSchema). Message PRD : "Le SIREN doit contenir exactement 9 chiffres." [Source: docs/prd.md, src/lib/validations/auth.ts]
- RLS : ClientCompany a companyId ; filtrer toutes les requêtes par ctx.companyId. [Source: docs/architecture.md §4]

### Testing

- Intégration : list, create, getById ; isolation multi-tenant. [Source: docs/architecture.md §14]

### Project Structure Notes

- Story 3.2 (Client Contacts) construira sur la fiche client (section Contacts). La page détail 3.1 peut afficher des placeholders pour Contacts et Offres.

---

## Change Log

| Date       | Version | Description                                                                                                                                                             | Author    |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| 2026-02-21 | 0.1     | Story draft created (3.1 Client Company List & Creation)                                                                                                                | Bob (SM)  |
| 2026-02-23 | 0.2     | Implémentation complète : router client, validations, pages liste/création/détail, navbar, tests d’intégration, cas de test QA, invalidation client.list après création | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Cursor (Auto)

### Debug Log References

N/A

### Completion Notes List

- Router client (exposé sous `clientCompany` dans l’app pour éviter le conflit tRPC avec le built-in « client ») : list, getById, create. Enregistrement dans `_app.ts`.
- Validations : `createClientCompanySchema` avec name min 1, siren optionnel (chaîne vide ou 9 chiffres). Réutilisation de `sirenSchema` (auth).
- Page liste `/clients` : cartes nom, SIREN formaté, compteurs contacts/offres ; empty state « Aucun client ajouté » ; loading skeleton ; bouton « Nouveau client » (variant default).
- Page création `/clients/new` : formulaire raison sociale + SIREN optionnel ; après succès : invalidation de `clientCompany.list` puis redirection vers fiche client.
- Page détail `/clients/[id]` : nom, SIREN, compteurs ; placeholders Contacts / Offres ; gestion id manquant ou invalide.
- Navbar : lien « Clients » activé (href="/clients").
- `formatSiren` extrait dans `src/lib/format.ts` (partagé liste + détail).
- Tests d’intégration : list (scopé, tri), create (SIREN optionnel, vide, invalide), getById (NOT_FOUND).
- Cas de test QA : `docs/stories/cases/3.1-test-cases.md`.

### File List

| Fichier                                   | Action                                |
| ----------------------------------------- | ------------------------------------- |
| src/server/trpc/routers/client.ts         | Créé                                  |
| src/server/trpc/routers/\_app.ts          | Modifié (enregistrement clientRouter) |
| src/lib/validations/client.ts             | Créé                                  |
| src/lib/format.ts                         | Modifié (ajout formatSiren)           |
| src/app/(dashboard)/clients/page.tsx      | Créé                                  |
| src/app/(dashboard)/clients/new/page.tsx  | Créé                                  |
| src/app/(dashboard)/clients/[id]/page.tsx | Créé                                  |
| src/components/layout/SiteNavbar.tsx      | Modifié (lien Clients activé)         |
| tests/integration/client/client.test.ts   | Créé                                  |
| docs/stories/cases/3.1-test-cases.md      | Créé                                  |

---

## QA Results

_(To be filled by QA Agent)_
