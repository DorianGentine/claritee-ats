# Story 3.9: Notes on Candidates

## Status

Ready for Review

## Story

**As a** recruiter,  
**I want** to add notes on candidate profiles,  
**so that** I can document interactions and observations.

## Acceptance Criteria

1. Notes section on candidate detail page
2. "Ajouter une note" button or inline input
3. Note content: éditeur riche BlockNote (blocs texte, listes, titres — inspiration Notion)
4. Note metadata: author (user), createdAt timestamp
5. Notes displayed in reverse chronological order (newest first)
6. Author name displayed on each note
7. Edit own notes only (not others')
8. Delete own notes with confirmation
9. Notes visible to all company users (shared)
10. Empty state: "Aucune note"

**Réf.** Wireframes §3 Fiche Candidat (section Notes, ordre chrono inversé, auteur + date).

## Tasks / Subtasks

- [x] Task 1 (AC: 3, 4, 9): API – Router note
  - [x] Créer `src/server/trpc/routers/note.ts` avec procedures list, create, update, delete. [Source: docs/architecture/coding-standards.md §3.1, docs/architecture.md §9]
  - [x] `note.list` : input `{ candidateId: string }`, retourne les notes du candidat scopées par companyId, ordre `createdAt desc`. Include `author: { firstName, lastName }` pour affichage. [Source: prisma/schema.prisma, Note model]
  - [x] `note.create` : input `{ candidateId, content }` ; `content` est une chaîne JSON (document BlockNote sérialisé). Créer Note avec authorId (ctx.user.id), candidateId, companyId (ctx.companyId). Validation : content non vide, JSON valide (Zod). [Source: docs/architecture.md §4]
  - [x] `note.update` : input `{ id, content }` ; vérifier que l'auteur de la note est l'utilisateur connecté (`authorId === ctx.user.id`) ; sinon NOT_FOUND ou FORBIDDEN. [Source: PRD AC 7]
  - [x] `note.delete` : input `{ id }` ; vérifier auteur ; sinon NOT_FOUND ou FORBIDDEN. [Source: PRD AC 8]
  - [x] Créer `src/lib/validations/note.ts` (createNoteSchema, updateNoteSchema). [Source: docs/architecture/source-tree.md]
  - [x] Enregistrer le router dans `_app.ts`. [Source: src/server/trpc/routers/_app.ts]
- [x] Task 2 (AC: 1, 2, 5, 6): Composant CandidateNotesSection
  - [x] Créer `src/components/candidates/CandidateNotesSection.tsx`. Props : `candidateId`. [Source: docs/frontend-architecture.md §4.2]
  - [x] Section avec titre "Notes", bouton "Ajouter une note" (ou zone inline). [Source: wireframes §3]
  - [x] Liste des notes via `note.list.useQuery({ candidateId })` ; affichage ordre chrono inversé (déjà garanti par l'API). [Source: PRD AC 5]
  - [x] Chaque note : auteur (prénom + initiale du nom, ex. "Jean D."), date formatée (toLocaleDateString fr-FR), contenu rendu via BlockNote (mode lecture). [Source: PRD AC 6]
- [x] Task 3 (AC: 2, 3): Formulaire d'ajout avec BlockNote
  - [x] Installer BlockNote : `@blocknote/core`, `@blocknote/react`, `@blocknote/shadcn`. [Source: https://www.blocknotejs.org/docs]
  - [x] Modal avec éditeur BlockNote (blocs texte, listes, titres). Récupérer le contenu via `editor.document` → `JSON.stringify(editor.document)`. [Source: https://www.blocknotejs.org/docs]
  - [x] Mutation `note.create` avec content = JSON string du document BlockNote ; invalider `note.list` après succès. [Source: docs/frontend-architecture.md §5]
- [x] Task 4 (AC: 7, 8): Édition et suppression
  - [x] Sur chaque note : si auteur = utilisateur connecté, afficher boutons Modifier et Supprimer. [Source: PRD AC 7]
  - [x] Modifier : modal avec éditeur BlockNote pré-rempli ; mutation `note.update` ; invalidation. [Source: PRD AC 7]
  - [x] Supprimer : ConfirmDialog "Supprimer cette note ?" ; mutation `note.delete` ; invalidation. [Source: PRD AC 8]
- [x] Task 5 (AC: 1, 10): Intégration et empty state
  - [x] Intégrer `CandidateNotesSection` dans `CandidateDetailView`, sous la grille header/sidebar/content (section pleine largeur). [Source: wireframes §3]
  - [x] Empty state : "Aucune note" quand liste vide. [Source: PRD AC 10]
- [x] Task 6 – Testing (AC: 1–10)
  - [x] Tests d'intégration : note.list (scopé companyId), note.create, note.update (seulement auteur), note.delete (seulement auteur) ; refus si autre cabinet. [Source: docs/architecture.md §14]
  - [ ] Test manuel : ajout, édition, suppression, empty state.
- [x] Task 7 (QA): Rédiger les cas de test dans un fichier dédié (ex. docs/stories/cases/3.9-test-cases.md) pour faciliter la review de la story.
- [x] Task 8 (review): Lancer une review de code en fin de développement avant clôture de la story.

## Dev Notes

### Previous Story Insights

- Story 4.2 DONE : filtres liste candidats. Le détail candidat est dans `CandidateDetailView` avec Header, Sidebar, Content. Pas de section Notes actuellement. [Source: src/components/candidates/CandidateDetailView.tsx]
- Le modèle `Note` existe dans Prisma : id, content, authorId, candidateId (nullable), offerId (nullable), companyId, createdAt, updatedAt. Relation author (User), candidate (Candidate). [Source: prisma/schema.prisma]
- Pas de router `note` dans `_app.ts` actuellement. [Source: src/server/trpc/routers/_app.ts]

### Data Models

- **Note** : id, content (Text — stocke le JSON du document BlockNote), authorId, candidateId (nullable), offerId (nullable), companyId, createdAt, updatedAt. [Source: prisma/schema.prisma]
- **User** : firstName, lastName (pour affichage auteur). [Source: prisma/schema.prisma]

### API Specifications

- **note.list** (protectedProcedure) : input `{ candidateId: string }`. Filtre `where: { candidateId, companyId: ctx.companyId }`, `orderBy: { createdAt: 'desc' }`, `include: { author: { select: { firstName: true, lastName: true } } }`. [Source: docs/architecture.md §9]
- **note.create** (protectedProcedure) : input `{ candidateId: string, content: string }` (content = JSON BlockNote). Vérifier que le candidat appartient au cabinet. Créer avec authorId = ctx.user.id, companyId = ctx.companyId. [Source: docs/architecture.md §4]
- **note.update** (protectedProcedure) : input `{ id: string, content: string }`. findFirst avec id + companyId ; vérifier authorId === ctx.user.id ; sinon throw FORBIDDEN. [Source: PRD AC 7]
- **note.delete** (protectedProcedure) : input `{ id: string }`. Même vérification auteur. [Source: PRD AC 8]

### Component Specifications

- Section Notes : pleine largeur sous la grille 2 colonnes, titre "Notes". [Source: wireframes §3]
- Liste : items avec auteur (format "Prénom I." ou "Prénom N."), date (format court, ex. 12/02), contenu rendu depuis BlockNote (mode lecture : `BlockNoteView` ou rendu HTML/React depuis le JSON). [Source: wireframes §3]
- Éditeur BlockNote : blocs texte, listes, titres ; thème Mantine ou adaptation au Design System (terracotta/sauge). [Source: https://www.blocknotejs.org/docs]
- Boutons Modifier/Supprimer : outline ou ghost, visibles uniquement pour l'auteur. [Source: docs/design-system.md]

### File Locations

| Purpose                          | Path                                                |
| -------------------------------- | --------------------------------------------------- |
| Router note                      | src/server/trpc/routers/note.ts                     |
| Validations                      | src/lib/validations/note.ts                         |
| Composant Notes                  | src/components/candidates/CandidateNotesSection.tsx |
| Composant éditeur (réutilisable) | src/components/shared/NoteBlockNoteEditor.tsx       |
| Intégration                      | src/components/candidates/CandidateDetailView.tsx   |
| Enregistrement                   | src/server/trpc/routers/\_app.ts                    |

[Source: docs/architecture/source-tree.md]

### Technical Constraints

- Vérifier que le candidat existe et appartient au cabinet avant create (via candidate.getById ou jointure). [Source: docs/architecture.md §4]
- Pas de rate limiting spécifique pour les notes (lecture/écriture métier standard). [Source: docs/architecture/rate-limiting.md]
- BlockNote : document = `editor.document` (array of blocks). Sérialiser via `JSON.stringify(editor.document)` pour stockage ; `JSON.parse(content)` pour initialiser l'éditeur en mode édition ou affichage. [Source: https://www.blocknotejs.org/docs]

### Testing

- Intégration : note CRUD, isolation companyId, édition/suppression réservée à l'auteur. [Source: docs/architecture.md §14]

### Implementation Modifications (post-draft)

Modifications apportées lors de l'implémentation par rapport aux specs initiales :

| Aspect                | Spéc initiale                 | Implémentation                                                                         |
| --------------------- | ----------------------------- | -------------------------------------------------------------------------------------- |
| **UI formulaire**     | Modal « Ajouter une note »    | Formulaire toujours visible en bas de section                                          |
| **Affichage notes**   | Liste simple                  | Bulles type chat (90 % largeur, mes notes à droite, autres à gauche)                   |
| **Édition**           | Modal avec éditeur pré-rempli | Édition inline (boutons Enregistrer/Annuler sur la note)                               |
| **Ordre**             | Chrono inversé (AC 5)         | `createdAt asc` (style fil de discussion)                                              |
| **Validation vide**   | —                             | Bouton Enregistrer désactivé si vide ; `isBlockNoteContentEmpty()` + `onContentChange` |
| **Sécurité API**      | —                             | Content max 500 Ko (Zod), `note.list` limité à 100 résultats                           |
| **Format date**       | `toLocaleDateString`          | `formatDateLong()` dans `src/lib/format.ts`                                            |
| **Performance React** | —                             | `onContentChange` stabilisé avec `useCallback`                                         |

### Project Structure Notes

- Le router note est un nouveau domaine. Story 3.10 (Notes on Job Offers) et 3.11 (Note rapide FAB) réutiliseront le même router et le composant éditeur BlockNote.

---

## Change Log

| Date       | Version | Description                                                                                                                                         | Author      |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-21 | 0.1     | Story draft created (3.9 Notes on Candidates)                                                                                                       | Bob (SM)    |
| 2026-02-21 | 0.2     | Éditeur BlockNote pour contenu riche (blocs texte, listes, titres)                                                                                  | Bob (SM)    |
| 2026-02-22 | 0.3     | Implémentation complète : API note, CandidateNotesSection, BlockNote (shadcn), tests                                                                | James (Dev) |
| 2026-02-22 | 0.4     | UI refonte : bulles chat, formulaire fixe en bas, édition inline sans modals ; ordre asc ; validation vide ; limites API ; perf React (useCallback) | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

N/A

### Completion Notes List

- API note router : list, create, update, delete avec scope companyId et vérification auteur
- BlockNote : @blocknote/shadcn utilisé (compatibilité design system terracotta/sauge) au lieu de mantine
- Format date : `formatDateLong()` dans `src/lib/format.ts`
- Tests intégration : 11 tests dans tests/integration/note/note.test.ts (s’exécutent avec DATABASE_URL)

- UI : formulaire fixe en bas, notes en bulles chat (mes notes à droite), édition inline sans modals
- note.list : ordre `createdAt asc` (style chat), limite 100 résultats, content max 500 Ko
- Performance : callback `onContentChange` stabilisé avec `useCallback`

### File List

| Fichier                                             | Action  |
| --------------------------------------------------- | ------- |
| src/server/trpc/routers/note.ts                     | Créé    |
| src/lib/validations/note.ts                         | Créé    |
| src/server/trpc/routers/\_app.ts                    | Modifié |
| src/components/shared/NoteBlockNoteEditor.tsx       | Créé    |
| src/components/candidates/CandidateNotesSection.tsx | Créé    |
| src/components/candidates/CandidateDetailView.tsx   | Modifié |
| src/styles/globals.css                              | Modifié |
| package.json                                        | Modifié |
| tests/integration/note/note.test.ts                 | Créé    |
| docs/stories/cases/3.9-test-cases.md                | Créé    |

---

## QA Results

_(Results from QA Agent review of the completed story implementation.)_
